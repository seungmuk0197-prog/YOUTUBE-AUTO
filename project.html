<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">í”„ë¡œì íŠ¸ - YouTube Auto Studio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* LEFT SIDEBAR */
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            box-shadow: 2px 0 8px rgba(0,0,0,0.05);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .sidebar-header h2 {
            font-size: 16px;
            margin-bottom: 4px;
            word-break: break-word;
        }

        .sidebar-header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .project-info {
            padding: 15px 20px;
            background: #f9f9f9;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
        }

        .project-info-row {
            margin-bottom: 8px;
            color: #666;
        }

        .project-info-label {
            font-weight: 600;
            color: #333;
        }

        .steps-nav {
            flex: 1;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-left: 12px;
            padding-right: 12px;
        }

        .step-btn {
            padding: 12px 16px;
            border: none;
            background: none;
            cursor: pointer;
            text-align: left;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            z-index: 20;
            pointer-events: auto;
        }

        .step-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .step-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .step-btn.completed::before {
            content: "âœ“";
            position: absolute;
            right: 12px;
            font-weight: bold;
            color: #4CAF50;
        }

        .step-btn.active.completed::before {
            color: white;
        }

        .step-icon {
            width: 24px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 15px 12px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sidebar-btn {
            padding: 10px 14px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .sidebar-btn:hover {
            border-color: #667eea;
            background: #f9f9ff;
            color: #667eea;
        }

        /* MAIN PANEL */
        .main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
            overflow: hidden;
        }

        .main-header {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .main-header h1 {
            font-size: 24px;
            color: #333;
        }

        .main-header-subtitle {
            font-size: 14px;
            color: #999;
            margin-top: 4px;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            display: flex;
            justify-content: center;
        }

        .content-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        /* STEP CONTENT - Hidden by default */
        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        /* FORM ELEMENTS */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        input[type="text"],
        input[type="file"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        input[type="range"] {
            width: 100%;
        }

        input[type="file"] {
            display: none;
        }

        .info-text {
            color: #999;
            font-size: 12px;
            margin-top: 6px;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-small {
            padding: 8px 14px;
            font-size: 12px;
            width: auto;
        }

        /* RESULT SECTION */
        .result-section {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .result-section h3 {
            margin-bottom: 15px;
            font-size: 14px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-content {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .result-info {
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        audio {
            width: 100%;
            margin-top: 12px;
            margin-bottom: 12px;
        }

        .result-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .result-actions > * {
            margin-bottom: 8px;
        }

        /* MESSAGE */
        .message {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }

        .message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }

        .message.warning {
            background: #fff3e0;
            color: #e65100;
            border: 1px solid #ff9800;
        }

        /* LOADING MODAL */
        .loading-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-modal.open {
            display: flex;
        }

        .loading-modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            min-width: 300px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid #f0f0f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 15px 0;
        }

        .loading-modal-message {
            font-size: 14px;
            color: #666;
        }

        /* TEXT VIEWER MODAL */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal-box {
            background: white;
            width: 90%;
            max-width: 1000px;
            max-height: 80vh;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 16px 20px;
            background: #f6f8fb;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-weight: 700;
            font-size: 16px;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
        }

        .modal-content {
            padding: 16px;
            overflow: auto;
            background: #111;
            color: #eee;
            flex: 1;
        }

        .modal-content pre {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        /* SPEED CONTROL */
        .speed-control-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .speed-control-wrapper label {
            margin-bottom: 0;
            white-space: nowrap;
        }

        .speed-control-wrapper select {
            margin-bottom: 0;
            flex: 1;
        }

        .speed-value {
            color: #667eea;
            font-weight: bold;
            min-width: 40px;
            text-align: right;
            font-size: 13px;
        }

        /* FILE INPUT WRAPPER */
        .file-input-wrapper {
            position: relative;
        }

        .file-input-label {
            display: block;
            padding: 12px;
            background: #f0f0f0;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            border-color: #667eea;
            background: #f9f9ff;
        }

        /* PROVIDER SELECTOR */
        .provider-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .provider-option {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .provider-option:hover {
            border-color: #667eea;
            background: #f9f9ff;
        }

        .provider-option.selected {
            border-color: #667eea;
            background: #f9f9ff;
            color: #667eea;
            font-weight: 600;
        }

        /* MISSING PREREQUISITE */
        .prerequisite-warning {
            padding: 16px;
            background: #fff3e0;
            border: 1px solid #ff9800;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .prerequisite-warning h4 {
            color: #e65100;
            margin-bottom: 10px;
        }

        .prerequisite-warning p {
            color: #e65100;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .prerequisite-warning .btn {
            width: auto;
        }

        /* VOLUME DISPLAY */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .volume-control input[type="range"] {
            margin: 0;
            flex: 1;
        }

        .volume-display {
            color: #667eea;
            font-weight: bold;
            min-width: 40px;
            text-align: right;
            font-size: 13px;
        }

        /* RESPONSIVE */
        @media (max-width: 1024px) {
            .sidebar {
                width: 250px;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 150px;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
                overflow-x: auto;
                overflow-y: hidden;
            }

            .steps-nav {
                flex-direction: row;
                padding: 10px;
                height: 60px;
                gap: 0;
            }

            .step-btn {
                padding: 8px 12px;
                font-size: 12px;
                white-space: nowrap;
            }

            .main-panel {
                height: calc(100vh - 150px);
            }

            .main-header {
                padding: 15px 20px;
            }

            .main-header h1 {
                font-size: 18px;
            }

            .main-content {
                padding: 15px;
            }

            .content-card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- LEFT SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2 id="project-name-header">í”„ë¡œì íŠ¸</h2>
                <p id="project-id-header" style="font-size: 11px; font-family: monospace;"></p>
            </div>

            <div class="project-info">
                <div class="project-info-row">
                    <span class="project-info-label">ìƒì„±:</span>
                    <span id="created-info">-</span>
                </div>
                <div class="project-info-row">
                    <span class="project-info-label">ìˆ˜ì •:</span>
                    <span id="updated-info">-</span>
                </div>
            </div>

            <nav class="steps-nav">
                <button class="step-btn active" data-step="script">
                    <span class="step-icon">ğŸ“</span>
                    <span>ëŒ€ë³¸</span>
                </button>
                <button class="step-btn" data-step="tts">
                    <span class="step-icon">ğŸ”Š</span>
                    <span>TTS</span>
                </button>
                <button class="step-btn" data-step="subtitles">
                    <span class="step-icon">ğŸ“</span>
                    <span>ìë§‰</span>
                </button>
                <button class="step-btn" data-step="thumbnail">
                    <span class="step-icon">ğŸ“¸</span>
                    <span>ì¸ë„¤ì¼</span>
                </button>
                <button class="step-btn" data-step="bgm">
                    <span class="step-icon">ğŸµ</span>
                    <span>BGM</span>
                </button>
                <button class="step-btn" data-step="render">
                    <span class="step-icon">ğŸ¬</span>
                    <span>ë Œë”ë§</span>
                </button>
            </nav>

            <div class="sidebar-footer">
                <button class="sidebar-btn" onclick="saveProject()">ğŸ’¾ í”„ë¡œì íŠ¸ ì €ì¥</button>
                <button class="sidebar-btn" onclick="backToList()">â¬… í”„ë¡œì íŠ¸ ëª©ë¡</button>
            </div>
        </aside>

        <!-- MAIN PANEL -->
        <main class="main-panel">
            <header class="main-header">
                <div>
                    <h1 id="step-title">ëŒ€ë³¸</h1>
                    <p class="main-header-subtitle" id="step-subtitle"></p>
                </div>
            </header>

            <div class="main-content">
                <div class="content-card">
                    <div id="message-area" style="margin-bottom: 20px;"></div>

                    <!-- SCRIPT STEP -->
                    <div class="step-content active" data-step="script">
                        <div class="form-group">
                            <label for="script-text">ì˜ìƒ ëŒ€ë³¸</label>
                            <textarea id="script-text" placeholder="ì˜ìƒì˜ ë‚˜ë ˆì´ì…˜ ëŒ€ë³¸ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                            <p class="info-text">ğŸ’¡ í•œêµ­ì–´ ë˜ëŠ” ì˜ì–´ë¡œ ì…ë ¥í•˜ì„¸ìš”. ìë™ìœ¼ë¡œ TTS ìŒì„±ìœ¼ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.</p>
                        </div>
                        <button class="btn btn-primary" onclick="saveScript()">ëŒ€ë³¸ ì €ì¥</button>

                        <div class="result-section" id="script-result" style="display: none;">
                            <h3>ğŸ“‹ ê²°ê³¼</h3>
                            <div class="result-content" id="script-result-content"></div>
                        </div>
                    </div>

                    <!-- TTS STEP -->
                    <div class="step-content" data-step="tts">
                        <div class="form-group">
                            <label for="voice-select">ìŒì„± ì„ íƒ</label>
                            <select id="voice-select">
                                <option value="ko-KR-SunHiNeural">í•œêµ­ì–´ - ì—¬ì„± (Sun Hi)</option>
                                <option value="ko-KR-InJoonNeural">í•œêµ­ì–´ - ë‚¨ì„± (In Joon)</option>
                                <option value="en-US-AriaNeural">English - Female (Aria)</option>
                                <option value="en-US-GuyNeural">English - Male (Guy)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="tts-speed">ì¬ìƒ ì†ë„ (ë°°ì†)</label>
                            <select id="tts-speed">
                                <option value="0.8">0.8ë°° (ëŠë¦¼)</option>
                                <option value="0.9">0.9ë°°</option>
                                <option value="1.0" selected>1.0ë°° (ê¸°ë³¸)</option>
                                <option value="1.1">1.1ë°°</option>
                                <option value="1.2">1.2ë°° (ë¹ ë¦„)</option>
                            </select>
                            <p class="info-text">ì„ íƒí•œ ì†ë„ë¡œ TTSë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
                        </div>

                        <button class="btn btn-primary" onclick="generateTTS()">TTS ìƒì„±</button>

                        <div class="result-section" id="tts-result" style="display: none;">
                            <h3>ğŸ”Š ê²°ê³¼</h3>
                            <div class="result-content" id="tts-result-content"></div>
                        </div>
                    </div>

                    <!-- SUBTITLES STEP -->
                    <div class="step-content" data-step="subtitles">
                        <p class="info-text">ğŸ’¡ TTS ì˜¤ë””ì˜¤ë¡œë¶€í„° ìë™ìœ¼ë¡œ ìë§‰ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>
                        <button class="btn btn-primary" onclick="generateSubtitles()" style="margin-top: 15px;">ìë§‰ ìƒì„±</button>

                        <div class="result-section" id="subtitles-result" style="display: none;">
                            <h3>ğŸ“ ê²°ê³¼</h3>
                            <div class="result-content" id="subtitles-result-content"></div>
                        </div>
                    </div>

                    <!-- THUMBNAIL STEP -->
                    <div class="step-content" data-step="thumbnail">
                        <div class="form-group">
                            <label for="thumbnail-title">ì¸ë„¤ì¼ ì œëª©</label>
                            <input type="text" id="thumbnail-title" placeholder="ì˜ˆ: ìƒˆë¡œìš´ ê¸°ìˆ  ì„¤ëª…">
                        </div>

                        <div class="form-group">
                            <label for="thumbnail-color">ë°°ê²½ìƒ‰</label>
                            <input type="text" id="thumbnail-color" placeholder="#667eea" value="#667eea">
                            <p class="info-text">ìƒ‰ìƒ ì½”ë“œ í˜•ì‹: #RRGGBB</p>
                        </div>

                        <button class="btn btn-primary" onclick="generateThumbnail()">ì¸ë„¤ì¼ ìƒì„±</button>

                        <div class="result-section" id="thumbnail-result" style="display: none;">
                            <h3>ğŸ“¸ ê²°ê³¼</h3>
                            <div class="result-content" id="thumbnail-result-content"></div>
                        </div>
                    </div>

                    <!-- BGM STEP -->
                    <div class="step-content" data-step="bgm">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="bgm-enabled" onchange="toggleBGM()"> BGM ì‚¬ìš© ì—¬ë¶€
                            </label>
                        </div>

                        <div class="form-group">
                            <label>BGM ë³¼ë¥¨</label>
                            <div class="volume-control">
                                <input type="range" id="bgm-volume" min="0" max="100" value="50" onchange="updateBGMVolume()">
                                <span class="volume-display" id="volume-display">50%</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="bgm-file">BGM íŒŒì¼ ì„ íƒ</label>
                            <div class="file-input-wrapper">
                                <label class="file-input-label">
                                    ğŸ“¤ ìŒì•… íŒŒì¼ ì—…ë¡œë“œ (MP3/WAV)
                                    <input type="file" id="bgm-file" accept="audio/*">
                                </label>
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="uploadBGM()">BGM ì—…ë¡œë“œ</button>

                        <div class="result-section" id="bgm-result" style="display: none;">
                            <h3>ğŸµ ê²°ê³¼</h3>
                            <div class="result-content" id="bgm-result-content"></div>
                        </div>
                    </div>

                    <!-- RENDER STEP -->
                    <div class="step-content" data-step="render">
                        <button class="btn btn-primary" onclick="startRender()">ìµœì¢… ì˜ìƒ ë Œë”ë§</button>
                        <p class="info-text" style="margin-top: 15px;">â±ï¸ ë Œë”ë§ì— ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°í•´ì£¼ì„¸ìš”.</p>

                        <div class="result-section" id="render-result" style="display: none;">
                            <h3>ğŸ¬ ê²°ê³¼</h3>
                            <div class="result-content" id="render-result-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- LOADING MODAL -->
    <div id="loading-modal" class="loading-modal">
        <div class="loading-modal-content">
            <div class="loading-spinner"></div>
            <div class="loading-modal-title" id="loading-title">ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</div>
            <div class="loading-modal-message" id="loading-message">ì™„ë£Œë  ë•Œê¹Œì§€ ì ì‹œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>
        </div>
    </div>

    <!-- TEXT VIEWER MODAL -->
    <div id="text-viewer-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <div class="modal-title" id="text-viewer-title">íŒŒì¼ ë‚´ìš©</div>
                <div class="modal-actions">
                    <button class="btn btn-small btn-secondary" onclick="copyViewerContent()">ğŸ“‹ ë³µì‚¬</button>
                    <button class="btn btn-small btn-secondary" onclick="closeTextViewer()">âœ• ë‹«ê¸°</button>
                </div>
            </div>
            <div class="modal-content">
                <pre id="text-viewer-content"></pre>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let projectId = null;
        let projectData = null;
        let isLoading = false;

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        window.addEventListener('load', async () => {
            const params = new URLSearchParams(window.location.search);
            projectId = params.get('id');

            if (!projectId) {
                window.location.href = '/index.html';
                return;
            }

            await loadProject();
            initializeRouting();
            setupSidebarNavigation();
        });

        // ============================================================================
        // HASH-BASED ROUTING
        // ============================================================================
        function initializeRouting() {
            const hash = window.location.hash.slice(1) || 'script';
            navigateToStep(hash);

            window.addEventListener('hashchange', () => {
                const newHash = window.location.hash.slice(1);
                navigateToStep(newHash);
            });
        }

        function navigateToStep(stepKey) {
            // Update step buttons
            document.querySelectorAll('.step-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.step === stepKey);
            });

            // Update step content
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.toggle('active', content.dataset.step === stepKey);
            });

            // Update header
            const stepLabels = {
                script: { title: 'ëŒ€ë³¸', subtitle: 'ì˜ìƒì˜ ë‚˜ë ˆì´ì…˜ ëŒ€ë³¸ì„ ì‘ì„±í•˜ê³  ì €ì¥í•˜ì„¸ìš”.' },
                tts: { title: 'TTS', subtitle: 'AI ìŒì„±ìœ¼ë¡œ ëŒ€ë³¸ì„ ì½ê²Œ í•©ë‹ˆë‹¤.' },
                subtitles: { title: 'ìë§‰', subtitle: 'TTS ì˜¤ë””ì˜¤ë¡œë¶€í„° ìë™ ìë§‰ì„ ìƒì„±í•©ë‹ˆë‹¤.' },
                thumbnail: { title: 'ì¸ë„¤ì¼', subtitle: 'AIê°€ ìƒì„±í•œ ì¸ë„¤ì¼ ì´ë¯¸ì§€ì…ë‹ˆë‹¤.' },
                bgm: { title: 'BGM', subtitle: 'ë°°ê²½ ìŒì•…ì„ ì¶”ê°€í•©ë‹ˆë‹¤.' },
                render: { title: 'ë Œë”ë§', subtitle: 'ìµœì¢… ì˜ìƒì„ ìƒì„±í•©ë‹ˆë‹¤.' }
            };

            const step = stepLabels[stepKey] || stepLabels.script;
            document.getElementById('step-title').textContent = step.title;
            document.getElementById('step-subtitle').textContent = step.subtitle;
        }

        function goToStep(stepKey) {
            window.location.hash = stepKey;
        }

        // ============================================================================
        // SIDEBAR SETUP
        // ============================================================================
        function setupSidebarNavigation() {
            document.querySelectorAll('.step-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    goToStep(btn.dataset.step);
                });
            });
        }

        function backToList() {
            window.location.href = '/index.html';
        }

        // ============================================================================
        // LOADING MODAL
        // ============================================================================
        function showLoadingModal(title = 'ìƒì„± ì¤‘ì…ë‹ˆë‹¤...', message = 'ì™„ë£Œë  ë•Œê¹Œì§€ ì ì‹œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.') {
            document.getElementById('loading-title').textContent = title;
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading-modal').classList.add('open');
            isLoading = true;
        }

        function hideLoadingModal() {
            document.getElementById('loading-modal').classList.remove('open');
            isLoading = false;
        }

        // ============================================================================
        // MESSAGING
        // ============================================================================
        function showMessage(text, type = 'success') {
            const area = document.getElementById('message-area');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = text;
            area.appendChild(div);
            setTimeout(() => div.remove(), 4000);
        }

        // ============================================================================
        // PROJECT LOADING & DISPLAY
        // ============================================================================
        async function loadProject() {
            try {
                const response = await fetch(`${API_BASE}/projects/${projectId}`);
                const data = await response.json();

                if (!data.ok || !data.project) {
                    showMessage('í”„ë¡œì íŠ¸ ë¡œë“œ ì‹¤íŒ¨', 'error');
                    return;
                }

                projectData = data.project;
                displayProjectInfo();
                populateStepUI();
                updateStepStatus();
            } catch (error) {
                console.error('í”„ë¡œì íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                showMessage('í”„ë¡œì íŠ¸ ë¡œë“œ ì‹¤íŒ¨', 'error');
            }
        }

        function displayProjectInfo() {
            document.getElementById('project-name-header').textContent = projectData.name || projectData.topic || 'Untitled';
            document.getElementById('project-id-header').textContent = projectData.id;
            document.getElementById('page-title').textContent = `${projectData.name || 'Project'} - YouTube Auto Studio`;

            const createdDate = new Date(projectData.created_at).toLocaleDateString('ko-KR');
            const updatedDate = new Date(projectData.updated_at).toLocaleDateString('ko-KR');
            document.getElementById('created-info').textContent = createdDate;
            document.getElementById('updated-info').textContent = updatedDate;
        }

        function populateStepUI() {
            // Script
            if (projectData.scenes?.[0]) {
                document.getElementById('script-text').value = projectData.scenes[0].text || '';
            }

            // TTS
            if (projectData.settings?.tts?.voice) {
                document.getElementById('voice-select').value = projectData.settings.tts.voice;
            }

            // Thumbnail
            if (projectData.settings?.thumbnail) {
                document.getElementById('thumbnail-title').value = projectData.settings.thumbnail.title || '';
                document.getElementById('thumbnail-color').value = projectData.settings.thumbnail.bg_color || '#667eea';
            }

            // BGM
            if (projectData.settings?.bgm) {
                document.getElementById('bgm-enabled').checked = projectData.settings.bgm.enabled || false;
                document.getElementById('bgm-volume').value = (projectData.settings.bgm.volume * 100) || 50;
                updateBGMVolumeDisplay();
            }
        }

        function updateStepStatus() {
            const steps = document.querySelectorAll('.step-btn');
            steps.forEach((btn, idx) => {
                btn.classList.remove('completed');
                const stepKey = btn.dataset.step;

                let isComplete = false;
                if (stepKey === 'script' && projectData.scenes?.length > 0) isComplete = true;
                if (stepKey === 'tts' && projectData.settings?.tts?.audio_paths?.length > 0) isComplete = true;
                if (stepKey === 'subtitles' && projectData.settings?.subtitles?.enabled) isComplete = true;
                if (stepKey === 'thumbnail' && projectData.settings?.thumbnail?.path) isComplete = true;
                if (stepKey === 'bgm' && projectData.settings?.bgm?.enabled) isComplete = true;
                if (stepKey === 'render' && projectData.rendered) isComplete = true;

                if (isComplete) btn.classList.add('completed');
            });
        }

        // ============================================================================
        // STEP ACTIONS
        // ============================================================================

        // SCRIPT
        async function saveScript() {
            const text = document.getElementById('script-text').value;
            if (!text.trim()) {
                showMessage('ëŒ€ë³¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                showLoadingModal('ëŒ€ë³¸ ì €ì¥ ì¤‘...', 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
                const response = await fetch(`${API_BASE}/projects/${projectId}/scenes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });

                const data = await response.json();
                if (data.ok) {
                    showMessage('ëŒ€ë³¸ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    await loadProject();

                    // Show result
                    const resultEl = document.getElementById('script-result');
                    resultEl.style.display = 'block';
                    resultEl.querySelector('#script-result-content').innerHTML = `
                        <div class="result-info">
                            ì €ì¥ ì™„ë£Œ: ${new Date().toLocaleTimeString('ko-KR')}
                        </div>
                    `;
                } else {
                    showMessage('ëŒ€ë³¸ ì €ì¥ ì‹¤íŒ¨: ' + (data.error || 'Unknown'), 'error');
                }
            } catch (error) {
                console.error('ëŒ€ë³¸ ì €ì¥ ì‹¤íŒ¨:', error);
                showMessage('ëŒ€ë³¸ ì €ì¥ ì‹¤íŒ¨', 'error');
            } finally {
                hideLoadingModal();
            }
        }

        // TTS
        async function generateTTS() {
            const hasScript = projectData?.scenes?.length > 0 && projectData.scenes[0].text;
            if (!hasScript) {
                showMessage('ëŒ€ë³¸ì„ ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                showLoadingModal('TTS ìƒì„± ì¤‘...', 'AI ìŒì„±ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.');
                const voice = document.getElementById('voice-select').value;
                const speed = parseFloat(document.getElementById('tts-speed').value);
                const sceneId = projectData.scenes[0].id;

                const response = await fetch(`${API_BASE}/projects/${projectId}/generate/tts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ voice, sceneId, speed })
                });

                const data = await response.json();
                if (data.ok) {
                    showMessage('TTS ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    await loadProject();

                    // Show result
                    const resultEl = document.getElementById('tts-result');
                    resultEl.style.display = 'block';
                    const audioSrc = `${API_BASE}/projects/${projectId}/preview?path=${encodeURIComponent(data.audioPath)}&v=${Date.now()}`;
                    const duration = Math.round((data.durationSec || 0) * 1000) / 1000;

                    resultEl.querySelector('#tts-result-content').innerHTML = `
                        <div class="result-info">
                            ì˜¤ë””ì˜¤: ${data.audioPath} (${duration}ì´ˆ, ${speed}ë°°ì†)
                        </div>
                        <audio controls style="width: 100%; margin: 12px 0;">
                            <source src="${audioSrc}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                        <div class="result-actions">
                            <a href="${API_BASE}/projects/${projectId}/download?path=${encodeURIComponent(data.audioPath)}" class="btn btn-small btn-secondary" download>â¬‡ ë‹¤ìš´ë¡œë“œ</a>
                        </div>
                    `;
                } else {
                    showMessage('TTS ìƒì„± ì‹¤íŒ¨: ' + (data.error || 'Unknown'), 'error');
                }
            } catch (error) {
                console.error('TTS ìƒì„± ì‹¤íŒ¨:', error);
                showMessage('TTS ìƒì„± ì‹¤íŒ¨', 'error');
            } finally {
                hideLoadingModal();
            }
        }

        // SUBTITLES
        async function generateSubtitles() {
            const hasTTS = projectData?.settings?.tts?.audio_paths?.length > 0;
            if (!hasTTS) {
                showMessage('TTSë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                showLoadingModal('ìë§‰ ìƒì„± ì¤‘...', 'AIê°€ ìë§‰ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.');
                const response = await fetch(`${API_BASE}/projects/${projectId}/generate/srt`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const data = await response.json();
                if (data.ok) {
                    showMessage('ìë§‰ ìƒì„± ì™„ë£Œ');
                    await loadProject();

                    const resultEl = document.getElementById('subtitles-result');
                    resultEl.style.display = 'block';
                    resultEl.querySelector('#subtitles-result-content').innerHTML = `
                        <div class="result-info">
                            SRT íŒŒì¼: ${data.srtPath || 'unknown'}
                        </div>
                        <div class="result-actions">
                            <button class="btn btn-small btn-secondary" onclick="viewTextFile('${data.srtPath}', 'Subtitles')">ğŸ‘ ë³´ê¸°</button>
                            <a href="${API_BASE}/projects/${projectId}/download?path=${encodeURIComponent(data.srtPath)}" class="btn btn-small btn-secondary" download>â¬‡ ë‹¤ìš´ë¡œë“œ</a>
                        </div>
                    `;
                } else {
                    showMessage('ìë§‰ ìƒì„± ì‹¤íŒ¨: ' + (data.error || 'Unknown'), 'error');
                }
            } catch (error) {
                console.error('ìë§‰ ìƒì„± ì‹¤íŒ¨:', error);
                showMessage('ìë§‰ ìƒì„± ì‹¤íŒ¨', 'error');
            } finally {
                hideLoadingModal();
            }
        }

        // THUMBNAIL
        async function generateThumbnail() {
            try {
                showLoadingModal('ì¸ë„¤ì¼ ìƒì„± ì¤‘...', 'AIê°€ ì¸ë„¤ì¼ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.');
                const title = document.getElementById('thumbnail-title').value;
                const bg_color = document.getElementById('thumbnail-color').value;

                const response = await fetch(`${API_BASE}/projects/${projectId}/generate/thumbnail`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, bg_color })
                });

                const data = await response.json();
                if (data.ok) {
                    showMessage('ì¸ë„¤ì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    await loadProject();

                    const resultEl = document.getElementById('thumbnail-result');
                    resultEl.style.display = 'block';
                    resultEl.querySelector('#thumbnail-result-content').innerHTML = `
                        <p>ì¸ë„¤ì¼ ìƒì„± ì™„ë£Œ</p>
                    `;
                } else {
                    showMessage('ì¸ë„¤ì¼ ìƒì„± ì‹¤íŒ¨: ' + (data.error || 'Unknown'), 'error');
                }
            } catch (error) {
                console.error('ì¸ë„¤ì¼ ìƒì„± ì‹¤íŒ¨:', error);
                showMessage('ì¸ë„¤ì¼ ìƒì„± ì‹¤íŒ¨', 'error');
            } finally {
                hideLoadingModal();
            }
        }

        // BGM
        function toggleBGM() {
            const enabled = document.getElementById('bgm-enabled').checked;
            updateBGMSettings({ enabled });
        }

        function updateBGMVolume() {
            const volume = document.getElementById('bgm-volume').value;
            updateBGMVolumeDisplay();
            updateBGMSettings({ volume: volume / 100 });
        }

        function updateBGMVolumeDisplay() {
            const volume = document.getElementById('bgm-volume').value;
            document.getElementById('volume-display').textContent = volume + '%';
        }

        async function updateBGMSettings(settings) {
            try {
                const response = await fetch(`${API_BASE}/projects/${projectId}/settings/bgm`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();
                if (!data.ok) {
                    showMessage('BGM ì„¤ì • ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                console.error('BGM ì„¤ì • ì‹¤íŒ¨:', error);
            }
        }

        async function uploadBGM() {
            const file = document.getElementById('bgm-file').files[0];
            if (!file) {
                showMessage('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                showLoadingModal('BGM ì—…ë¡œë“œ ì¤‘...', 'ìŒì•… íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ìˆìŠµë‹ˆë‹¤.');
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE}/projects/${projectId}/upload/bgm`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (data.ok) {
                    showMessage('BGM íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    document.getElementById('bgm-file').value = '';
                    await loadProject();

                    const resultEl = document.getElementById('bgm-result');
                    resultEl.style.display = 'block';
                    resultEl.querySelector('#bgm-result-content').innerHTML = `<p>BGM ì—…ë¡œë“œ ì™„ë£Œ</p>`;
                } else {
                    showMessage('BGM ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (data.error || 'Unknown'), 'error');
                }
            } catch (error) {
                console.error('BGM ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                showMessage('BGM ì—…ë¡œë“œ ì‹¤íŒ¨', 'error');
            } finally {
                hideLoadingModal();
            }
        }

        // RENDER
        async function startRender() {
            try {
                showLoadingModal('ì˜ìƒ ë Œë”ë§ ì¤‘...', 'ìµœì¢… ì˜ìƒì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                const response = await fetch(`${API_BASE}/projects/${projectId}/render`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const data = await response.json();
                if (data.ok) {
                    showMessage('ì˜ìƒ ë Œë”ë§ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    await loadProject();

                    const resultEl = document.getElementById('render-result');
                    resultEl.style.display = 'block';
                    resultEl.querySelector('#render-result-content').innerHTML = `<p>âœ¨ ë Œë”ë§ ì™„ë£Œ!</p>`;
                } else {
                    showMessage('ë Œë”ë§ ì‹¤íŒ¨: ' + (data.error || 'Unknown'), 'error');
                }
            } catch (error) {
                console.error('ë Œë”ë§ ì‹¤íŒ¨:', error);
                showMessage('ë Œë”ë§ ì‹¤íŒ¨', 'error');
            } finally {
                hideLoadingModal();
            }
        }

        // ============================================================================
        // TEXT VIEWER MODAL
        // ============================================================================
        async function viewTextFile(path, title) {
            try {
                const response = await fetch(`${API_BASE}/projects/${projectId}/text?path=${encodeURIComponent(path)}`);
                const data = await response.json();

                if (response.ok && data.ok) {
                    let content = data.content || '';
                    if (path.endsWith('.json')) {
                        try {
                            content = JSON.stringify(JSON.parse(content), null, 2);
                        } catch (e) {
                            // ignore
                        }
                    }

                    openTextViewer(title || path, content);
                } else {
                    showMessage('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                console.error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨:', error);
                showMessage('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨', 'error');
            }
        }

        function openTextViewer(title, content) {
            document.getElementById('text-viewer-title').textContent = title;
            document.getElementById('text-viewer-content').textContent = content;
            document.getElementById('text-viewer-modal').classList.add('open');
        }

        function closeTextViewer() {
            document.getElementById('text-viewer-modal').classList.remove('open');
        }

        function copyViewerContent() {
            const content = document.getElementById('text-viewer-content').textContent;
            navigator.clipboard.writeText(content).then(() => {
                showMessage('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }).catch(() => {
                showMessage('ë³µì‚¬ ì‹¤íŒ¨', 'error');
            });
        }

        // ============================================================================
        // PROJECT SAVE
        // ============================================================================
        async function saveProject() {
            try {
                showMessage('í”„ë¡œì íŠ¸ ì €ì¥ ì¤‘...', 'success');
                // Project auto-saves through individual endpoint calls, this is just feedback
                showMessage('í”„ë¡œì íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                console.error('í”„ë¡œì íŠ¸ ì €ì¥ ì‹¤íŒ¨:', error);
                showMessage('í”„ë¡œì íŠ¸ ì €ì¥ ì‹¤íŒ¨', 'error');
            }
        }
    </script>
</body>
</html>

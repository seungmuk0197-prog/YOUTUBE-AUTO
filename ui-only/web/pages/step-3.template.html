<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3. ëŒ€ë³¸ ì§ì ‘ ì…ë ¥</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Malgun Gothic", sans-serif;
      background: #f5f5f5;
      color: #333;
      min-height: 100vh;
    }
    .layout { display: flex; min-height: 100vh; padding-top: 0; }
    .sidebar {
      width: 300px;
      background: linear-gradient(180deg, #fafbff 0%, #f2f4f8 100%);
      border-right: 1px solid #e8ecf4;
      padding: 20px 16px 24px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 20px;
      height: 100vh;
      overflow-y: auto;
    }
    .sidebar-logo {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      font-weight: 700;
      font-size: 1.5rem;
      letter-spacing: 0.05em;
      color: #2d3748;
      margin-top: 8px;
      margin-bottom: 0;
      padding-left: 4px;
      text-align: left;
      cursor: pointer;
      transition: color 0.2s;
    }
    .sidebar-logo:hover {
      color: #9333ea;
    }
    .sidebar-card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.04);
    }
    .workflow-title {
      font-size: 13px;
      font-weight: 700;
      color: #4a5568;
      margin-bottom: 12px;
      padding: 0 4px;
    }
    .workflow-list { list-style: none; padding-right: 4px; }
    .workflow-item {
      display: block;
      padding: 12px 14px;
      margin-bottom: 6px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      color: #4a5568;
      background: #fff;
      border: 1px solid #e2e8f0;
      text-decoration: none;
      transition: background 0.2s, color 0.2s, border-color 0.2s;
    }
    .workflow-item:hover { background: #f7fafc; border-color: #cbd5e0; color: #2d3748; }
    .workflow-item.active {
      background: linear-gradient(135deg, #e9d8fd 0%, #e2e8f0 100%);
      border-color: #b794f4;
      color: #553c9a;
      font-weight: 600;
    }

    .main {
      flex: 1;
      padding: 24px 32px 40px;
      overflow-y: auto;
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      margin-top: 0;
      padding-top: 0;
    }
    .title-area { flex: 1; }
    .title-area h1 {
      font-size: 24px;
      font-weight: 700;
      color: #222;
      margin-bottom: 4px;
      margin-top: 0;
      line-height: 1.3;
    }
    .title-area .subtitle {
      font-size: 14px;
      color: #666;
      margin: 0;
      line-height: 1.4;
    }
    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }
    .login-inline-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .login-input {
      height: 32px;
      padding: 0 10px;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      font-size: 13px;
      box-sizing: border-box;
      transition: background-color 0.2s, border-color 0.2s;
      width: 140px;
    }
    .login-input::placeholder { color: #a0aec0; }
    .login-input:disabled {
      background-color: #E0E0E0;
      border-color: #999;
      color: #666;
      cursor: not-allowed;
      pointer-events: none;
    }
    .btn-admin, .btn-login {
      padding: 0 12px;
      height: 32px;
      background: #e0e0e0;
      color: #333;
      border: 1px solid #c0c0c0;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-admin:hover, .btn-login:hover { background: #d5d5d5; }

    .content-card {
      background: #fff;
      border: 1px solid #e8e8e8;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      margin-bottom: 20px;
    }
    .field-label {
      font-size: 14px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 8px;
    }
    .section-desc {
      font-size: 13px;
      color: #666;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    /* Recap card */
    .recap-card {
      background: #fff7fb;
      border-color: #fed7e2;
    }
    .recap-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .recap-item {
      padding: 8px 10px;
      border-radius: 8px;
      background: rgba(255,255,255,0.9);
      border: 1px solid #fed7e2;
    }
    .recap-label {
      font-size: 12px;
      font-weight: 700;
      color: #d53f8c;
      margin-bottom: 2px;
    }
    .recap-value {
      font-size: 13px;
      color: #333;
      line-height: 1.5;
      white-space: pre-line;
    }

    /* Script editor */
    .editor-textarea {
      width: 100%;
      min-height: 260px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #cbd5e0;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      box-sizing: border-box;
    }
    .btn-primary {
      margin-top: 12px;
      padding: 10px 16px;
      background: #e53935;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn-primary:hover { background: #c62828; }

    .tone-row {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .tone-label {
      font-size: 12px;
      color: #555;
    }
    .tone-select {
      height: 30px;
      padding: 0 8px;
      border-radius: 6px;
      border: 1px solid #cbd5e0;
      font-size: 13px;
      background: #fff;
    }
    .tone-preview {
      margin-top: 8px;
      padding: 10px 12px;
      background: #f0f9ff;
      border-left: 3px solid #0ea5e9;
      border-radius: 6px;
      font-size: 12px;
      color: #0c4a6e;
      line-height: 1.5;
      display: none;
    }
    .tone-preview.show {
      display: block;
    }
    .tone-preview strong {
      color: #0369a1;
    }
    .keywords-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }
    .keywords-label {
      font-size: 12px;
      font-weight: 600;
      color: #4a5568;
    }
    .keywords-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      box-sizing: border-box;
    }
    .keywords-input:focus {
      outline: none;
      border-color: #9333ea;
      box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
    }
    .keywords-hint {
      font-size: 11px;
      color: #718096;
      margin-top: -4px;
    }
    .keyword-validation {
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      display: none;
    }
    .keyword-validation.warning {
      background: #fef3c7;
      border-left: 3px solid #f59e0b;
      color: #92400e;
      display: block;
    }
    .keyword-validation.success {
      background: #d1fae5;
      border-left: 3px solid #10b981;
      color: #047857;
      display: block;
    }
    .keyword-validation strong {
      font-weight: 700;
    }

    /* Scene preview */
    .scene-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 8px;
    }
    .scene-card {
      background: #f7fafc;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      padding: 10px;
    }
    .scene-title {
      font-size: 13px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 4px;
    }
    .scene-body {
      font-size: 12px;
      color: #4a5568;
      line-height: 1.5;
    }

    .btn-next {
      margin-top: 16px;
      width: 100%;
    }

    /* Editor wrapper and duration gauge */
    .editor-wrapper {
      position: relative;
    }
    .duration-gauge {
      position: absolute;
      bottom: 8px;
      right: 12px;
      font-size: 11px;
      color: #718096;
      background: rgba(255, 255, 255, 0.9);
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #e2e8f0;
    }
    .duration-gauge.success {
      color: #047857;
      background: #d1fae5;
      border-color: #10b981;
    }
    .duration-gauge.warning {
      color: #92400e;
      background: #fef3c7;
      border-color: #f59e0b;
    }
    .duration-gauge.error {
      color: #991b1b;
      background: #fee2e2;
      border-color: #ef4444;
    }
    .duration-gauge.refining {
      color: #b91c1c;
      background: #fee2e2;
      border-color: #fca5a5;
    }
    .duration-gauge strong {
      font-weight: 700;
    }

    /* Top selection bar */
    .top-selection-bar {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
      padding: 12px;
      background: #f7fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      flex-wrap: wrap;
    }
    .format-selector {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .selector-label {
      font-size: 13px;
      font-weight: 600;
      color: #4a5568;
      white-space: nowrap;
    }
    .format-toggle {
      display: flex;
      gap: 4px;
      background: #fff;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      padding: 2px;
    }
    .format-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border: none;
      background: transparent;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      color: #4a5568;
      cursor: pointer;
      transition: all 0.2s;
    }
    .format-btn:hover {
      background: #f7fafc;
    }
    .format-btn.active {
      background: #e53935;
      color: #fff;
    }
    .format-icon {
      font-size: 16px;
    }
    .tone-row-inline {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .duration-selector {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .duration-select {
      height: 32px;
      padding: 0 8px;
      border-radius: 6px;
      border: 1px solid #cbd5e0;
      font-size: 13px;
      background: #fff;
    }

    /* Longform dashboard */
    .longform-dashboard {
      margin-top: 20px;
      background: #0f172a;
      color: #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #1e293b;
    }
    .longform-dashboard-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .longform-progress-bar {
      width: 100%;
      height: 12px;
      background: #1e293b;
      border-radius: 6px;
      overflow: hidden;
    }
    .longform-progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #f97316 0%, #facc15 50%, #22c55e 100%);
      transition: width 0.3s ease;
    }
    .longform-status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      font-size: 12px;
    }
    .chapter-indicators {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 6px;
      margin-top: 12px;
    }
    .chapter-indicator {
      height: 10px;
      border-radius: 6px;
      background: #334155;
      border: 1px solid #475569;
    }
    .chapter-indicator.active {
      background: #38bdf8;
      border-color: #38bdf8;
    }
    .chapter-indicator.done {
      background: #22c55e;
      border-color: #16a34a;
    }
    .dashboard-actions {
      margin-top: 12px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .btn-stop-save {
      padding: 6px 10px;
      background: #ef4444;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
    }

    /* Real-time status window */
    .status-window {
      position: fixed;
      right: 16px;
      bottom: 16px;
      width: 260px;
      max-height: 160px;
      overflow-y: auto;
      background: rgba(15, 23, 42, 0.95);
      color: #e2e8f0;
      border: 1px solid #334155;
      border-radius: 10px;
      padding: 10px;
      font-size: 12px;
      z-index: 9999;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .status-window-title {
      font-weight: 700;
      margin-bottom: 6px;
    }
    .status-window-line {
      margin-bottom: 4px;
      color: #cbd5f5;
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-logo" onclick="window.location.href='ai-automation-project.html'" title="í™ˆìœ¼ë¡œ ì´ë™">HANRA STUDIO</div>
      <div class="sidebar-card">
        <div class="workflow-title">ì§„í–‰ ë‹¨ê³„</div>
        <ul class="workflow-list">
          <li><a href="ai-automation-project.html" class="workflow-item">1. ì£¼ì œ ì¶”ì²œ</a></li>
          <li><a href="step-2.html" class="workflow-item">2. AI ëŒ€ë³¸ ìƒì„±</a></li>
          <li><a href="step-3.html" class="workflow-item active">3. ëŒ€ë³¸ ì§ì ‘ ì…ë ¥</a></li>
          <li><a href="step-4-1.html" class="workflow-item">4-1. JSON ìƒì„±</a></li>
          <li><a href="step-4-2.html" class="workflow-item">4-2. ì´ë¯¸ì§€ ìƒì„±</a></li>
          <li><a href="step-6.html" class="workflow-item">5. TTS ìƒì„±</a></li>
          <li><a href="step-5-2.html" class="workflow-item">5-2. BGM ì‚½ì…</a></li>
          <li><a href="step-7.html" class="workflow-item">6. ì˜ìƒ ë Œë”ë§</a></li>
          <li><a href="step-8.html" class="workflow-item">7. ì œëª©/ì„¤ëª… ì‘ì„±</a></li>
          <li><a href="step-9.html" class="workflow-item">8. ì¸ë„¤ì¼ ìƒì„±ê¸°</a></li>
          <li><a href="step-10.html" class="workflow-item">9. ìµœì¢… ì œì‘</a></li>
          <li><a href="step-11.html" class="workflow-item">10. ì‡¼ì¸  ìë™ ë³€í™˜</a></li>
          <li><a href="step-12.html" class="workflow-item">11. ì±„ë„ ë§¤ë‹ˆì €</a></li>
          <li><a href="step-13.html" class="workflow-item">12. ì‘ì—… ë³´ê´€í•¨</a></li>
        </ul>
      </div>
    </aside>

    <main class="main">
      <div class="header-row">
        <div class="title-area">
          <h1>ëŒ€ë³¸ ì§ì ‘ ì…ë ¥</h1>
          <p class="subtitle">ê¸°íšì•ˆì„ ë°”íƒ•ìœ¼ë¡œ AI ëŒ€ë³¸ ì´ˆì•ˆì„ ìƒì„±í•˜ê³  ì”¬ë³„ êµ¬ì„±ì„ í™•ì¸í•©ë‹ˆë‹¤</p>
        </div>
        <div class="header-right">
          <div class="login-inline-row">
            <input type="text" class="login-input" id="loginId" placeholder="ID" />
            <input type="password" class="login-input" id="loginPw" placeholder="Password" />
            <button type="button" class="btn-admin" id="btnAdmin">ê´€ë¦¬</button>
            <button type="button" class="btn-login" id="btnLogin">ë¡œê·¸ì˜¨</button>
          </div>
        </div>
      </div>

      <!-- ìƒë‹¨: Recap -->
      <section class="content-card recap-card">
        <div class="field-label">ê¸°ë³¸ ì •ë³´ ìš”ì•½</div>
        <p class="section-desc">2ë‹¨ê³„ì—ì„œ í™•ì •í•œ ì œëª©Â·íƒ€ê²ŸÂ·í›… ë¬¸êµ¬ë¥¼ ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸í•©ë‹ˆë‹¤.</p>
        <div id="recapGrid" class="recap-grid"></div>
      </section>

      <!-- ì¤‘ë‹¨: Script Editor -->
      <section class="content-card">
        <div class="field-label">AI ëŒ€ë³¸ ì´ˆì•ˆ ìƒì„±</div>
        <p class="section-desc">ì˜ìƒ ë¼ˆëŒ€(Storyline)ì™€ í†¤ì•¤ë§¤ë„ˆë¥¼ ë°”íƒ•ìœ¼ë¡œ êµ¬ì–´ì²´ ëŒ€ë³¸ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>
        
        <!-- ìƒë‹¨ ì„ íƒ ë°”: ì˜ìƒ í˜•ì‹, í†¤ì•¤ë§¤ë„ˆ, ì˜ˆìƒ ê¸¸ì´ -->
        <div class="top-selection-bar">
          <!-- ì˜ìƒ í˜•ì‹ ì„ íƒ (í† ê¸€) -->
          <div class="format-selector">
            <span class="selector-label">ì˜ìƒ í˜•ì‹</span>
            <div class="format-toggle">
              <button type="button" class="format-btn format-btn-shorts active" id="formatShorts" data-format="shorts">
                <span class="format-icon">ğŸ“±</span>
                <span class="format-text">ì‡¼ì¸ </span>
              </button>
              <button type="button" class="format-btn format-btn-longform" id="formatLongform" data-format="longform">
                <span class="format-icon">ğŸ“º</span>
                <span class="format-text">ë¡±í¼</span>
              </button>
            </div>
          </div>
          
          <!-- í†¤ì•¤ë§¤ë„ˆ ë“œë¡­ë‹¤ìš´ -->
          <div class="tone-row-inline">
            <span class="tone-label">ëŒ€ë³¸ í†¤ì•¤ë§¤ë„ˆ</span>
            <select id="toneSelect" class="tone-select">
              <option value="senior-expert" selected>ì‹œë‹ˆì–´ ê±´ê°• ì „ë¬¸ê°€(ê¸°ë³¸)</option>
              <option value="friendly-neighbor">ì¹œê·¼í•œ ì´ì›ƒ</option>
              <option value="grandchild-friendly">ì†ì£¼ì²˜ëŸ¼ ë‹¤ì •í•œ</option>
              <option value="charismatic-trainer">ì¹´ë¦¬ìŠ¤ë§ˆ ê°•ì‚¬</option>
              <option value="professional-analyst">ì „ë¬¸ ë°ì´í„° ë¶„ì„ê°€</option>
              <option value="emotional-storyteller">ê°ì„±ì ì¸ ì´ì•¼ê¸°ê¾¼</option>
              <option value="humorous-comedian">ìœ ë¨¸ëŸ¬ìŠ¤í•œ ë§Œë‹´ê°€</option>
              <option value="urgent-news-anchor">ê¸´ê¸‰ ë‰´ìŠ¤ ì•µì»¤</option>
            </select>
          </div>
          
          <!-- ì˜ˆìƒ ì˜ìƒ ê¸¸ì´ ë“œë¡­ë‹¤ìš´ -->
          <div class="duration-selector">
            <span class="selector-label">ì˜ˆìƒ ì˜ìƒ ê¸¸ì´</span>
            <select id="durationSelect" class="duration-select">
              <option value="30s">30ì´ˆ</option>
              <option value="1m" selected>1ë¶„</option>
              <option value="2m">2ë¶„</option>
              <option value="3m">3ë¶„</option>
            </select>
          </div>
        </div>
        
        <div id="tonePreview" class="tone-preview"></div>
        
        <!-- í•„ìˆ˜ í¬í•¨ í‚¤ì›Œë“œ ì…ë ¥ -->
        <div class="keywords-row">
          <label class="keywords-label">í•„ìˆ˜ í¬í•¨ í‚¤ì›Œë“œ</label>
          <input 
            type="text" 
            id="requiredKeywordsInput" 
            class="keywords-input" 
            placeholder="ì˜ˆ: ê±´ê°•, ì‹œë‹ˆì–´, ìš´ë™, ì˜ì–‘ (ì‰¼í‘œë¡œ êµ¬ë¶„)"
          />
          <div class="keywords-hint">1ë‹¨ê³„ì—ì„œ ì„ ì •í•œ í‚¤ì›Œë“œê°€ ìë™ ì…ë ¥ë©ë‹ˆë‹¤. ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì—¬ ì—¬ëŸ¬ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
          <div id="keywordValidation" class="keyword-validation"></div>
        </div>
        <div class="editor-wrapper">
          <textarea id="scriptEditor" class="editor-textarea" placeholder="AIê°€ ìƒì„±í•œ ëŒ€ë³¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. í•„ìš” ì‹œ ì§ì ‘ ìˆ˜ì •í•´ë„ ì¢‹ìŠµë‹ˆë‹¤."></textarea>
          <div id="durationGauge" class="duration-gauge">
            <span id="durationText">í˜„ì¬ ë¶„ëŸ‰: ê³„ì‚° ì¤‘... / ëª©í‘œ: <span id="targetDuration">1ë¶„</span></span>
          </div>
        </div>
        <button class="btn-primary" type="button" id="btnGenerateScript">AI ëŒ€ë³¸ ì´ˆì•ˆ ìƒì„±í•˜ê¸°</button>
      </section>

      <!-- í•˜ë‹¨: Scene Preview -->
      <section class="content-card">
        <div class="field-label">ì”¬(Scene)ë³„ ë¶„í•  ë¯¸ë¦¬ë³´ê¸°</div>
        <p class="section-desc">2ë‹¨ê³„ì—ì„œ ì‘ì„±í•œ ì˜ìƒ ë¼ˆëŒ€(Storyline)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì”¬ë³„ êµ¬ì„±ì„ í™•ì¸í•©ë‹ˆë‹¤.</p>
        <div id="sceneGrid" class="scene-grid"></div>
        <button class="btn-primary btn-next" type="button" id="btnGoToStep4">4-1. JSON ìƒì„± ë‹¨ê³„ë¡œ ì´ë™</button>
      </section>

      <!-- ì‹¤ì‹œê°„ ì¥í¸ ì œì‘ ëŒ€ì‹œë³´ë“œ -->
      <section class="longform-dashboard" id="longformDashboard" style="display: none;">
        <div class="longform-dashboard-title">ğŸ“Š ì‹¤ì‹œê°„ ì¥í¸ ì œì‘ ëŒ€ì‹œë³´ë“œ</div>
        <div class="longform-progress-bar">
          <div class="longform-progress-fill" id="longformProgressFill"></div>
        </div>
        <div class="longform-status-row">
          <div id="longformProgressText">0/120 ì”¬ ìƒì„± ì¤‘...</div>
          <div id="longformDurationText">ì˜ˆìƒ ê¸¸ì´: 0ë¶„</div>
        </div>
        <div class="chapter-indicators" id="chapterIndicators"></div>
        <div class="dashboard-actions">
          <button class="btn-stop-save" type="button" id="btnStopAndSave">ìƒì„± ì¤‘ë‹¨ ë° ì €ì¥</button>
        </div>
      </section>
    </main>
  </div>

  <!-- ì‹¤ì‹œê°„ ìƒíƒœì°½ -->
  <div class="status-window" id="statusWindow" style="display: none;">
    <div class="status-window-title">ì‹¤ì‹œê°„ ìƒíƒœ</div>
    <div id="statusWindowBody"></div>
  </div>

  <script>
    // Blueprint & recap
    var step3Data = null;
    var blueprint = { title: '', target: '', hook: '', storyline: '' };
    var fromStep2 = null;
    var globalState = null;
    var requiredKeywords = [];

    (function loadStep3Data() {
      try {
        var raw = localStorage.getItem('step3Blueprint');
        if (!raw) return;
        step3Data = JSON.parse(raw);
        if (step3Data && step3Data.blueprint) {
          blueprint = step3Data.blueprint;
        }
        if (step3Data && step3Data.fromStep2) {
          fromStep2 = step3Data.fromStep2;
        }
        
        // 1ë‹¨ê³„ì—ì„œ ì„ ì •í•œ í‚¤ì›Œë“œ ìë™ ì…ë ¥
        try {
          var globalStateRaw = localStorage.getItem('globalState');
          if (globalStateRaw) {
            globalState = JSON.parse(globalStateRaw);
            if (globalState.keyword) {
              requiredKeywords = [globalState.keyword];
              var keywordsInput = document.getElementById('requiredKeywordsInput');
              if (keywordsInput) {
                keywordsInput.value = globalState.keyword;
              }
            }
            // ì„ íƒëœ ì£¼ì œì˜ í‚¤ì›Œë“œë„ í¬í•¨
            if (globalState.selectedTopics && globalState.selectedTopics.length > 0) {
              // ì£¼ì œ ì¹´ë“œì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ (ì‹¤ì œë¡œëŠ” API ì‘ë‹µì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
            }
          }
        } catch (e) {
          console.warn('í‚¤ì›Œë“œ ìë™ ì…ë ¥ ì‹¤íŒ¨:', e);
        }
        
        // AI í”¼ë“œë°± ë£¨í”„: ì´ì „ ì˜ìƒ ëŒ“ê¸€ ë¶„ì„ ê²°ê³¼ë¥¼ í‚¤ì›Œë“œì— ìë™ ì¶”ê°€
        loadFeedbackKeywords();
      } catch (e) {}
    })();

    // AI í”¼ë“œë°± ë£¨í”„: ì´ì „ ì˜ìƒ ëŒ“ê¸€ ë¶„ì„ ê²°ê³¼ ë¡œë“œ
    async function loadFeedbackKeywords() {
      try {
        // ìµœê·¼ ì—…ë¡œë“œëœ ì˜ìƒì˜ ëŒ“ê¸€ ë¶„ì„ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
        var response = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/feedback/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            comments: [], // ì‹¤ì œë¡œëŠ” ìµœê·¼ ì˜ìƒ ëŒ“ê¸€ ë°ì´í„°
            videoTitle: blueprint.title || '',
            category: globalState?.selectedCategory || ''
          })
        });
        
        if (response.ok) {
          var data = await response.json();
          var recommendedKeywords = data.summary?.recommendedKeywords || [];
          
          if (recommendedKeywords.length > 0) {
            var keywordsInput = document.getElementById('requiredKeywordsInput');
            if (keywordsInput) {
              var currentKeywords = keywordsInput.value.trim();
              var existingKeywords = currentKeywords ? currentKeywords.split(',').map(function(k) { return k.trim(); }) : [];
              
              // ì¤‘ë³µ ì œê±°í•˜ë©° ì¶”ê°€
              recommendedKeywords.forEach(function(keyword) {
                if (keyword && !existingKeywords.includes(keyword.trim())) {
                  existingKeywords.push(keyword.trim());
                }
              });
              
              keywordsInput.value = existingKeywords.join(', ');
              
              // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
              var validationEl = document.getElementById('keywordValidation');
              if (validationEl) {
                validationEl.className = 'keyword-validation success';
                validationEl.innerHTML = '<strong>ğŸ’¡ AI í”¼ë“œë°± ë°˜ì˜:</strong> ì´ì „ ì˜ìƒ ëŒ“ê¸€ ë¶„ì„ ê²°ê³¼, ë‹¤ìŒ í‚¤ì›Œë“œê°€ ìë™ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤: ' + 
                                         recommendedKeywords.join(', ') + 
                                         '<br><small>ì‹œì²­ìë“¤ì´ ìš”ì²­í•œ ë‚´ìš©ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.</small>';
                
                // 5ì´ˆ í›„ ìë™ ìˆ¨ê¹€
                setTimeout(function() {
                  if (validationEl && validationEl.className.includes('success')) {
                    validationEl.className = 'keyword-validation';
                    validationEl.innerHTML = '';
                  }
                }, 5000);
              }
              
              console.log('[Step 3] í”¼ë“œë°± ê¸°ë°˜ í‚¤ì›Œë“œ ìë™ ì¶”ê°€:', recommendedKeywords);
            }
          }
        }
      } catch (error) {
        console.warn('[Step 3] í”¼ë“œë°± í‚¤ì›Œë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
        // ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (ì˜µì…˜ ê¸°ëŠ¥)
      }
    }

    function renderRecap() {
      var grid = document.getElementById('recapGrid');
      if (!grid) return;
      var rows = [];
      if (blueprint.title) rows.push({ label: 'ì œëª©', value: blueprint.title });
      if (blueprint.target) rows.push({ label: 'íƒ€ê²Ÿ ì‹œì²­ì', value: blueprint.target });
      if (blueprint.hook) rows.push({ label: 'í›…(Hook) ë¬¸êµ¬', value: blueprint.hook });
      if (!rows.length) {
        grid.innerHTML = '<div class="recap-item"><div class="recap-value">2ë‹¨ê³„ ê¸°íšì•ˆ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ì „ ë‹¨ê³„ì—ì„œ ë‹¤ì‹œ ì„¤ì •í•´ ì£¼ì„¸ìš”.</div></div>';
        return;
      }
      grid.innerHTML = rows
        .map(function(row) {
          return (
            '<div class="recap-item">' +
            '<div class="recap-label">' +
            row.label +
            '</div>' +
            '<div class="recap-value">' +
            String(row.value) +
            '</div>' +
            '</div>'
          );
        })
        .join('');
    }

    function parseStorylineLines() {
      var text = blueprint.storyline || '';
      if (!text && fromStep2 && fromStep2.blueprint && fromStep2.blueprint.storyline) {
        text = fromStep2.blueprint.storyline;
      }
      var lines = String(text)
        .split(/\r?\n/)
        .map(function(l) { return l.trim(); })
        .filter(function(l) { return l.length > 0; })
        .map(function(l) {
          return l.replace(/^[0-9]+\)|^[0-9]+\./, '').trim();
        });
      if (!lines.length) {
        return ['ì¸íŠ¸ë¡œ', 'í•µì‹¬ ë‚´ìš©', 'ë§ˆë¬´ë¦¬'];
      }
      return lines;
    }

    // ì”¬ë³„ ì‹œê° ë¬˜ì‚¬ ìë™ ë³€í™˜ í•¨ìˆ˜ (ì”¬ ìµœì í™”)
    function generateSceneVisualPrompts(script, scenes) {
      if (!script || !scenes || scenes.length === 0) return [];
      
      // ëŒ€ë³¸ì„ ì”¬ë³„ë¡œ ë¶„í• 
      var scriptLines = script.split(/\r?\n/);
      var sceneScripts = [];
      var currentScene = 0;
      var currentLines = [];
      
      for (var i = 0; i < scriptLines.length; i++) {
        var line = scriptLines[i];
        var sceneMatch = line.match(/\[ì”¬\s*(\d+)\]/);
        
        if (sceneMatch) {
          if (currentScene > 0) {
            sceneScripts.push({
              scene_num: currentScene,
              script: currentLines.join('\n').trim(),
              scene_title: scenes[currentScene - 1] || 'ì”¬ ' + currentScene
            });
          }
          currentScene = parseInt(sceneMatch[1], 10);
          currentLines = [];
        } else if (currentScene > 0) {
          currentLines.push(line);
        }
      }
      
      // ë§ˆì§€ë§‰ ì”¬ ì¶”ê°€
      if (currentScene > 0 && currentLines.length > 0) {
        sceneScripts.push({
          scene_num: currentScene,
          script: currentLines.join('\n').trim(),
          scene_title: scenes[currentScene - 1] || 'ì”¬ ' + currentScene
        });
      }
      
      // ê° ì”¬ì— ëŒ€í•´ ì‹œê° ë¬˜ì‚¬ ìƒì„± (Subject, Action, Setting ì¶”ì¶œ)
      return sceneScripts.map(function(scene) {
        var sceneScript = scene.script || '';
        
        // Subject, Action, Setting ì¶”ì¶œ
        var subject = 'A healthy senior person';
        var action = '';
        var setting = 'in a bright and comfortable environment';
        
        var scriptLower = sceneScript.toLowerCase();
        
        // ì£¼ì²´ ì¶”ì¶œ
        if (scriptLower.includes('ë‚¨ì„±') || scriptLower.includes('í• ì•„ë²„ì§€') || scriptLower.includes('ì•„ì €ì”¨')) {
          subject = 'A healthy senior man';
        } else if (scriptLower.includes('ì—¬ì„±') || scriptLower.includes('í• ë¨¸ë‹ˆ') || scriptLower.includes('ì–´ë¨¸ë‹ˆ')) {
          subject = 'A healthy senior woman';
        } else if (scriptLower.includes('ë¶€ë¶€') || scriptLower.includes('ì»¤í”Œ')) {
          subject = 'A healthy senior couple';
        }
        
        // ë™ì‘ ì¶”ì¶œ
        var actionKeywords = {
          'ê±·': 'walking',
          'ì•‰': 'sitting',
          'ì„œ': 'standing',
          'ìš´ë™': 'exercising',
          'ë¨¹': 'eating',
          'ë§ˆì‹œ': 'drinking',
          'ë§í•˜': 'speaking',
          'ì›ƒ': 'smiling',
          'ë³´': 'looking',
          'ë“¤': 'listening',
          'í´': 'extending',
          'êµ¬ë¶€': 'bending'
        };
        
        for (var key in actionKeywords) {
          if (sceneScript.includes(key)) {
            action = actionKeywords[key];
            break;
          }
        }
        
        // ë°°ê²½ ì¶”ì¶œ
        if (scriptLower.includes('ê³µì›') || scriptLower.includes('ì‚°ì±…')) {
          setting = 'in a sunny park with morning sunlight';
        } else if (scriptLower.includes('ì§‘') || scriptLower.includes('ì§‘ì•ˆ') || scriptLower.includes('ê±°ì‹¤') || scriptLower.includes('ì˜ì')) {
          setting = 'in a bright and cozy living room';
        } else if (scriptLower.includes('ë³‘ì›') || scriptLower.includes('ì˜ì›')) {
          setting = 'in a clean and modern medical facility';
        } else if (scriptLower.includes('ì‹¤ì™¸') || scriptLower.includes('ì•¼ì™¸')) {
          setting = 'in an outdoor setting with natural lighting';
        }
        
        // ì‹œë‹ˆì–´ ë§ì¶¤í˜• ì‹œê° ìµœì í™” í‚¤ì›Œë“œ ì£¼ì…
        var seniorOptimizationKeywords = 'warm and bright lighting, high contrast for better visibility, clear and friendly facial expressions, 8k resolution, cinematic quality, senior-friendly composition';
        var negativePrompt = 'dark, blurry, distorted faces, messy background, too small text';
        
        var visualDescription = subject + (action ? ' ' + action : '') + ' ' + setting + '. ' + seniorOptimizationKeywords;
        
        return {
          scene_num: scene.scene_num,
          scene_title: scene.scene_title,
          script: scene.script,
          visual_description: visualDescription,
          image_prompt: visualDescription + '. Negative prompt: ' + negativePrompt
        };
      });
    }

    // í†¤ì•¤ë§¤ë„ˆë³„ ìƒì„¸ ì •ì˜ (í˜ë¥´ì†Œë‚˜ ê·œì¹™)
    var tonePersonaMap = {
      'senior-expert': {
        name: 'ì‹œë‹ˆì–´ ê±´ê°• ì „ë¬¸ê°€',
        rules: [
          'ì‹ ë¢°ê° ìˆëŠ” ì „ë¬¸ ìš©ì–´ë¥¼ ì‚¬ìš©í•˜ë˜, ë¬¸ì¥ ëì€ "í•˜ì‹­ì‹œì˜¤", "ì…ë‹ˆë‹¤", "ë©ë‹ˆë‹¤"ì™€ ê°™ì€ ê²©ì‹ì²´(í•©ì‡¼ì²´)ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.',
          'ì˜í•™ì  ìš©ì–´ë‚˜ ê±´ê°• ê´€ë ¨ ì „ë¬¸ ì§€ì‹ì„ ìì—°ìŠ¤ëŸ½ê²Œ í’€ì–´ë‚´ë˜, ì‹œë‹ˆì–´ê°€ ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…í•©ë‹ˆë‹¤.',
          'ì¡´ëŒ“ë§ì„ ì¼ê´€ë˜ê²Œ ìœ ì§€í•˜ë©°, "~í•˜ì‹œë©´ ë©ë‹ˆë‹¤", "~í•˜ì‹œëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤" ê°™ì€ ê¶Œìœ í˜• ë¬¸ì¥ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.',
          'ê°ì •ì ì¸ ì„œìˆ ë³´ë‹¤ëŠ” ì‚¬ì‹¤ê³¼ ê·¼ê±°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì°¨ë¶„í•˜ê³  ì‹ ë¢°ê° ìˆê²Œ ì „ë‹¬í•©ë‹ˆë‹¤.'
        ],
        preview: 'í•´ë‹¹ í†¤ìœ¼ë¡œ ë³€í™˜í•˜ë©´ <strong>"í•˜ì‹­ì‹œì˜¤", "ì…ë‹ˆë‹¤"</strong> ê°™ì€ ê²©ì‹ì²´ë¡œ ì „ë¬¸ì ì´ê³  ì‹ ë¢°ê° ìˆê²Œ ì„¤ëª…í•©ë‹ˆë‹¤.',
        endingExamples: ['í•˜ì‹­ì‹œì˜¤', 'ì…ë‹ˆë‹¤', 'ë©ë‹ˆë‹¤', 'í•˜ì‹œë©´ ë©ë‹ˆë‹¤', 'í•˜ì‹œëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤']
      },
      'friendly-neighbor': {
        name: 'ì¹œê·¼í•œ ì´ì›ƒ',
        rules: [
          'ì˜†ì§‘ ì´ì›ƒì²˜ëŸ¼ ë¶€ë“œëŸ¬ìš´ í•´ìš”ì²´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. "~í•´ìš”", "~í–ˆë‚˜ìš”?", "~ê±°ë“ ìš”"ì™€ ê°™ì€ í•´ìš”ì²´ë¥¼ ê¸°ë³¸ìœ¼ë¡œ í•©ë‹ˆë‹¤.',
          'ê°íƒ„ì‚¬ë¥¼ ì ì ˆíˆ ì„ì–´ì£¼ì„¸ìš”: "ì•„!", "ì™€!", "ì •ë§ìš”?", "ê·¸ë ‡êµ¬ë‚˜!"',
          'ì§ˆë¬¸ì„ ìì£¼ ë˜ì ¸ì„œ ì‹œì²­ìì™€ì˜ ì†Œí†µê°ì„ ë†’ì…ë‹ˆë‹¤: "ì–´ë– ì„¸ìš”?", "ì•Œê³  ê³„ì…¨ë‚˜ìš”?", "ê¶ê¸ˆí•˜ì§€ ì•Šìœ¼ì„¸ìš”?"',
          'ì¼ìƒì ì¸ ë¹„ìœ ì™€ ì˜ˆì‹œë¥¼ ë§ì´ ì‚¬ìš©í•˜ì—¬ ì¹œê·¼í•¨ì„ ë”í•©ë‹ˆë‹¤.',
          'ë¬¸ì¥ì„ ì§§ê²Œ ëŠì–´ì„œ ë§í•˜ë“¯ì´ ìì—°ìŠ¤ëŸ½ê²Œ ì‘ì„±í•©ë‹ˆë‹¤.'
        ],
        preview: 'í•´ë‹¹ í†¤ìœ¼ë¡œ ë³€í™˜í•˜ë©´ <strong>"~í•´ìš”", "~í–ˆë‚˜ìš”?"</strong> ê°™ì€ í•´ìš”ì²´ë¡œ ì¹œê·¼í•˜ê³  ë”°ëœ»í•˜ê²Œ ì„¤ëª…í•©ë‹ˆë‹¤.',
        endingExamples: ['í•´ìš”', 'í–ˆë‚˜ìš”?', 'ê±°ë“ ìš”', 'ì–´ë– ì„¸ìš”?', 'ì•Œê³  ê³„ì…¨ë‚˜ìš”?']
      },
      'grandchild-friendly': {
        name: 'ì†ì£¼ì²˜ëŸ¼ ë‹¤ì •í•œ',
        rules: [
          '"í• ë¨¸ë‹ˆ~ ì´ê²ƒ ì¢€ ë³´ì„¸ìš”!"ì™€ ê°™ì€ ì• êµ ì„ì¸ ë§íˆ¬ë¥¼ ì ê·¹ ì‚¬ìš©í•©ë‹ˆë‹¤. "~í•˜ì„¸ìš”", "~í•˜ì…”ì•¼ í•´ìš”", "~í•˜ì‹œë©´ ì•ˆ ë¼ìš”" ê°™ì€ ë¶€ë“œëŸ¬ìš´ í•´ìš”ì²´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.',
          'ì†ì£¼ê°€ í• ë¨¸ë‹ˆ í• ì•„ë²„ì§€ì—ê²Œ ë§í•˜ë“¯ì´ ë”°ëœ»í•˜ê³  ì• ì • ì–´ë¦° í†¤ì„ ìœ ì§€í•©ë‹ˆë‹¤: "í• ë¨¸ë‹ˆ, ì´ê±° ì •ë§ ì¤‘ìš”í•˜ì„¸ìš”!", "í• ì•„ë²„ì§€, ê¼­ ê¸°ì–µí•˜ì„¸ìš”!"',
          'ë³µì¡í•œ ì„¤ëª…ì„ ì‰½ê²Œ í’€ì–´ì„œ ì„¤ëª…í•˜ë©°, "ì´ë ‡ê²Œ ìƒê°í•˜ì‹œë©´ ë¼ìš”", "ê°„ë‹¨í•˜ê²Œ ë§í•˜ë©´" ê°™ì€ í‘œí˜„ì„ ìì£¼ ì‚¬ìš©í•©ë‹ˆë‹¤.',
          'ì‹œë‹ˆì–´ë¥¼ ë°°ë ¤í•˜ëŠ” ë”°ëœ»í•œ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ë©°, "ì¡°ì‹¬í•˜ì„¸ìš”", "ì²œì²œíˆ í•˜ì„¸ìš”", "ë¬´ë¦¬í•˜ì§€ ë§ˆì„¸ìš”" ê°™ì€ ë°°ë ¤ í‘œí˜„ì„ í¬í•¨í•©ë‹ˆë‹¤.',
          'ê°íƒ„ì‚¬ì™€ ë¶€ë“œëŸ¬ìš´ ì§ˆë¬¸ì„ ì ì ˆíˆ ì„ì–´ì„œ ì¹œê·¼í•¨ì„ ë”í•©ë‹ˆë‹¤: "ì•„, ê·¸ë ‡êµ¬ë‚˜!", "ì•Œê³  ê³„ì…¨ë‚˜ìš”?", "ê¶ê¸ˆí•˜ì‹œì£ ?"'
        ],
        preview: 'í•´ë‹¹ í†¤ìœ¼ë¡œ ë³€í™˜í•˜ë©´ <strong>"í• ë¨¸ë‹ˆ~ ì´ê²ƒ ì¢€ ë³´ì„¸ìš”!"</strong>ì²˜ëŸ¼ ì• êµ ì„ì¸ ë‹¤ì •í•œ í‘œí˜„ìœ¼ë¡œ ë”°ëœ»í•˜ê²Œ ì„¤ëª…í•©ë‹ˆë‹¤.',
        endingExamples: ['í•˜ì„¸ìš”', 'í•˜ì…”ì•¼ í•´ìš”', 'í•˜ì‹œë©´ ì•ˆ ë¼ìš”', 'ê¸°ì–µí•˜ì„¸ìš”', 'ì•Œê³  ê³„ì…¨ë‚˜ìš”?']
      },
      'charismatic-trainer': {
        name: 'ì¹´ë¦¬ìŠ¤ë§ˆ ê°•ì‚¬',
        rules: [
          '"ì, ë”°ë¼ í•˜ì„¸ìš”! í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!"ì™€ ê°™ì€ í™œê¸°ì°¬ ëª…ë ¹ì¡°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤: "ì, ì‹œì‘í•´ë´…ì‹œë‹¤!", "í™”ì´íŒ…!", "í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!"',
          'ìš´ë™ ê°•ì‚¬ì²˜ëŸ¼ ë™ê¸°ë¶€ì—¬í•˜ëŠ” í‘œí˜„ì„ ì ê·¹ í™œìš©í•©ë‹ˆë‹¤: "ì—¬ëŸ¬ë¶„ë„ í•  ìˆ˜ ìˆì–´ìš”!", "í•¨ê»˜ í•´ë´…ì‹œë‹¤!", "í•œ ë²ˆ ë”!"',
          'ì§§ê³  ê°•ë ¬í•œ ë¬¸ì¥ì„ ì‚¬ìš©í•˜ì—¬ ë¦¬ë“¬ê°ì„ ì¤ë‹ˆë‹¤. "í•˜ë‚˜, ë‘˜, ì…‹!" ê°™ì€ ì¹´ìš´íŠ¸ í‘œí˜„ì„ í¬í•¨í•©ë‹ˆë‹¤.',
          'ê¸ì •ì ì¸ ì—ë„ˆì§€ë¥¼ ì „ë‹¬í•˜ëŠ” í‘œí˜„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤: "í›Œë¥­í•´ìš”!", "ì˜í•˜ê³  ê³„ì„¸ìš”!", "ë©‹ì ¸ìš”!"',
          'ëª…í™•í•˜ê³  ì§ì ‘ì ì¸ ì§€ì‹œë¥¼ ì‚¬ìš©í•˜ë©°, "ì´ë ‡ê²Œ í•˜ì„¸ìš”", "ë°˜ë“œì‹œ ê¸°ì–µí•˜ì„¸ìš”" ê°™ì€ ê°•ì¡° í‘œí˜„ì„ í¬í•¨í•©ë‹ˆë‹¤.'
        ],
        preview: 'í•´ë‹¹ í†¤ìœ¼ë¡œ ë³€í™˜í•˜ë©´ <strong>"ì, ë”°ë¼ í•˜ì„¸ìš”! í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!"</strong> ê°™ì€ í™œê¸°ì°¬ ëª…ë ¹ì¡°ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤.',
        endingExamples: ['ì‹œì‘í•´ë´…ì‹œë‹¤!', 'í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!', 'í•¨ê»˜ í•´ë´…ì‹œë‹¤!', 'ì˜í•˜ê³  ê³„ì„¸ìš”!', 'ë°˜ë“œì‹œ ê¸°ì–µí•˜ì„¸ìš”!']
      },
      'professional-analyst': {
        name: 'ì „ë¬¸ ë°ì´í„° ë¶„ì„ê°€',
        rules: [
          'ìˆ˜ì¹˜ì™€ ê·¼ê±° ìœ„ì£¼ì˜ ë”±ë”±í•œ ë¬¸ì²´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ê°ì •ì ì¸ ì„œìˆ ì„ ë°°ì œí•˜ê³  ê°ê´€ì  ì‚¬ì‹¤ë§Œ ì „ë‹¬í•©ë‹ˆë‹¤.',
          'ëª…ì‚¬í˜• ì¢…ê²°ì´ë‚˜ ë³´ê³ ì„œ ìŠ¤íƒ€ì¼ì˜ ë¬¸ì²´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤: "~í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤", "~ì— ì£¼ì˜í•´ì•¼ í•œë‹¤", "~ë¡œ í™•ì¸ë˜ì—ˆë‹¤"',
          'ë°ì´í„°, í†µê³„, ì—°êµ¬ ê²°ê³¼ë¥¼ ëª…í™•íˆ ì œì‹œí•˜ë©° ê°ê´€ì ì¸ í†¤ì„ ìœ ì§€í•©ë‹ˆë‹¤.',
          'ë¶ˆí•„ìš”í•œ ìˆ˜ì‹ì–´ë¥¼ ì œê±°í•˜ê³  í•µì‹¬ë§Œ ê°„ê²°í•˜ê²Œ ì „ë‹¬í•©ë‹ˆë‹¤.',
          'ë¬¸ì¥ì„ ê¸¸ê²Œ êµ¬ì„±í•˜ì—¬ ë…¼ë¦¬ì  íë¦„ì„ ê°•ì¡°í•©ë‹ˆë‹¤.'
        ],
        preview: 'í•´ë‹¹ í†¤ìœ¼ë¡œ ë³€í™˜í•˜ë©´ <strong>ìˆ˜ì¹˜ì™€ ê·¼ê±° ìœ„ì£¼ì˜ ë”±ë”±í•œ ë¬¸ì²´</strong>ë¡œ ì „ë¬¸ì ì´ê³  ê°ê´€ì ìœ¼ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤.',
        endingExamples: ['ì¤‘ìš”í•˜ë‹¤', 'ì£¼ì˜í•´ì•¼ í•œë‹¤', 'í™•ì¸ë˜ì—ˆë‹¤', 'ê¶Œì¥ëœë‹¤', 'í•„ìš”í•˜ë‹¤']
      },
      'emotional-storyteller': {
        name: 'ê°ì„±ì ì¸ ì´ì•¼ê¸°ê¾¼',
        rules: [
          'ë”°ëœ»í•œ ìœ„ë¡œì™€ ê³µê°ì„ ì£¼ëŠ” ì„œìˆ í˜• ë¬¸ì²´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤: "ë§ì€ ë¶„ë“¤ì´ ê·¸ë ‡ê²Œ ëŠë¼ì…¨ì„ ê±°ì˜ˆìš”", "ì´í•´ê°€ ë˜ì‹œë‚˜ìš”?"',
          'ìŠ¤í† ë¦¬í…”ë§ ê¸°ë²•ì„ í™œìš©í•˜ì—¬ ì´ì•¼ê¸°ì²˜ëŸ¼ í’€ì–´ëƒ…ë‹ˆë‹¤: "ì˜›ë‚  ì˜›ì ì—", "í•œ ë¶„ì˜ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ë“œë¦´ê²Œìš”"',
          'ê°ì •ì„ ìê·¹í•˜ëŠ” í‘œí˜„ì„ ì ì ˆíˆ ì‚¬ìš©í•©ë‹ˆë‹¤: "ë§ˆìŒì´ ë”°ëœ»í•´ì§€ì‹œì£ ?", "ê³µê°ì´ ë˜ì‹œë‚˜ìš”?", "í•¨ê»˜ ì•„íŒŒí•˜ì‹œëŠ” ë¶„ë“¤"',
          'ì€ìœ ì™€ ë¹„ìœ ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°ì„±ì ìœ¼ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤: "ì¸ìƒì€ í•œ ê·¸ë£¨ ë‚˜ë¬´ì™€ ê°™ì•„ìš”", "ì‹œê°„ì€ ê°•ë¬¼ì²˜ëŸ¼ í˜ëŸ¬ê°€ì£ "',
          'ë¶€ë“œëŸ½ê³  ì—¬ìœ  ìˆëŠ” ë¬¸ì¥ êµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ë©°, "~í•˜ì‹œëŠ” ë¶„ë“¤", "~í•˜ì‹œëŠ” ê²Œ ì¢‹ì„ ê²ƒ ê°™ì•„ìš”" ê°™ì€ ê³µê° í‘œí˜„ì„ í¬í•¨í•©ë‹ˆë‹¤.'
        ],
        preview: 'í•´ë‹¹ í†¤ìœ¼ë¡œ ë³€í™˜í•˜ë©´ <strong>ë”°ëœ»í•œ ìœ„ë¡œì™€ ê³µê°</strong>ì„ ì£¼ëŠ” ì„œìˆ í˜• ë¬¸ì²´ë¡œ ê°ì„±ì ìœ¼ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤.',
        endingExamples: ['ëŠë¼ì…¨ì„ ê±°ì˜ˆìš”', 'ì´í•´ê°€ ë˜ì‹œë‚˜ìš”?', 'ë§ˆìŒì´ ë”°ëœ»í•´ì§€ì‹œì£ ?', 'ê³µê°ì´ ë˜ì‹œë‚˜ìš”?', 'ì¢‹ì„ ê²ƒ ê°™ì•„ìš”']
      },
      'humorous-comedian': {
        name: 'ìœ ë¨¸ëŸ¬ìŠ¤í•œ ë§Œë‹´ê°€',
        rules: [
          'ì¬ì¹˜ ìˆëŠ” ë¹„ìœ ì™€ ë†ë‹´ì„ ë¬¸ì¥ë§ˆë‹¤ í¬í•¨í•©ë‹ˆë‹¤. ì‹œë‹ˆì–´ë“¤ì´ ì›ƒì„ ìˆ˜ ìˆëŠ” ê°€ë²¼ìš´ ë†ë‹´ì´ë‚˜ ì¬ì¹˜ ìˆëŠ” ë¹„ìœ ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.',
          'íŠ¹ì • í‘œí˜„ì„ ì ê·¹ í™œìš©í•©ë‹ˆë‹¤: "ê¹œì§ ë†€ë¼ì…¨ì£ ?", "ì´ê²ƒë§Œ ì•Œë©´ ë§Œì„¸!", "ì •ë§ ì‹ ê¸°í•˜ì§€ ì•Šìœ¼ì„¸ìš”?"',
          'ì¼ìƒìƒí™œì˜ ê³µê°ëŒ€ë¥¼ í˜•ì„±í•  ìˆ˜ ìˆëŠ” ìœ ë¨¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤: "ìš°ë¦¬ í• ë¨¸ë‹ˆë„ ê·¸ë ‡ê²Œ í•˜ì‹œë”ë¼êµ¬ìš”", "ì´ì œì•¼ ì•Œì•˜ì£ ?"',
          'ê³¼ì¥ëœ í‘œí˜„ì´ë‚˜ ë°˜ì „ì„ í™œìš©í•˜ì—¬ ì¬ë¯¸ë¥¼ ë”í•©ë‹ˆë‹¤.',
          'í•´ìš”ì²´ë¥¼ ê¸°ë³¸ìœ¼ë¡œ í•˜ë˜, ìœ ë¨¸ ìš”ì†Œë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ëƒ…ë‹ˆë‹¤.'
        ],
        preview: 'í•´ë‹¹ í†¤ìœ¼ë¡œ ë³€í™˜í•˜ë©´ <strong>"ê¹œì§ ë†€ë¼ì…¨ì£ ?", "ì´ê²ƒë§Œ ì•Œë©´ ë§Œì„¸!"</strong> ê°™ì€ ì¬ì¹˜ ìˆëŠ” ë¹„ìœ ì™€ ë†ë‹´ìœ¼ë¡œ ìœ ë¨¸ëŸ¬ìŠ¤í•˜ê²Œ ì„¤ëª…í•©ë‹ˆë‹¤.',
        endingExamples: ['ë†€ë¼ì…¨ì£ ?', 'ë§Œì„¸!', 'ì‹ ê¸°í•˜ì§€ ì•Šìœ¼ì„¸ìš”?', 'ì´ì œì•¼ ì•Œì•˜ì£ ?', 'ì›ƒê¸°ì§€ ì•Šìœ¼ì„¸ìš”?']
      },
      'urgent-news-anchor': {
        name: 'ê¸´ê¸‰ ë‰´ìŠ¤ ì•µì»¤',
        rules: [
          'ëª…í™•í•œ ë°œìŒê³¼ í•µì‹¬ ìœ„ì£¼ì˜ ê¸´ë°•í•œ ë¬¸ì²´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤: "ì¤‘ìš”í•œ ì†Œì‹ì…ë‹ˆë‹¤", "ì§€ê¸ˆ ë°”ë¡œ í™•ì¸í•´ë³´ì„¸ìš”"',
          'ë‰´ìŠ¤ ì•µì»¤ì²˜ëŸ¼ ê°ê´€ì ì´ê³  ì‚¬ì‹¤ ì¤‘ì‹¬ìœ¼ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤: "í™•ì¸ëœ ì‚¬ì‹¤ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤", "ì „ë¬¸ê°€ì— ë”°ë¥´ë©´"',
          'ê¸´ê¸‰ì„±ê³¼ ì¤‘ìš”ì„±ì„ ê°•ì¡°í•˜ëŠ” í‘œí˜„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤: "ì§€ê¸ˆ ë‹¹ì¥", "ë°˜ë“œì‹œ ì•Œì•„ì•¼ í• ", "ì£¼ì˜í•´ì•¼ í• "',
          'ëª…í™•í•˜ê³  ê°„ê²°í•œ ë¬¸ì¥ êµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ë©°, ë¶ˆí•„ìš”í•œ ìˆ˜ì‹ì–´ë¥¼ ì œê±°í•©ë‹ˆë‹¤.',
          'ë‰´ìŠ¤ ìŠ¤íƒ€ì¼ì˜ ë„ì…ë¶€ì™€ ë§ˆë¬´ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤: "ì•ˆë…•í•˜ì„¸ìš”, ì˜¤ëŠ˜ì˜ ê±´ê°• ë‰´ìŠ¤ë¥¼ ì „í•´ë“œë¦½ë‹ˆë‹¤", "ì´ìƒìœ¼ë¡œ ì „í•´ë“œë ¸ìŠµë‹ˆë‹¤"'
        ],
        preview: 'í•´ë‹¹ í†¤ìœ¼ë¡œ ë³€í™˜í•˜ë©´ <strong>ëª…í™•í•œ ë°œìŒê³¼ í•µì‹¬ ìœ„ì£¼ì˜ ê¸´ë°•í•œ ë¬¸ì²´</strong>ë¡œ ë‰´ìŠ¤ ì•µì»¤ ìŠ¤íƒ€ì¼ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤.',
        endingExamples: ['ì¤‘ìš”í•œ ì†Œì‹ì…ë‹ˆë‹¤', 'í™•ì¸í•´ë³´ì„¸ìš”', 'ì•Œì•„ì•¼ í• ', 'ì£¼ì˜í•´ì•¼ í• ', 'ì „í•´ë“œë ¸ìŠµë‹ˆë‹¤']
      }
    };

    // í†¤ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    function updateTonePreview() {
      var tone = document.getElementById('toneSelect').value;
      var previewEl = document.getElementById('tonePreview');
      if (!previewEl) return;

      var persona = tonePersonaMap[tone];
      if (persona && persona.preview) {
        previewEl.innerHTML = persona.preview;
        previewEl.classList.add('show');
      } else {
        previewEl.classList.remove('show');
      }
    }

    function buildTonePrefix(tone) {
      var persona = tonePersonaMap[tone];
      if (!persona) {
        persona = tonePersonaMap['senior-expert'];
      }

      var parts = [];
      
      // ê¸°ë³¸ ì§€ì‹œì‚¬í•­
      parts.push('2ë‹¨ê³„ì—ì„œ ë¶„ì„ëœ ì‹œë‹ˆì–´ ê±´ê°• ì „ë¬¸ê°€ì˜ í†¤ì•¤ë§¤ë„ˆë¥¼ ìœ ì§€í•˜ë©´ì„œ, ì‹œì²­ ì§€ì† ì‹œê°„ì„ ê·¹ëŒ€í™”í•  ìˆ˜ ìˆëŠ” ìì—°ìŠ¤ëŸ¬ìš´ êµ¬ì–´ì²´ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.');
      parts.push('');
      
      // í†¤ë³„ ìƒì„¸ ê·œì¹™ ì£¼ì…
      parts.push('=== ì„ íƒëœ í†¤ì•¤ë§¤ë„ˆ: ' + persona.name + ' ===');
      parts.push('');
      parts.push('ë‹¤ìŒ ê·œì¹™ì„ 100% ì¤€ìˆ˜í•˜ì—¬ ëŒ€ë³¸ì„ ì‘ì„±í•˜ì„¸ìš”:');
      persona.rules.forEach(function(rule) {
        parts.push('- ' + rule);
      });
      parts.push('');
      
      // ê°•ë ¥í•œ ì œì•½ ì‚¬í•­
      parts.push('=== í•„ìˆ˜ ì œì•½ ì‚¬í•­ ===');
      parts.push('1. ì„ íƒëœ í†¤ì•¤ë§¤ë„ˆì— ë”°ë¼ ì–´ë¯¸(Ending)ì™€ ì–´íœ˜(Vocabulary)ë¥¼ 100% ì¬êµ¬ì„±í•˜ì„¸ìš”.');
      parts.push('2. ì´ì „ í†¤ê³¼ ë‚´ìš©ì´ 70% ì´ìƒ ë‹¬ë¼ì•¼ í•˜ë©°, íŠ¹íˆ ë¬¸ì¥ ì¢…ê²° ì–´ë¯¸ë¥¼ í†¤ì— ë§ì¶° ì™„ì „íˆ ë°”ê¿”ì„œ ì¶œë ¥í•˜ì„¸ìš”.');
      parts.push('3. ë‹¤ìŒ ì–´ë¯¸ ì˜ˆì‹œë¥¼ ë°˜ë“œì‹œ ì‚¬ìš©í•˜ì„¸ìš”: ' + persona.endingExamples.join(', '));
      parts.push('4. í†¤ì— ë§ì§€ ì•ŠëŠ” ì–´ë¯¸ë‚˜ í‘œí˜„ì„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.');
      parts.push('5. ì „ì²´ ëŒ€ë³¸ì˜ 80% ì´ìƒì´ ì„ íƒëœ í†¤ì˜ ì–´ë¯¸ë¡œ ì¢…ê²°ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.');
      parts.push('');

      return parts.join('\n');
    }

    // í‚¤ì›Œë“œ íŒŒì‹± (ì‰¼í‘œë¡œ êµ¬ë¶„)
    function parseKeywords(keywordString) {
      if (!keywordString || !keywordString.trim()) return [];
      return keywordString
        .split(',')
        .map(function(k) { return k.trim(); })
        .filter(function(k) { return k.length > 0; });
    }

    // í‚¤ì›Œë“œ ê²€ì¦ (ëŒ€ë³¸ì— í¬í•¨ ì—¬ë¶€ í™•ì¸)
    function validateKeywords(script, keywords) {
      if (!keywords || keywords.length === 0) return { valid: true, missing: [] };
      
      var missing = [];
      keywords.forEach(function(keyword) {
        if (!script.includes(keyword)) {
          missing.push(keyword);
        }
      });
      
      return {
        valid: missing.length === 0,
        missing: missing
      };
    }

    // ìˆ˜ì¹˜ ë³´í˜¸ ì •ê·œì‹: ëŒ€ë³¸ ë‚´ ìˆ˜ì¹˜ ë°ì´í„° ì¶”ì¶œ
    var NUMERICAL_PATTERN = /\d+(\.\d+)?\s*(ë¶„|ì‹œê°„|km|m|kg|g|ë¦¬í„°|L|íšŒ|ê°œ|ë²ˆ|step|ë³´|ì„¸|ì‚´|%|ë„)/g;
    
    function extractNumericalData(text) {
      if (!text) return [];
      var matches = [];
      var match;
      while ((match = NUMERICAL_PATTERN.exec(text)) !== null) {
        matches.push(match[0].trim());
      }
      return matches;
    }

    // ìˆ˜ì¹˜ ê²€ì¦: ë³€í™˜ ì „í›„ ìˆ˜ì¹˜ ë¹„êµ
    function validateNumericalData(originalScript, generatedScript) {
      var originalNumerics = extractNumericalData(originalScript);
      var generatedNumerics = extractNumericalData(generatedScript);
      
      if (originalNumerics.length === 0) {
        return { valid: true, missing: [], extra: [] };
      }
      
      var missing = [];
      originalNumerics.forEach(function(numeric) {
        var found = generatedNumerics.some(function(gen) {
          return gen === numeric || gen.includes(numeric.split(/\s/)[0]);
        });
        if (!found) {
          missing.push(numeric);
        }
      });
      
      return {
        valid: missing.length === 0,
        missing: missing,
        original: originalNumerics,
        generated: generatedNumerics
      };
    }

    // ì‹¤ì œ API í˜¸ì¶œìš© í”„ë¡¬í”„íŠ¸ ìƒì„± (ë°±ì—”ë“œë¡œ ì „ì†¡)
    function buildApiPrompt(tone) {
      var persona = tonePersonaMap[tone] || tonePersonaMap['senior-expert'];
      var scenes = parseStorylineLines();
      
      // í˜•ì‹ ë° ê¸¸ì´ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      var format = currentFormat; // 'shorts' or 'longform'
      var duration = currentDuration; // '30s', '1m', etc.
      var targetMinutes = parseTargetDuration(duration);
      
      // í‚¤ì›Œë“œ ê°€ì ¸ì˜¤ê¸°
      var keywordsInput = document.getElementById('requiredKeywordsInput');
      var keywords = [];
      if (keywordsInput && keywordsInput.value.trim()) {
        keywords = parseKeywords(keywordsInput.value);
      } else if (requiredKeywords.length > 0) {
        keywords = requiredKeywords;
      }
      
      // í˜•ì‹ ë° ê¸¸ì´ì— ë”°ë¥¸ ì”¬ ê°œìˆ˜ ì¡°ì ˆ (ëª©í‘œ ë¶„ìˆ˜ Ã— 2)
      var sceneCount = scenes.length;
      if (format === 'shorts') {
        // ì‡¼ì¸ : 1ë¶„ = 5~6ê°œ ì”¬
        if (targetMinutes <= 1) {
          sceneCount = Math.max(5, Math.min(6, Math.round(targetMinutes * 5.5)));
        } else {
          sceneCount = Math.round(targetMinutes * 2);
        }
      } else {
        // ë¡±í¼: ëª©í‘œ ë¶„ìˆ˜ Ã— 2 (ìµœì†Œ 20ê°œ ì´ìƒ)
        sceneCount = Math.max(20, Math.round(targetMinutes * 2));
        // 40ë¶„ ì´ìƒì€ ìµœì†Œ 80ê°œ
        if (targetMinutes >= 60) {
          sceneCount = Math.max(120, sceneCount);
        } else if (targetMinutes >= 40) {
          sceneCount = Math.max(80, sceneCount);
        }
      }

      // ì”¬ ëª©ë¡ ì¡°ì • (ë°˜ë³µ ê¸ˆì§€: ë¹ˆ ì”¬ìœ¼ë¡œ í™•ì¥)
      var adjustedScenes = scenes.slice(0, sceneCount);
      if (targetMinutes >= 60) {
        adjustedScenes = [];
        for (var emptyIdx = 0; emptyIdx < 120; emptyIdx += 1) {
          adjustedScenes.push('');
        }
      } else if (adjustedScenes.length < sceneCount) {
        var startIndex = adjustedScenes.length;
        for (var si = startIndex; si < sceneCount; si += 1) {
          adjustedScenes.push('');
        }
      }
      
      // ë¡±í¼ ì„¹ì…˜í˜• êµ¬ì¡° ì—¬ë¶€ í™•ì¸ (40ë¶„ ì´ìƒ)
      var useChapterStructure = format === 'longform' && targetMinutes >= 40;
      var chapterCount = 0;
      var chapters = [];
      
      if (useChapterStructure) {
        // 60ë¶„: 12ê°œ ì±•í„° ê³ ì • (5ë¶„ì”©)
        if (targetMinutes >= 60) {
          chapterCount = 12;
        } else {
          // 40ë¶„ ì´ìƒ: 8ê°œ ì´ìƒì˜ ì „ë¬¸ì ì¸ ì„¹ì…˜ìœ¼ë¡œ êµ¬ì„±
          chapterCount = Math.max(8, Math.round(targetMinutes / 5)); // 5ë¶„ë‹¹ 1ê°œ ì„¹ì…˜
        }
        // ê° ì„¹ì…˜ì— í‚¤ì›Œë“œ ë°°ë¶„
        var keywordsPerChapter = Math.ceil(keywords.length / chapterCount);
        for (var i = 0; i < chapterCount; i++) {
          var chapterKeywords = [];
          for (var j = 0; j < keywordsPerChapter && (i * keywordsPerChapter + j) < keywords.length; j++) {
            chapterKeywords.push(keywords[i * keywordsPerChapter + j]);
          }
          chapters.push({
            chapterNum: i + 1,
            title: 'ì„¹ì…˜ ' + (i + 1),
            keywords: chapterKeywords.length > 0 ? chapterKeywords : keywords.slice(0, 1), // ìµœì†Œ 1ê°œ í‚¤ì›Œë“œ
            sceneCount: targetMinutes >= 60 ? 10 : Math.ceil(sceneCount / chapterCount) // ê° ì„¹ì…˜ë‹¹ ì”¬ ê°œìˆ˜
          });
        }
      }
      
      var prompt = {
        title: blueprint.title || '(ì œëª© ë¯¸ì •)',
        target: blueprint.target || '(íƒ€ê²Ÿ ë¯¸ì •)',
        hook: blueprint.hook || '(í›… ë¯¸ì •)',
        storyline: blueprint.storyline || '',
        scenes: adjustedScenes,
        sceneCount: sceneCount, // ëª©í‘œ ì”¬ ê°œìˆ˜
        requiredSceneCount: sceneCount, // í•„ìˆ˜ ì”¬ ê°œìˆ˜
        format: format, // 'shorts' or 'longform'
        duration: duration, // '30s', '1m', etc.
        targetMinutes: targetMinutes, // ëª©í‘œ ë¶„ëŸ‰ (ë¶„ ë‹¨ìœ„)
        targetWordCount: Math.round(targetMinutes * 160), // ëª©í‘œ ë‹¨ì–´ ìˆ˜ (1ë¶„ë‹¹ 160ë‹¨ì–´ ê¸°ì¤€)
        perSceneMinWords: targetMinutes >= 60 ? 200 : undefined,
        tone: tone,
        requiredKeywords: keywords, // í•„ìˆ˜ í‚¤ì›Œë“œ ì¶”ê°€
        useChapterStructure: useChapterStructure, // ì±•í„° êµ¬ì¡° ì‚¬ìš© ì—¬ë¶€
        chapterCount: chapterCount, // ì±•í„° ê°œìˆ˜
        chapters: chapters, // ì±•í„° ëª©ë¡
        tonePersona: {
          name: persona.name,
          rules: persona.rules,
          endingExamples: persona.endingExamples
        },
        constraints: [
          'ì„ íƒëœ í†¤ì•¤ë§¤ë„ˆì— ë”°ë¼ ì–´ë¯¸(Ending)ì™€ ì–´íœ˜(Vocabulary)ë¥¼ 100% ì¬êµ¬ì„±í•˜ì„¸ìš”.',
          'ì´ì „ í†¤ê³¼ ë‚´ìš©ì´ 70% ì´ìƒ ë‹¬ë¼ì•¼ í•˜ë©°, íŠ¹íˆ ë¬¸ì¥ ì¢…ê²° ì–´ë¯¸ë¥¼ í†¤ì— ë§ì¶° ì™„ì „íˆ ë°”ê¿”ì„œ ì¶œë ¥í•˜ì„¸ìš”.',
          'ì „ì²´ ëŒ€ë³¸ì˜ 80% ì´ìƒì´ ì„ íƒëœ í†¤ì˜ ì–´ë¯¸ë¡œ ì¢…ê²°ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.',
          'í†¤ì— ë§ì§€ ì•ŠëŠ” ì–´ë¯¸ë‚˜ í‘œí˜„ì„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.'
        ],
        formatInstructions: format === 'shorts' 
          ? 'ì‡¼ì¸  í˜•ì‹: ì„¸ë¡œí˜• ì˜ìƒì— ì í•©í•œ ë¹ ë¥¸ í˜¸í¡ì˜ ëŒ€ë³¸ì„ ì‘ì„±í•˜ì„¸ìš”. ê° ì”¬ì€ ì§§ê³  ì„íŒ©íŠ¸ ìˆê²Œ êµ¬ì„±í•˜ë©°, ì‹œì²­ìì˜ ì£¼ì˜ë¥¼ ì¦‰ì‹œ ëŒ ìˆ˜ ìˆëŠ” ê°•ë ¬í•œ ë¬¸ì¥ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”.'
          : (useChapterStructure 
            ? 'ë¡±í¼ í˜•ì‹ (ì„¹ì…˜í˜• êµ¬ì¡°): ê¹Šì´ ìˆëŠ” ì •ë³´ ì „ë‹¬ ìœ„ì£¼ì˜ ëŒ€ë³¸ì„ ì‘ì„±í•˜ì„¸ìš”. ë¨¼ì € ì „ì²´ ëª©ì°¨(ì±•í„°)ë¥¼ ë§Œë“¤ê³ , ê° ì±•í„°ë³„ë¡œ ëŒ€ë³¸ì„ ìƒì„±í•˜ì—¬ í•©ì¹˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. ê° ì„¹ì…˜ì€ ë…ë¦½ì ì¸ ì£¼ì œì™€ í•µì‹¬ í‚¤ì›Œë“œë¥¼ ê°€ì§€ë©°, ì„œë¡ -ë³¸ë¡ (ì„¹ì…˜ 1,2,3...)-ê²°ë¡ ì˜ ê³„ì¸µ êµ¬ì¡°ë¡œ êµ¬ì„±í•˜ì„¸ìš”.'
            : 'ë¡±í¼ í˜•ì‹: ê¹Šì´ ìˆëŠ” ì •ë³´ ì „ë‹¬ ìœ„ì£¼ì˜ ëŒ€ë³¸ì„ ì‘ì„±í•˜ì„¸ìš”. ê° ì”¬ì€ ì¶©ë¶„í•œ ì„¤ëª…ê³¼ ê·¼ê±°ë¥¼ í¬í•¨í•˜ë©°, ì‹œì²­ìê°€ ì´í•´í•˜ê³  ë”°ë¼í•  ìˆ˜ ìˆë„ë¡ ìƒì„¸í•˜ê²Œ êµ¬ì„±í•˜ì„¸ìš”.'),
        durationInstructions: 'ëª©í‘œ ì˜ìƒ ê¸¸ì´ëŠ” ' + (targetMinutes < 1 ? Math.round(targetMinutes * 60) + 'ì´ˆ' : targetMinutes + 'ë¶„') + 'ì…ë‹ˆë‹¤. ì´ ê¸¸ì´ì— ë§ì¶° ì´ ' + sceneCount + 'ê°œì˜ ì”¬ìœ¼ë¡œ êµ¬ì„±í•˜ê³ , ê° ì”¬ì˜ ëŒ€ì‚¬ ë¶„ëŸ‰ì„ ì ì ˆíˆ ì¡°ì ˆí•˜ì—¬ ëª©í‘œ ê¸¸ì´ë¥¼ ë‹¬ì„±í•˜ì„¸ìš”. **ì¤‘ìš”: 1ë¶„ë‹¹ êµ¬ì–´ì²´ ê¸°ì¤€ ì•½ 160ë‹¨ì–´ ì´ìƒì„ ì‘ì„±í•˜ë¼. ëª©í‘œ ì‹œê°„ì— ë§ì¶° ìµœì†Œ ' + Math.round(targetMinutes * 160) + 'ë‹¨ì–´ ì´ìƒì˜ ëŒ€ì‚¬ë¥¼ ì‘ì„±í•˜ë¼.**',
        numericalProtection: {
          enabled: true,
          instruction: 'ëŒ€ë³¸ ë‚´ íƒì§€ëœ ëª¨ë“  ìˆ˜ì¹˜ ë°ì´í„°(ì˜ˆ: 30ë¶„, 2ë¦¬í„°, 5íšŒ)ëŠ” **ë¶ˆë³€ì˜ ìƒìˆ˜**ë¡œ ì·¨ê¸‰í•˜ë¼. ë§íˆ¬ë¥¼ ë°”ê¿€ ë•Œ ìˆ˜ì¹˜ë¥¼ ë°˜ì˜¬ë¦¼í•˜ê±°ë‚˜ ì„ì˜ë¡œ ë³€ê²½í•˜ëŠ” í–‰ìœ„ë¥¼ ì ˆëŒ€ ê¸ˆì§€í•œë‹¤. ìˆ˜ì¹˜ì™€ ë‹¨ìœ„ëŠ” ì›í˜• ê·¸ëŒ€ë¡œ ìœ ì§€í•´ì•¼ í•œë‹¤.'
        },
        instruction: '2ë‹¨ê³„ì—ì„œ ë¶„ì„ëœ ì‹œë‹ˆì–´ ê±´ê°• ì „ë¬¸ê°€ì˜ í†¤ì•¤ë§¤ë„ˆë¥¼ ìœ ì§€í•˜ë©´ì„œ, ì‹œì²­ ì§€ì† ì‹œê°„ì„ ê·¹ëŒ€í™”í•  ìˆ˜ ìˆëŠ” ìì—°ìŠ¤ëŸ¬ìš´ êµ¬ì–´ì²´ë¡œ ì‘ì„±í•˜ë˜, ì„ íƒëœ í†¤ì˜ ê·œì¹™ì„ 100% ì¤€ìˆ˜í•˜ì—¬ ì‘ì„±í•˜ì„¸ìš”.'
      };

      return prompt;
    }

    var antigravityAbortController = null;
    var antigravityStopRequested = false;
    var longformState = {
      totalScenes: 120,
      completedScenes: 0,
      totalChapters: 12
    };

    function initLongformDashboard() {
      var dashboard = document.getElementById('longformDashboard');
      var indicatorWrap = document.getElementById('chapterIndicators');
      if (dashboard) dashboard.style.display = 'block';
      if (indicatorWrap) {
        indicatorWrap.innerHTML = '';
        for (var i = 0; i < longformState.totalChapters; i += 1) {
          var el = document.createElement('div');
          el.className = 'chapter-indicator';
          indicatorWrap.appendChild(el);
        }
      }
      updateLongformDashboard();
    }

    function updateLongformDashboard() {
      var fill = document.getElementById('longformProgressFill');
      var text = document.getElementById('longformProgressText');
      var durationText = document.getElementById('longformDurationText');
      var indicators = document.querySelectorAll('#chapterIndicators .chapter-indicator');
      var percent = longformState.totalScenes > 0
        ? Math.min(100, Math.round((longformState.completedScenes / longformState.totalScenes) * 100))
        : 0;
      if (fill) fill.style.width = percent + '%';
      if (text) text.textContent = longformState.completedScenes + '/' + longformState.totalScenes + ' ì”¬ ìƒì„± ì¤‘...';
      if (durationText) {
        var editor = document.getElementById('scriptEditor');
        var words = editor ? editor.value.trim().split(/\s+/).filter(function(w) { return w.length > 0; }).length : 0;
        var estimatedMinutes = Math.round(words / 160);
        durationText.textContent = 'ì˜ˆìƒ ê¸¸ì´: ' + estimatedMinutes + 'ë¶„';
      }
      if (indicators && indicators.length > 0) {
        var doneChapters = Math.floor(longformState.completedScenes / 10);
        indicators.forEach(function(ind, idx) {
          ind.classList.remove('active', 'done');
          if (idx < doneChapters) {
            ind.classList.add('done');
          } else if (idx === doneChapters) {
            ind.classList.add('active');
          }
        });
      }
    }

    function incrementLongformProgress(count) {
      longformState.completedScenes = Math.min(longformState.totalScenes, longformState.completedScenes + count);
      updateLongformDashboard();
    }

    function resetLongformProgress() {
      longformState.completedScenes = 0;
      updateLongformDashboard();
    }

    function statusLog(message) {
      var windowEl = document.getElementById('statusWindow');
      var bodyEl = document.getElementById('statusWindowBody');
      if (!windowEl || !bodyEl) return;
      windowEl.style.display = 'block';
      var line = document.createElement('div');
      line.className = 'status-window-line';
      line.textContent = message;
      bodyEl.appendChild(line);
      bodyEl.scrollTop = bodyEl.scrollHeight;
    }

    function statusReplace(message) {
      var bodyEl = document.getElementById('statusWindowBody');
      if (!bodyEl) return;
      bodyEl.innerHTML = '';
      statusLog(message);
    }

    function wait(ms) {
      return new Promise(function(resolve) {
        setTimeout(resolve, ms);
      });
    }

    async function postJsonWithRetry(url, payload, attempts, label) {
      var lastError = null;
      for (var attempt = 1; attempt <= attempts; attempt += 1) {
        try {
          var response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            signal: antigravityAbortController ? antigravityAbortController.signal : undefined
          });
          if (!response.ok) {
            var errText = '';
            try {
              var errData = await response.json();
              if (errData && errData.error) {
                errText = errData.error;
              } else {
                errText = JSON.stringify(errData);
              }
            } catch (e) {
              try {
                errText = await response.text();
              } catch (e2) {}
            }
            throw new Error((label || 'API') + ' ì‘ë‹µ ì‹¤íŒ¨: ' + response.status + (errText ? ' - ' + errText : ''));
          }
          return await response.json();
        } catch (err) {
          lastError = err;
          statusReplace((label || 'API') + ' ì¬ì‹œë„ ì¤‘... (' + attempt + '/' + attempts + ')');
          await wait(800);
        }
      }
      throw lastError || new Error((label || 'API') + ' ìš”ì²­ ì‹¤íŒ¨');
    }

    async function splitAndDispatchToAntigravity(apiPrompt, overrides, requestFn) {
      var payload = {
        title: apiPrompt.title,
        storyline: apiPrompt.storyline,
        requiredKeywords: apiPrompt.requiredKeywords || [],
        targetMinutes: apiPrompt.targetMinutes,
        requiredSceneCount: apiPrompt.requiredSceneCount,
        tone: apiPrompt.tone,
        format: apiPrompt.format
      };
      if (overrides) {
        if (overrides.sectionCountOverride) payload.sectionCountOverride = overrides.sectionCountOverride;
        if (overrides.scenesPerSectionOverride) payload.scenesPerSectionOverride = overrides.scenesPerSectionOverride;
      }

      if (apiPrompt.targetMinutes >= 60) {
        var sectionCount = 12;
        var scenesPerSection = 10;
        var previousContext = '';
        var collectedScripts = [];

        statusReplace('[1/' + sectionCount + '] ì±•í„° ìƒì„± ëŒ€ê¸°...');

        for (var i = 0; i < sectionCount; i += 1) {
          if (antigravityStopRequested) break;

          statusReplace('[' + (i + 1) + '/' + sectionCount + '] ì±•í„° ìƒì„± ì¤‘... (5ë¶„ ë‹¨ìœ„)');
          var keywordLine = (apiPrompt.requiredKeywords && apiPrompt.requiredKeywords.length > 0)
            ? ('í•„ìˆ˜ í‚¤ì›Œë“œ: ' + apiPrompt.requiredKeywords.join(', ') + ' (ë³€í˜• ê¸ˆì§€)')
            : 'í•„ìˆ˜ í‚¤ì›Œë“œ ì—†ìŒ';
          var seniorExpertTone = {
            name: 'ì‹œë‹ˆì–´ ê±´ê°• ì „ë¬¸ê°€',
            rules: [
              'ì‹ ë¢°ê° ìˆëŠ” ì „ë¬¸ ìš©ì–´ë¥¼ ì‚¬ìš©í•˜ë˜, ë¬¸ì¥ ëì€ ê²©ì‹ì²´ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.',
              'ì˜í•™ì  ìš©ì–´ëŠ” ì´í•´í•˜ê¸° ì‰½ê²Œ í’€ì–´ ì„¤ëª…í•©ë‹ˆë‹¤.',
              'ì¡´ëŒ“ë§ì„ ì¼ê´€ë˜ê²Œ ìœ ì§€í•©ë‹ˆë‹¤.',
              'ì°¨ë¶„í•˜ê³  ì‹ ë¢°ê° ìˆê²Œ ì „ë‹¬í•©ë‹ˆë‹¤.'
            ]
          };
          var segmentPrompt = Object.assign({}, apiPrompt, {
            targetMinutes: 5,
            requiredSceneCount: scenesPerSection,
            sectionTitle: 'ì„¹ì…˜ ' + (i + 1),
            sectionIndex: i + 1,
            totalSections: sectionCount,
            previous_context: previousContext,
            systemInstruction: 'ë„ˆëŠ” ì‹œë‹ˆì–´ ê±´ê°• ì „ë¬¸ê°€ë‹¤. êµ¬ì–´ì²´ë¡œ ëŒ€ì‚¬ë§Œ ì‘ì„±í•˜ë¼. 12íšŒ ë¦´ë ˆì´ ì¤‘ ë™ì¼ í†¤ì„ ìœ ì§€í•˜ë¼.',
            tonePersona: seniorExpertTone,
            instruction: (apiPrompt.instruction ? apiPrompt.instruction + '\n' : '') +
              'ì‹œë‹ˆì–´ ê±´ê°• ì „ë¬¸ê°€ êµ¬ì–´ì²´ ì§€ì¹¨ì„ ìµœìš°ì„ ìœ¼ë¡œ ì ìš©í•˜ë¼.\në„ˆëŠ” ì‹œë‹ˆì–´ ê±´ê°• ì „ë¬¸ê°€ë‹¤. êµ¬ì–´ì²´ë¡œ ëŒ€ì‚¬ë§Œ ì‘ì„±í•˜ë¼.\n' +
              keywordLine + '\n' +
              (previousContext
                ? '[ì‹œì‘ ë¬¸ì¥ ê°€ì´ë“œ] ' + previousContext + '\në‹¹ì‹ ì€ ì´ì „ ì¥ë©´ì— ì´ì–´ì§€ëŠ” ë‚´ìš©ì„ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤. ë°˜ë“œì‹œ [ì‹œì‘ ë¬¸ì¥ ê°€ì´ë“œ]ì˜ íë¦„ê³¼ í†¤ì„ ìœ ì§€í•˜ë©° ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€ì‚¬ë¥¼ ì‹œì‘í•˜ì‹­ì‹œì˜¤.'
                : '')
          });

          console.log('[Generate Script Segment] request:', segmentPrompt);
          antigravityAbortController = new AbortController();
          var segmentData = requestFn
            ? await requestFn(segmentPrompt)
            : await postJsonWithRetry('/api/generate-script', segmentPrompt, 3, 'Generate Script Segment');
          console.log('[Generate Script Segment] response:', segmentData);

          var segmentScript = segmentData.script || '';
          collectedScripts.push(segmentScript);
          previousContext = segmentData.last_two_sentences || getLastSentence(segmentScript) || previousContext;
          incrementLongformProgress(segmentData.scene_count || scenesPerSection);

          // ì‹¤ì‹œê°„ ëŒ€ë³¸ ë°˜ì˜ ë° ë¶„ëŸ‰ ê°±ì‹ 
          var editorEl = document.getElementById('scriptEditor');
          var currentScript = collectedScripts.join('\n\n');
          if (editorEl) {
            editorEl.value = cleanScriptForDisplay(currentScript);
          }
          updateDurationGauge();
        }

        statusReplace('ì±•í„° ìƒì„± ì™„ë£Œ');
        return { script: collectedScripts.join('\n\n') };
      }

      console.log('[Antigravity Test] request payload:', payload);
      antigravityAbortController = new AbortController();
      var data = await postJsonWithRetry('/api/antigravity/dispatch', payload, 3, 'Antigravity Dispatch');
      console.log('[Antigravity Test] response data:', data);
      return data;
    }

    var antigravityProgressTimer = null;
    function startAntigravityProgress(totalScenes) {
      var durationGauge = document.getElementById('durationGauge');
      var durationText = document.getElementById('durationText');
      if (durationGauge && durationText) {
        durationGauge.className = 'duration-gauge warning';
      }
      var completed = 0;
      if (durationText) {
        durationText.innerHTML = 'í˜„ì¬ ë¶„ëŸ‰ ë³´ê°• ì¤‘... (' + completed + '/' + totalScenes + ' ì”¬ ì™„ë£Œ)';
      }
      if (antigravityProgressTimer) {
        clearInterval(antigravityProgressTimer);
      }
      antigravityProgressTimer = setInterval(function() {
        if (completed < totalScenes) {
          completed += 1;
          if (durationText) {
            durationText.innerHTML = 'í˜„ì¬ ë¶„ëŸ‰ ë³´ê°• ì¤‘... (' + completed + '/' + totalScenes + ' ì”¬ ì™„ë£Œ)';
          }
        }
      }, 2000);
    }

    function stopAntigravityProgress(totalScenes) {
      if (antigravityProgressTimer) {
        clearInterval(antigravityProgressTimer);
        antigravityProgressTimer = null;
      }
      var durationGauge = document.getElementById('durationGauge');
      var durationText = document.getElementById('durationText');
      if (durationGauge && durationText) {
        durationGauge.className = 'duration-gauge success';
        durationText.innerHTML = 'í˜„ì¬ ë¶„ëŸ‰ ë³´ê°• ì¤‘... (' + totalScenes + '/' + totalScenes + ' ì”¬ ì™„ë£Œ)';
      }
    }

    function cleanScriptForDisplay(script) {
      return String(script || '')
        .replace(/^\[ì”¬\s*\d+\]\s*/gm, '')
        .replace(/ì—­í• :.*$/gm, '')
        .replace(/ì§€ì‹œì‚¬í•­:.*$/gm, '')
        .replace(/ì¸ì‚¬ì´íŠ¸:.*$/gm, '')
        .replace(/ì´ ë¶€ë¶„ì—ì„œëŠ”.*$/gm, '')
        .replace(/ì•Œê² ìŠµë‹ˆë‹¤[.!]?/gm, '')
        .replace(/ì‘ì„±ëœ ëŒ€ë³¸ì…ë‹ˆë‹¤[.!]?/gm, '')
        .trim();
    }

    function showApiConnectionError(message) {
      var validationEl = document.getElementById('keywordValidation');
      if (!validationEl) return;
      validationEl.className = 'keyword-validation';
      validationEl.style.color = '#ef4444';
      validationEl.style.fontWeight = '700';
      validationEl.textContent = message || 'API ì—°ê²° í™•ì¸ í•„ìš”';
    }

    function scanAndRegenerateInvalidScenes(script, apiPrompt) {
      var forbidden = ['ì§€ì‹œì‚¬í•­', 'ì—­í• ', 'ì´ ë¶€ë¶„ì—ì„œëŠ”', 'ì¸ì‚¬ì´íŠ¸'];
      var scenes = parseScenesFromScript(script);
      var invalidIndexes = [];
      scenes.forEach(function(scene, idx) {
        if (forbidden.some(function(word) { return scene.script.includes(word); })) {
          invalidIndexes.push(idx);
        }
      });

      if (invalidIndexes.length === 0) {
        return Promise.resolve(script);
      }

      return invalidIndexes.reduce(function(chain, idx) {
        return chain.then(async function(currentScript) {
          var currentScenes = parseScenesFromScript(currentScript);
          var prevSceneText = idx > 0 ? currentScenes[idx - 1].script : '';
          var prevSentence = getLastSentence(prevSceneText);
          var regenPrompt = Object.assign({}, apiPrompt);
          regenPrompt.targetMinutes = 1;
          regenPrompt.requiredSceneCount = 1;
          var regenResult = await splitAndDispatchToAntigravity(regenPrompt, {
            sectionCountOverride: 1,
            scenesPerSectionOverride: 1
          });
          if (regenResult && regenResult.script) {
            currentScenes[idx].script = regenResult.script.replace(/^\[ì”¬\s*\d+\]\s*/g, '').trim();
          }
          return rebuildScriptFromScenes(currentScenes);
        });
      }, Promise.resolve(script));
    }

    function parseScenesFromScript(script) {
      var lines = String(script || '').split(/\r?\n/);
      var scenes = [];
      var current = null;
      lines.forEach(function(line) {
        var match = line.match(/^\[ì”¬\s*(\d+)\]\s*(.*)$/);
        if (match) {
          if (current) scenes.push(current);
          current = { sceneNum: Number(match[1]), script: match[2] || '' };
        } else if (current) {
          current.script += (current.script ? '\n' : '') + line;
        }
      });
      if (current) scenes.push(current);
      return scenes;
    }

    function rebuildScriptFromScenes(scenes) {
      return scenes.map(function(scene, idx) {
        var num = idx + 1;
        return '[ì”¬ ' + num + '] ' + scene.script;
      }).join('\n');
    }

    function getLastSentence(text) {
      var sentences = String(text || '').split(/(?<=[.!?ã€‚ï¼ï¼Ÿ])\s+/).filter(Boolean);
      if (!sentences.length) return '';
      return sentences[sentences.length - 1];
    }

    async function runAntigravityTest5Min() {
      var tone = document.getElementById('toneSelect')?.value || 'senior-expert';
      var apiPrompt = buildApiPrompt(tone);
      apiPrompt.targetMinutes = 5;
      apiPrompt.requiredSceneCount = 10;
      apiPrompt.format = 'longform';

      startAntigravityProgress(10);
      var data = await splitAndDispatchToAntigravity(apiPrompt, {
        sectionCountOverride: 2,
        scenesPerSectionOverride: 5
      });
      stopAntigravityProgress(10);

      if (data && data.script) {
        document.getElementById('scriptEditor').value = data.script;
        updateDurationGauge();
      }
    }

    function renderScenePreview() {
      var grid = document.getElementById('sceneGrid');
      if (!grid) return;
      var scenes = parseStorylineLines();
      grid.innerHTML = scenes
        .map(function(scene, idx) {
          return (
            '<div class="scene-card">' +
            '<div class="scene-title">ì”¬ ' +
            (idx + 1) +
            '</div>' +
            '<div class="scene-body">' +
            scene +
            '</div>' +
            '</div>'
          );
        })
        .join('');
    }

    // ì˜ìƒ í˜•ì‹ ë° ê¸¸ì´ ì„ íƒ ë³€ìˆ˜
    var currentFormat = 'shorts'; // 'shorts' or 'longform'
    var currentDuration = '1m'; // '30s', '1m', '2m', '3m', '5m', '10m', '20m', '30m', '40m', '50m', '60m'

    // í˜•ì‹ë³„ ê¸¸ì´ ì˜µì…˜
    var durationOptions = {
      shorts: [
        { value: '30s', label: '30ì´ˆ' },
        { value: '1m', label: '1ë¶„' },
        { value: '2m', label: '2ë¶„' },
        { value: '3m', label: '3ë¶„' }
      ],
      longform: [
        { value: '5m', label: '5ë¶„' },
        { value: '10m', label: '10ë¶„' },
        { value: '20m', label: '20ë¶„' },
        { value: '30m', label: '30ë¶„' },
        { value: '40m', label: '40ë¶„' },
        { value: '50m', label: '50ë¶„' },
        { value: '60m', label: '60ë¶„' }
      ]
    };

    // í˜•ì‹ ì„ íƒ í† ê¸€
    function initFormatToggle() {
      var formatShorts = document.getElementById('formatShorts');
      var formatLongform = document.getElementById('formatLongform');
      var durationSelect = document.getElementById('durationSelect');

      if (formatShorts && formatLongform) {
        formatShorts.addEventListener('click', function() {
          currentFormat = 'shorts';
          formatShorts.classList.add('active');
          formatLongform.classList.remove('active');
          updateDurationOptions();
        });

        formatLongform.addEventListener('click', function() {
          currentFormat = 'longform';
          formatLongform.classList.add('active');
          formatShorts.classList.remove('active');
          updateDurationOptions();
        });
      }
    }

    // ê¸¸ì´ ì˜µì…˜ ë™ì  ì—…ë°ì´íŠ¸
    function updateDurationOptions() {
      var durationSelect = document.getElementById('durationSelect');
      if (!durationSelect) return;

      var options = durationOptions[currentFormat];
      durationSelect.innerHTML = '';
      
      options.forEach(function(opt) {
        var option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label;
        durationSelect.appendChild(option);
      });

      // ì²« ë²ˆì§¸ ì˜µì…˜ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
      if (options.length > 0) {
        currentDuration = options[0].value;
        durationSelect.value = currentDuration;
        updateTargetDuration();
      }
    }

    // ëª©í‘œ ê¸¸ì´ ì—…ë°ì´íŠ¸
    function updateTargetDuration() {
      var targetEl = document.getElementById('targetDuration');
      if (targetEl) {
        var durationLabel = durationOptions[currentFormat].find(function(opt) {
          return opt.value === currentDuration;
        });
        if (durationLabel) {
          targetEl.textContent = durationLabel.label;
        }
      }
    }

    // ê¸¸ì´ ì„ íƒ ì´ë²¤íŠ¸
    function initDurationSelect() {
      var durationSelect = document.getElementById('durationSelect');
      if (durationSelect) {
        durationSelect.addEventListener('change', function() {
          currentDuration = this.value;
          updateTargetDuration();
          updateDurationGauge();
        });
      }
    }

    // ë¶„ëŸ‰ ê³„ì‚° (ì”¬ ê°œìˆ˜ ê¸°ì¤€: ì”¬ë‹¹ 30ì´ˆ)
    function calculateScriptDuration(script) {
      if (!script || !script.trim()) return 0;
      var scenes = script
        .split(/\n{2,}/)
        .map(function(s) { return s.trim(); })
        .filter(function(s) { return s.length > 0; });
      var sceneCount = scenes.length;
      return (sceneCount * 30) / 60; // ë¶„ ë‹¨ìœ„
    }

    // ë¶„ëŸ‰ì„ ì´ˆ/ë¶„ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    function formatDuration(minutes) {
      if (minutes < 1) {
        return Math.round(minutes * 60) + 'ì´ˆ';
      } else {
        var mins = Math.floor(minutes);
        var secs = Math.round((minutes - mins) * 60);
        if (secs === 60) {
          mins += 1;
          secs = 0;
        }
        if (secs === 0) {
          return mins + 'ë¶„';
        } else {
          return mins + 'ë¶„ ' + secs + 'ì´ˆ';
        }
      }
    }

    // ëª©í‘œ ê¸¸ì´ë¥¼ ë¶„ ë‹¨ìœ„ë¡œ ë³€í™˜
    function parseTargetDuration(durationStr) {
      if (durationStr.endsWith('s')) {
        return parseInt(durationStr) / 60; // ì´ˆë¥¼ ë¶„ìœ¼ë¡œ
      } else if (durationStr.endsWith('m')) {
        return parseInt(durationStr); // ë¶„
      }
      return 1; // ê¸°ë³¸ê°’
    }

    // ë¶„ëŸ‰ ê²Œì´ì§€ ì—…ë°ì´íŠ¸
    function updateDurationGauge() {
      var scriptEditor = document.getElementById('scriptEditor');
      var durationGauge = document.getElementById('durationGauge');
      var durationText = document.getElementById('durationText');
      
      if (!scriptEditor || !durationGauge || !durationText) return;

      var script = scriptEditor.value;
      var currentMinutes = calculateScriptDuration(script);
      var targetMinutes = parseTargetDuration(currentDuration);
      
      var currentFormatted = formatDuration(currentMinutes);
      var targetFormatted = durationOptions[currentFormat].find(function(opt) {
        return opt.value === currentDuration;
      });
      if (targetFormatted) {
        targetFormatted = targetFormatted.label;
      } else {
        targetFormatted = currentDuration;
      }

      durationText.innerHTML = 'í˜„ì¬ ë¶„ëŸ‰: <strong>' + currentFormatted + '</strong> / ëª©í‘œ: <strong>' + targetFormatted + '</strong>';

      // ê²Œì´ì§€ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
      durationGauge.className = 'duration-gauge';
      var diff = Math.abs(currentMinutes - targetMinutes);
      var tolerance = targetMinutes * 0.2; // 20% í—ˆìš© ì˜¤ì°¨

      if (currentMinutes === 0) {
        // ëŒ€ë³¸ì´ ì—†ì„ ë•Œ
        durationGauge.className = 'duration-gauge';
      } else if (diff <= tolerance) {
        // ëª©í‘œ ë²”ìœ„ ë‚´
        durationGauge.classList.add('success');
      } else if (currentMinutes < targetMinutes * 0.5 || currentMinutes > targetMinutes * 1.5) {
        // ë„ˆë¬´ ì§§ê±°ë‚˜ ê¸¸ ë•Œ
        durationGauge.classList.add('error');
      } else {
        // ê²½ê³  ë²”ìœ„
        durationGauge.classList.add('warning');
      }
    }

    // ë²„íŠ¼ ë° ì´ˆê¸° ë Œë”
    (function initPage() {
      renderRecap();
      renderScenePreview();

      // í˜•ì‹ ë° ê¸¸ì´ ì„ íƒ ì´ˆê¸°í™”
      initFormatToggle();
      initDurationSelect();
      updateDurationOptions();
      updateTargetDuration();

      // ëŒ€ë³¸ ì—ë””í„° ì…ë ¥ ì‹œ ë¶„ëŸ‰ ê²Œì´ì§€ ì—…ë°ì´íŠ¸
      var scriptEditor = document.getElementById('scriptEditor');
      if (scriptEditor) {
        scriptEditor.addEventListener('input', function() {
          updateDurationGauge();
        });
      }

      var stopBtn = document.getElementById('btnStopAndSave');
      if (stopBtn) {
        stopBtn.addEventListener('click', function() {
          antigravityStopRequested = true;
          if (antigravityAbortController) {
            antigravityAbortController.abort();
          }
          var scriptText = document.getElementById('scriptEditor').value.trim();
          var payload = {
            script: scriptText,
            tone: document.getElementById('toneSelect').value,
            format: currentFormat,
            duration: currentDuration,
            targetMinutes: parseTargetDuration(currentDuration),
            savedAt: new Date().toISOString()
          };
          localStorage.setItem('step3InterruptedScript', JSON.stringify(payload));
          alert('ìƒì„±ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ ê²°ê³¼ë¬¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
      }

      // í†¤ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
      var toneSelect = document.getElementById('toneSelect');
      if (toneSelect) {
        toneSelect.addEventListener('change', function() {
          updateTonePreview();
        });
        // ì´ˆê¸° ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        updateTonePreview();
      }

      // Antigravity 5ë¶„ í…ŒìŠ¤íŠ¸: URLì— ?ag_test=1ì´ë©´ ìë™ ì‹¤í–‰
      try {
        if (window.location.search.includes('ag_test=1')) {
          runAntigravityTest5Min();
        }
      } catch (e) {}

      // í‚¤ì›Œë“œ ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸
      var keywordsInput = document.getElementById('requiredKeywordsInput');
      if (keywordsInput) {
        keywordsInput.addEventListener('input', function() {
          var keywords = parseKeywords(this.value);
          requiredKeywords = keywords;
          // ê²€ì¦ ë©”ì‹œì§€ ì´ˆê¸°í™”
          var validationEl = document.getElementById('keywordValidation');
          if (validationEl) {
            validationEl.className = 'keyword-validation';
            validationEl.textContent = '';
          }
        });
      }

      var btnGen = document.getElementById('btnGenerateScript');
      if (btnGen) {
        btnGen.addEventListener('click', async function() {
          // í‚¤ì›Œë“œ ê°€ì ¸ì˜¤ê¸° (id í†µí•© ì§€ì›)
          var keywordsInput = document.getElementById('required-keywords-input') ||
            document.getElementById('requiredKeywordsInput');
          var requiredKeywords = [];
          if (keywordsInput && keywordsInput.value.trim()) {
            requiredKeywords = parseKeywords(keywordsInput.value);
          }
          var keywords = requiredKeywords;

          alert('ëŒ€ë³¸ ì—”ì§„ ê°€ë™!');
          var tone = document.getElementById('toneSelect').value;
          
          if (keywords.length === 0) {
            if (!confirm('í•„ìˆ˜ í‚¤ì›Œë“œê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ëŒ€ë³¸ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
              return;
            }
          }
          
          // ë¡œë”© ìƒíƒœ í‘œì‹œ
          btnGen.disabled = true;
          btnGen.textContent = 'AI ëŒ€ë³¸ ìƒì„± ì¤‘...';
          
          var validationEl = document.getElementById('keywordValidation');
          if (validationEl) {
            validationEl.className = 'keyword-validation';
            validationEl.textContent = '';
          }
          
          try {
            // ì‹¤ì œ API í˜¸ì¶œ (ë°±ì—”ë“œ)
            var apiPrompt = buildApiPrompt(tone);
            
            // ì›ë³¸ ëŒ€ë³¸ ì¶”ê°€ (ìˆ˜ì¹˜ ë³´í˜¸ìš©)
            var originalScript = step3Data && step3Data.script ? step3Data.script : '';
            if (originalScript) {
              apiPrompt.originalScript = originalScript;
            }

            var refinementAttempt = 0;
            var maxRefine = 1;

            async function requestScript(promptPayload) {
              return postJsonWithRetry('/api/generate-script', promptPayload, 3, 'Script API');
            }

            // 60ë¶„ ë°°ì¹˜ ìƒì„± ì§„í–‰ ìƒíƒœ í‘œì‹œ
            if (apiPrompt.targetMinutes >= 60) {
              longformState.totalChapters = 12;
              longformState.totalScenes = 120;
              resetLongformProgress();
              initLongformDashboard();
              startAntigravityProgress(longformState.totalScenes);
            }

            var data = null;
            if (apiPrompt.targetMinutes >= 60) {
              // í„°ë¯¸ë„ ë¡œê·¸: Antigravity ì „ì†¡ í™•ì¸
              try {
                await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/antigravity/log', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    message: '[SYSTEM] ì•ˆí‹°ê·¸ë ˆì´ë¹„í‹° ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡ ì‹œì‘'
                  })
                });
                if (apiPrompt.targetMinutes >= 60) {
                  await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/antigravity/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      message: '[SYSTEM] 60ë¶„ ëŒ€ë³¸ ìƒì„± ì‹œí€€ìŠ¤ ì‹œì‘...'
                    })
                  });
                }
              } catch (e) {}
              data = await splitAndDispatchToAntigravity(apiPrompt, null, requestScript);
            } else {
              data = await requestScript(apiPrompt);
            }
            var script = '';
            var validation = { valid: true, missing: [] };
            var numericalValidation = { valid: true, missing: [] };

            if (!data || !data.script) {
              throw new Error('API ì‘ë‹µì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
            }
            script = data.script;

            // ë¶„ëŸ‰ ìë™ ë³´ê°• (1íšŒ)
            if (data && data.needs_refine && refinementAttempt < maxRefine) {
              refinementAttempt += 1;
              var durationGauge = document.getElementById('durationGauge');
              var durationText = document.getElementById('durationText');
              if (durationGauge && durationText) {
                durationGauge.className = 'duration-gauge refining';
                durationText.innerHTML = 'ë¶„ëŸ‰ì´ ë¶€ì¡±í•˜ì—¬ AIê°€ ë‚´ìš©ì„ ë³´ê°•í•˜ê³  ìˆìŠµë‹ˆë‹¤... (1/1íšŒ)';
              }

              apiPrompt.refinementInstruction = 'í˜„ì¬ ëŒ€ë³¸ì˜ ë…¼ë¦¬ êµ¬ì¡°ëŠ” ìœ ì§€í•˜ë˜, ê° ì”¬(Scene)ë³„ë¡œ ì‹œë‹ˆì–´ë“¤ì´ ì´í•´í•˜ê¸° ì‰¬ìš´ êµ¬ì²´ì ì¸ ì‚¬ë¡€ì™€ ì¶”ê°€ ì„¤ëª…ì„ ë§ë¶™ì—¬ ë¶„ëŸ‰ì„ 2ë°°ë¡œ í™•ì¥í•˜ë¼.';
              apiPrompt.refinementAttempt = refinementAttempt;
              var refinedData = apiPrompt.targetMinutes >= 10
                ? await splitAndDispatchToAntigravity(apiPrompt)
                : await requestScript(apiPrompt);
              if (refinedData && refinedData.script) {
                data = refinedData;
                script = refinedData.script;
              }
            }

            // ë°ì´í„° ë¬´ê²°ì„± ê²€ì‚¬ ë° ì¬ìƒì„±
            if (apiPrompt.targetMinutes >= 10) {
              script = await scanAndRegenerateInvalidScenes(script, apiPrompt);
            }

            // ë°°ì¹˜ ìƒì„± ì™„ë£Œ í‘œì‹œ
            if (apiPrompt.targetMinutes >= 60) {
              stopAntigravityProgress(longformState.totalScenes);
            }

            // ì„œë²„ ì‚¬ì´ë“œ ê²€ì¦ ê²°ê³¼ ì‚¬ìš© (ìˆëŠ” ê²½ìš°)
            if (data && data.keywordValidation) {
              validation = data.keywordValidation;
            } else {
              // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ê²€ì¦
              validation = validateKeywords(script, keywords);
            }

            // ì„œë²„ ì‚¬ì´ë“œ ìˆ˜ì¹˜ ê²€ì¦ ê²°ê³¼ ì‚¬ìš© (ìˆëŠ” ê²½ìš°)
            if (data && data.numericalValidation) {
              numericalValidation = data.numericalValidation;
            } else if (originalScript && originalScript !== script) {
              // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ìˆ˜ì¹˜ ê²€ì¦
              numericalValidation = validateNumericalData(originalScript, script);
            }
            
            // ëŒ€ë³¸ ì„¤ì • (ì¶œë ¥ë¶€ í•„í„°ë§)
            var displayScript = cleanScriptForDisplay(script);
            document.getElementById('scriptEditor').value = displayScript;
            
            // ë¶„ëŸ‰ ê²Œì´ì§€ ì—…ë°ì´íŠ¸
            updateDurationGauge();
            
            // ì”¬ë³„ ì‹œê° ë¬˜ì‚¬ ìë™ ë³€í™˜ (ì”¬ ìµœì í™”)
            try {
              var scenes = parseStorylineLines();
              var visualPrompts = generateSceneVisualPrompts(script, scenes);
              if (visualPrompts && visualPrompts.length > 0) {
                // ì‹œê° ë¬˜ì‚¬ ë°ì´í„°ë¥¼ localStorageì— ì €ì¥ (Step 4-1ì—ì„œ ì‚¬ìš©)
                var visualData = {
                  scenes: visualPrompts,
                  generatedAt: new Date().toISOString(),
                  tone: tone
                };
                localStorage.setItem('step3VisualPrompts', JSON.stringify(visualData));
                console.log('[Step 3] ì”¬ë³„ ì‹œê° ë¬˜ì‚¬ ìë™ ë³€í™˜ ì™„ë£Œ:', visualPrompts.length + 'ê°œ ì”¬');
              }
            } catch (e) {
              console.warn('[Step 3] ì‹œê° ë¬˜ì‚¬ ë³€í™˜ ì‹¤íŒ¨:', e);
              // ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
            }
            
            // Step 3 Success ë¡œê·¸
            console.log('[Step 3 Success] ëŒ€ë³¸ ìƒì„± ì™„ë£Œ', {
              tone: tone,
              keywords: keywords,
              scriptLength: script.length,
              keywordValidation: validation,
              numericalValidation: numericalValidation
            });
            
            // ì„œë²„ ë¡œê·¸ (ì˜µì…˜)
            try {
              await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/log', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  step: 3,
                  stepName: 'ëŒ€ë³¸ ìƒì„±',
                  status: 'success',
                  data: {
                    tone: tone,
                    keywordsCount: keywords.length,
                    scriptLength: script.length,
                    keywordValidation: validation.valid,
                    numericalValidation: numericalValidation.valid
                  }
                })
              }).catch(function(e) {
                console.warn('ì„œë²„ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', e);
              });
            } catch (e) {
              console.warn('ì„œë²„ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', e);
            }
            
            // ìˆ˜ì¹˜ ë³´í˜¸ ê²€ì¦ ê²°ê³¼ ì²˜ë¦¬ (ê°•í™”)
            if (!numericalValidation.valid && numericalValidation.missing.length > 0) {
              console.error('[Step 3] ìˆ˜ì¹˜ ë³´í˜¸ ê²€ì¦ ì‹¤íŒ¨:', {
                missing: numericalValidation.missing,
                original: originalNumerics,
                generated: generatedNumerics
              });
              
              var missingNumerics = numericalValidation.missing.map(function(n) { return "'" + n + "'"; }).join(', ');
              var originalNumerics = extractNumericalData(originalScript);
              var generatedNumerics = extractNumericalData(script);
              
              // ì¦‰ì‹œ ê²½ê³  íŒì—… í‘œì‹œ
              var warningMessage = 'âš ï¸ ì „ë¬¸ê°€ê°€ ì œì•ˆí•œ í•µì‹¬ ìˆ˜ì¹˜ì…ë‹ˆë‹¤.\n\n' +
                                   'ëˆ„ë½ëœ ìˆ˜ì¹˜: ' + missingNumerics + '\n\n' +
                                   'ì›ë³¸ ìˆ˜ì¹˜: ' + originalNumerics.join(', ') + '\n' +
                                   'ìƒì„±ëœ ìˆ˜ì¹˜: ' + generatedNumerics.join(', ') + '\n\n' +
                                   'ìˆ˜ì¹˜ ë°ì´í„°ê°€ ë³€ê²½ë˜ë©´ ê±´ê°• ì •ë³´ì˜ ì •í™•ì„±ì´ ë–¨ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n' +
                                   'ëŒ€ë³¸ì„ ë‹¤ì‹œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
              
              if (!confirm(warningMessage)) {
                // ì‚¬ìš©ìê°€ ì·¨ì†Œí•œ ê²½ìš°ì—ë„ ê²½ê³  í‘œì‹œ
                if (validationEl) {
                  validationEl.className = 'keyword-validation warning';
                  validationEl.innerHTML = '<strong>âš ï¸ ìˆ˜ì¹˜ ë³´í˜¸ ê²½ê³ :</strong> ë‹¤ìŒ ìˆ˜ì¹˜ ë°ì´í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: ' + missingNumerics + 
                                           '<br><small>ì›ë³¸: ' + originalNumerics.join(', ') + ' â†’ ìƒì„±: ' + generatedNumerics.join(', ') + '</small>';
                }
                return; // ì‚¬ìš©ìê°€ ì·¨ì†Œí•˜ë©´ ì¤‘ë‹¨
              }
              
              // ì¬ìƒì„± ë²„íŠ¼ ì¶”ê°€
              if (validationEl) {
                validationEl.className = 'keyword-validation warning';
                validationEl.innerHTML = '<strong>âš ï¸ ìˆ˜ì¹˜ ë³´í˜¸ ê²½ê³ :</strong> ë‹¤ìŒ ìˆ˜ì¹˜ ë°ì´í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: ' + missingNumerics + 
                                         '<br><small>ì›ë³¸: ' + originalNumerics.join(', ') + ' â†’ ìƒì„±: ' + generatedNumerics.join(', ') + '</small>' +
                                         '<br>ëŒ€ë³¸ì„ ë‹¤ì‹œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
                
                var retryBtn = document.createElement('button');
                retryBtn.textContent = 'ìˆ˜ì¹˜ í¬í•¨í•˜ì—¬ ë‹¤ì‹œ ìƒì„±';
                retryBtn.style.cssText = 'margin-top: 8px; padding: 6px 12px; background: #f59e0b; color: #fff; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;';
                retryBtn.onclick = function() {
                  btnGen.click();
                };
                
                var existingBtn = validationEl.querySelector('button');
                if (existingBtn) existingBtn.remove();
                validationEl.appendChild(retryBtn);
              }
              
              // ì¬ìƒì„± ì‹¤í–‰
              btnGen.click();
              return;
            } else if (numericalValidation.valid) {
              console.log('[Step 3] ìˆ˜ì¹˜ ë³´í˜¸ ê²€ì¦ ì„±ê³µ: ëª¨ë“  ìˆ˜ì¹˜ ë°ì´í„°ê°€ ìœ ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
            
            // í‚¤ì›Œë“œ ê²€ì¦
            if (keywords.length > 0) {
              
              if (!validation.valid) {
                // ëˆ„ë½ëœ í‚¤ì›Œë“œê°€ ìˆëŠ” ê²½ìš°
                var missingList = validation.missing.map(function(k) { return "'" + k + "'"; }).join(', ');
                var message = 'âš ï¸ í•„ìˆ˜ í‚¤ì›Œë“œ ' + missingList + 'ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.';
                
                if (validationEl) {
                  validationEl.className = 'keyword-validation warning';
                  validationEl.innerHTML = '<strong>ê²½ê³ :</strong> ' + message + '<br>ë‹¤ì‹œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
                  
                  // ì¬ìƒì„± ë²„íŠ¼ ì¶”ê°€
                  var retryBtn = document.createElement('button');
                  retryBtn.textContent = 'í‚¤ì›Œë“œ í¬í•¨í•˜ì—¬ ë‹¤ì‹œ ìƒì„±';
                  retryBtn.style.cssText = 'margin-top: 8px; padding: 6px 12px; background: #f59e0b; color: #fff; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;';
                  retryBtn.onclick = function() {
                    btnGen.click(); // ì¬ìƒì„±
                  };
                  
                  // ê¸°ì¡´ ë²„íŠ¼ ì œê±° í›„ ì¶”ê°€
                  var existingBtn = validationEl.querySelector('button');
                  if (existingBtn) existingBtn.remove();
                  validationEl.appendChild(retryBtn);
                }
                
                // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
                if (confirm(message + '\n\në‹¤ì‹œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                  btnGen.click(); // ì¬ìƒì„±
                  return;
                }
              } else {
                // ëª¨ë“  í‚¤ì›Œë“œê°€ í¬í•¨ëœ ê²½ìš°
                if (validationEl) {
                  validationEl.className = 'keyword-validation success';
                  validationEl.innerHTML = '<strong>âœ“ ê²€ì¦ ì™„ë£Œ:</strong> ëª¨ë“  í•„ìˆ˜ í‚¤ì›Œë“œê°€ ëŒ€ë³¸ì— í¬í•¨ë˜ì—ˆìŠµë‹ˆë‹¤.';
                }
              }
            }
          } catch (error) {
            console.error('ëŒ€ë³¸ ìƒì„± ì˜¤ë¥˜:', error);
            statusReplace('ì˜¤ë¥˜: ' + (error && error.message ? error.message : 'ëŒ€ë³¸ ìƒì„± ì‹¤íŒ¨'));
            showApiConnectionError('API ì—°ê²° í™•ì¸ í•„ìš”');
            alert('ëŒ€ë³¸ ìƒì„± ì‹¤íŒ¨: ' + (error && error.message ? error.message : 'API ì˜¤ë¥˜'));
          } finally {
            btnGen.disabled = false;
            btnGen.textContent = 'AI ëŒ€ë³¸ ì´ˆì•ˆ ìƒì„±í•˜ê¸°';
          }
        });
      }

      var btnNext = document.getElementById('btnGoToStep4');
      if (btnNext) {
        btnNext.addEventListener('click', function() {
          var scriptText = document.getElementById('scriptEditor').value.trim();
          if (!scriptText) {
            if (!confirm('ëŒ€ë³¸ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
          }
          var tone = document.getElementById('toneSelect').value;
          var keywordsInput = document.getElementById('requiredKeywordsInput');
          var keywords = [];
          if (keywordsInput && keywordsInput.value.trim()) {
            keywords = parseKeywords(keywordsInput.value);
          }
          
          // Step 3 ë°ì´í„° ì €ì¥ (í˜•ì‹ ë° ê¸¸ì´ ì •ë³´ í¬í•¨)
          var step3Payload = {
            script: scriptText,
            tone: tone,
            keywords: keywords,
            format: currentFormat,
            duration: currentDuration,
            targetMinutes: parseTargetDuration(currentDuration),
            blueprint: blueprint,
            fromStep2: fromStep2,
            scenes: parseStorylineLines()
          };
          localStorage.setItem('step3Blueprint', JSON.stringify(step3Payload));
          localStorage.setItem('currentFormat', currentFormat);
          localStorage.setItem('currentDuration', currentDuration);
          
          var payload = {
            blueprint: blueprint,
            fromStep2: fromStep2,
            script: scriptText,
            scenes: parseStorylineLines(),
            tone: tone,
            tonePersona: tonePersonaMap[tone] || tonePersonaMap['senior-expert'],
            requiredKeywords: keywords
          };
          localStorage.setItem('step4JsonPayload', JSON.stringify(payload));
          window.location.href = 'step-4-1.html';
        });
      }
    })();

    // ë¡œê·¸ì¸ ë¡œì§ (ë‹¤ë¥¸ í˜ì´ì§€ì™€ ë™ì¼)
    var isLoggedIn = false;
    function checkLoginStatus() {
      var loginStatus = localStorage.getItem('isLoggedIn');
      var loginTime = localStorage.getItem('loginTime');
      if (loginStatus === 'true' && loginTime) {
        var loginDate = new Date(loginTime);
        var now = new Date();
        var hoursDiff = (now - loginDate) / (1000 * 60 * 60);
        if (hoursDiff < 24) {
          isLoggedIn = true;
          updateUIForLogin();
          return true;
        }
      }
      isLoggedIn = false;
      updateUIForLogout();
      return false;
    }
    function login() {
      var id = document.getElementById('loginId').value.trim();
      var pw = document.getElementById('loginPw').value.trim();
      if (!id || !pw) { alert('IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      var users = JSON.parse(localStorage.getItem('approvedUsers') || '[]');
      var user = users.find(function(u) { return u.id === id && u.password === pw; });
      if (user) {
        isLoggedIn = true;
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('loginTime', new Date().toISOString());
        localStorage.setItem('currentUserId', id);
        updateUIForLogin();
        alert('ë¡œê·¸ì˜¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
        document.getElementById('loginId').value = '';
        document.getElementById('loginPw').value = '';
      } else {
        alert('ìŠ¹ì¸ëœ IDì™€ ë¹„ë°€ë²ˆí˜¸ê°€ ì•„ë‹™ë‹ˆë‹¤.');
      }
    }
    function logout() {
      isLoggedIn = false;
      localStorage.removeItem('isLoggedIn');
      localStorage.removeItem('loginTime');
      localStorage.removeItem('currentUserId');
      updateUIForLogout();
    }
    function updateUIForLogin() {
      document.getElementById('btnLogin').textContent = 'ë¡œê·¸ì•„ì›ƒ';
      document.getElementById('btnLogin').onclick = function() {
        if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { logout(); alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.'); }
      };
      document.getElementById('loginId').disabled = true;
      document.getElementById('loginPw').disabled = true;
    }
    function updateUIForLogout() {
      document.getElementById('btnLogin').textContent = 'ë¡œê·¸ì˜¨';
      document.getElementById('btnLogin').onclick = login;
      document.getElementById('loginId').disabled = false;
      document.getElementById('loginPw').disabled = false;
    }
    document.getElementById('btnAdmin').onclick = function() {
      alert('ê´€ë¦¬ í˜ì´ì§€ëŠ” ë©”ì¸(index.html)ì—ì„œ ì´ìš©í•˜ì„¸ìš”.');
    };
    document.getElementById('btnLogin').onclick = login;
    checkLoginStatus();
  </script>
</body>
</html>

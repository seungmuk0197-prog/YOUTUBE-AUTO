<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI ìë™í™” í”„ë¡œì íŠ¸</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Malgun Gothic", sans-serif;
      background: #f5f5f5;
      color: #333;
      min-height: 100vh;
    }
    .layout {
      display: flex;
      min-height: 100vh;
      padding-top: 0;
    }
    /* ê³µí†µ Sticky Header */
    .global-header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: #fff;
      border-bottom: 1px solid #e8ecf4;
      padding: 12px 32px;
      margin: 0 -32px 16px -32px;
    }
    /* í—¤ë” ë¡œê·¸ì¸ í–‰ */
    .login-inline-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .login-input {
      height: 32px;
      padding: 0 10px;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      font-size: 13px;
      box-sizing: border-box;
      transition: background-color 0.2s, border-color 0.2s;
    }
    .login-inline-row .login-input {
      width: 140px;
    }
    .login-input::placeholder { color: #a0aec0; }
    .login-input:disabled {
      background-color: #E0E0E0;
      border-color: #999;
      color: #666;
      cursor: not-allowed;
      pointer-events: none;
    }
    .btn-admin {
      padding: 0 12px;
      height: 32px;
      background: #e0e0e0;
      color: #333;
      border: 1px solid #c0c0c0;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-admin:hover { background: #d5d5d5; }
    .btn-login {
      padding: 0 12px;
      height: 32px;
      background: #e0e0e0;
      color: #333;
      border: 1px solid #c0c0c0;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-login:hover { background: #d5d5d5; }
    .btn-login:disabled {
      background: #ccc;
      cursor: not-allowed;
      opacity: 0.6;
    }
    /* Left Sidebar - Updates (1ì—´) */
    .sidebar {
      width: 300px;
      background: linear-gradient(180deg, #fafbff 0%, #f2f4f8 100%);
      border-right: 1px solid #e8ecf4;
      padding: 20px 16px 24px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 20px;
      height: 100vh;
      overflow-y: auto;
    }
    .sidebar-logo {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      font-weight: 700;
      font-size: 1.5rem;
      letter-spacing: 0.05em;
      color: #2d3748;
      margin-top: 8px;
      margin-bottom: 0;
      padding-left: 4px;
      text-align: left;
      cursor: pointer;
      transition: color 0.2s;
    }
    .sidebar-logo:hover {
      color: #9333ea;
    }
    /* ì¡°ì¹˜ ì¹´ë“œ */
    .sidebar-card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.04);
    }
    .sidebar-card-title {
      font-size: 13px;
      font-weight: 700;
      color: #4a5568;
      letter-spacing: -0.02em;
      margin-bottom: 10px;
    }
    .sidebar-card-desc {
      font-size: 13px;
      color: #718096;
      line-height: 1.5;
      margin-bottom: 10px;
    }
    .sidebar-card-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 600;
      color: #3182ce;
      text-decoration: none;
      margin-bottom: 8px;
    }
    .sidebar-card-link:hover {
      color: #2b6cb0;
      text-decoration: underline;
    }
    .sidebar-card-link .ext-icon {
      font-size: 12px;
      opacity: 0.9;
    }
    .sidebar-card-date {
      font-size: 12px;
      color: #a0aec0;
    }
    /* í˜„ì¬ í”„ë¡œì íŠ¸ */
    .project-label {
      font-size: 12px;
      color: #718096;
      margin-bottom: 6px;
    }
    .project-name-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 14px;
    }
    .project-name {
      font-size: 16px;
      font-weight: 700;
      color: #1a202c;
    }
    .project-name-edit {
      color: #718096;
      cursor: pointer;
      font-size: 14px;
    }
    .project-name-edit:hover {
      color: #3182ce;
    }
    .sidebar-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .sidebar-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .sidebar-btn-primary {
      background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
      color: #fff;
      margin-bottom: 10px;
    }
    .sidebar-btn-primary:hover {
      background: linear-gradient(135deg, #6b46c1 0%, #553c9a 100%);
    }
    .sidebar-btn-secondary {
      background: #fff;
      color: #2d3748;
      border: 1px solid #e2e8f0;
    }
    .sidebar-btn-secondary:hover {
      background: #f7fafc;
      border-color: #cbd5e0;
    }
    .sidebar-btn-secondary .folder-icon {
      font-size: 18px;
    }
    /* í”„ë¡œì íŠ¸ ì•¡ì…˜ í•œ ì¤„ ë°°ì¹˜ */
    .project-actions-row {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }
    .sidebar-btn-inline {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .sidebar-btn-inline-primary {
      background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
      color: #fff;
    }
    .sidebar-btn-inline-primary:hover {
      background: linear-gradient(135deg, #6b46c1 0%, #553c9a 100%);
    }
    .sidebar-btn-inline-secondary {
      background: #fff;
      color: #2d3748;
      border: 1px solid #e2e8f0;
    }
    .sidebar-btn-inline-secondary:hover {
      background: #f7fafc;
      border-color: #cbd5e0;
    }
    /* ì›Œí¬í”Œë¡œìš° ìŠ¤í… */
    .workflow-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .workflow-title {
      font-size: 13px;
      font-weight: 700;
      color: #4a5568;
      margin-bottom: 12px;
      padding: 0 4px;
    }
    .workflow-list {
      list-style: none;
      overflow-y: auto;
      padding-right: 4px;
      flex: 1;
    }
    .workflow-list::-webkit-scrollbar {
      width: 6px;
    }
    .workflow-list::-webkit-scrollbar-track {
      background: #edf2f7;
      border-radius: 3px;
    }
    .workflow-list::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 3px;
    }
    .workflow-item {
      display: block;
      padding: 12px 14px;
      margin-bottom: 6px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      color: #4a5568;
      background: #fff;
      border: 1px solid #e2e8f0;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, border-color 0.2s;
      text-decoration: none;
    }
    a.workflow-item:hover {
      background: #f7fafc;
      border-color: #cbd5e0;
      color: #2d3748;
    }
    .workflow-item:hover {
      background: #f7fafc;
      border-color: #cbd5e0;
      color: #2d3748;
    }
    .workflow-item.active {
      background: linear-gradient(135deg, #e9d8fd 0%, #e2e8f0 100%);
      border-color: #b794f4;
      color: #553c9a;
      font-weight: 600;
    }
    /* 1~2ë‹¨ê³„(AI ì°½ì‘)ì™€ 3ë‹¨ê³„(ì‚¬ìš©ì ì œì–´) ì‹œê°ì  êµ¬ë¶„ */
    .workflow-list li:nth-child(3) .workflow-item {
      margin-top: 10px;
      border-top: 1px dashed #e2e8f0;
      padding-top: 14px;
    }
    /* í•˜ë‹¨ ëŒ€ëŒ“ê¸€ ì œì‘ê¸° */
    .sidebar-footer-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 14px 16px;
      background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: auto;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .sidebar-footer-btn:hover {
      background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(45,55,72,0.35);
    }
    .sidebar-footer-btn .chat-icon {
      font-size: 18px;
    }
    /* Main Content */
    .main {
      flex: 1;
      padding: 24px 32px 40px;
      overflow-y: auto;
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      margin-top: 0;
      padding-top: 0;
    }
    .title-area {
      flex: 1;
    }
    .title-area h1 {
      font-size: 24px;
      font-weight: 700;
      color: #222;
      margin-bottom: 4px;
      margin-top: 0;
      line-height: 1.3;
    }
    .title-area .subtitle { 
      font-size: 14px; 
      color: #666;
      margin: 0;
      line-height: 1.4;
    }
    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }
    .header-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .btn-icon {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
      cursor: pointer;
      text-decoration: none;
    }
    .btn-icon:hover { background: #f8f8f8; }
    .header-row-old {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    .title-area h1 {
      font-size: 24px;
      font-weight: 700;
      color: #222;
      margin-bottom: 4px;
    }
    .title-area .subtitle {
      font-size: 14px;
      color: #666;
    }
    .header-buttons {
      display: flex;
      gap: 8px;
    }
    .btn-icon {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
      cursor: pointer;
    }
    .btn-icon:hover {
      background: #f8f8f8;
    }
    .info-banner {
      background: #fffde7;
      border: 1px solid #f5e642;
      padding: 12px 16px;
      font-size: 13px;
      color: #5c4a00;
      margin-bottom: 20px;
      border-radius: 6px;
    }
    .search-row {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }
    .search-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      background: #e8e8e8;
      color: #333;
    }
    .search-input::placeholder {
      color: #888;
    }
    .btn-primary {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: #e53935;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-primary:hover {
      background: #c62828;
    }
    .project-box {
      background: linear-gradient(135deg, #e8d5e8 0%, #f0e0f0 100%);
      border: 1px solid #e0c0e0;
      border-radius: 8px;
      padding: 20px 24px;
      margin-bottom: 28px;
      position: relative;
    }
    .project-box .trash-icon {
      position: absolute;
      top: 16px;
      right: 16px;
      font-size: 18px;
      color: #666;
      cursor: pointer;
    }
    .project-box .project-title {
      font-size: 18px;
      font-weight: 700;
      color: #333;
      margin-bottom: 12px;
    }
    .project-box .meta {
      font-size: 13px;
      color: #555;
    }
    .project-box .meta span {
      display: block;
      margin-bottom: 4px;
    }
    /* Topic Generation Section */
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #222;
      margin-bottom: 8px;
    }
    .section-desc {
      font-size: 13px;
      color: #666;
      margin-bottom: 20px;
    }
    /* AI ì¶”ì²œ ì£¼ì œ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ */
    .ai-result-section {
      margin-top: 24px;
      margin-bottom: 24px;
    }
    .ai-topic-list {
      margin-top: 12px;
      border-radius: 12px;
      background: #fff;
      border: 1px solid #e8e8e8;
      overflow: hidden;
    }
    .ai-topic-item {
      width: 100%;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 10px 14px;
      border: none;
      background: #fff;
      cursor: pointer;
      text-align: left;
    }
    .ai-topic-item + .ai-topic-item {
      border-top: 1px solid #f1f1f1;
    }
    .ai-topic-item:hover {
      background: #fdf2f8;
    }
    .ai-topic-index {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: #ff6fae;
      color: #fff;
      font-size: 12px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .ai-topic-text {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .ai-topic-title {
      font-size: 14px;
      color: #333;
      line-height: 1.5;
      font-weight: 600;
    }
    .ai-topic-reason {
      font-size: 13px;
      color: #666;
      line-height: 1.5;
    }
    .ai-topic-empty {
      padding: 14px;
      font-size: 13px;
      color: #888;
      text-align: center;
    }
    /* ì£¼ì œ ì„ íƒ íƒ­ */
    .topic-type-tabs {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
    }
    .topic-type-tab {
      padding: 10px 20px;
      background: #fff;
      border: 2px solid #e8e8e8;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
    }
    .topic-type-tab:hover {
      border-color: #cbd5e0;
    }
    .topic-type-tab.active {
      background: #ffeef5;
      border-color: #ffb3d9;
      color: #c2185b;
    }
    /* ì„ íƒ í•´ì œ ë²„íŠ¼ */
    .btn-clear-selection {
      padding: 6px 12px;
      background: #e0e0e0;
      color: #666;
      border: 1px solid #c0c0c0;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: auto;
    }
    .btn-clear-selection:hover {
      background: #d5d5d5;
      border-color: #b0b0b0;
    }
    .btn-clear-selection:active {
      background: #c0c0c0;
    }
    /* ì£¼ì œ ì•„ì´ì½˜ ë¦¬ìŠ¤íŠ¸ */
    .topic-icon-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
      padding: 16px;
      background: #fff;
      border: 1px solid #e8e8e8;
      border-radius: 8px;
    }
    .topic-icon-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 12px;
      min-width: 80px;
      background: #fff;
      border: 2px solid #e8e8e8;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .topic-icon-item:hover {
      border-color: #cbd5e0;
      transform: translateY(-2px);
    }
    .topic-icon-item.selected {
      background: #ffeef5;
      border-color: #ffb3d9;
    }
    .topic-icon-item.disabled {
      opacity: 0.45;
      pointer-events: none;
      filter: grayscale(0.2);
    }
    .topic-icon-item .icon {
      font-size: 24px;
      margin-bottom: 4px;
    }
    .topic-icon-item .label {
      font-size: 11px;
      font-weight: 600;
      color: #333;
      text-align: center;
    }
    /* í† í”½ íƒ­ */
    .topics-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .topic-tab {
      padding: 8px 16px;
      background: #fff;
      border: 1px solid #e8e8e8;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
    }
    .topic-tab:hover {
      background: #f7fafc;
      border-color: #cbd5e0;
    }
    .topic-tab.active {
      background: #3182ce;
      border-color: #3182ce;
      color: #fff;
    }
    .topic-tab:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      pointer-events: none;
    }
    .topic-type-tab:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      pointer-events: none;
    }
    .topics-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-size: 16px;
      font-weight: 700;
      color: #222;
      margin-bottom: 16px;
    }
    .topics-date {
      font-size: 12px;
      font-weight: 600;
      color: #718096;
      white-space: nowrap;
    }
    .topics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 24px;
      height: auto;
      min-height: 0;
      overflow: visible;
    }
    .topic-card.selected {
      background: #ffeef5;
      border-color: #ffb3d9;
    }
    .topic-card.disabled {
      opacity: 0.45;
      pointer-events: none;
      filter: grayscale(0.2);
    }
    .topic-card:not(.disabled) {
      opacity: 1;
      pointer-events: auto;
      filter: none;
    }
    .topic-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: #fff;
      border: 1px solid #e8e8e8;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }
    .topic-num {
      font-size: 14px;
      font-weight: 700;
      color: #666;
      min-width: 24px;
    }
    .topic-content {
      flex: 1;
      min-width: 0;
    }
    .topic-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 6px;
    }
    .topic-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .topic-category {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      color: #fff;
    }
    .cat-tech { background: #42a5f5; }
    .cat-game { background: #ef5350; }
    .cat-life { background: #66bb6a; }
    .cat-ent { background: #ab47bc; }
    .cat-sport { background: #ff9800; }
    .cat-food { background: #26a69a; }
    .topic-views {
      font-size: 12px;
      color: #888;
    }
    .topic-keywords {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .topic-keyword {
      font-size: 11px;
      color: #4a5568;
      background: #edf2f7;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #e2e8f0;
      white-space: nowrap;
    }
    .data-footer {
      font-size: 12px;
      color: #999;
      margin-bottom: 28px;
    }
    .input-area {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      background: #fff;
      border: 1px solid #e8e8e8;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .input-area input,
    .input-area textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      background: #fff;
      box-sizing: border-box;
    }
    .input-area textarea {
      min-height: 120px;
      resize: vertical;
    }
    .input-area input::placeholder,
    .input-area textarea::placeholder {
      color: #999;
    }
    .btn-script {
      display: block;
      width: 100%;
      max-width: 200px;
      margin: 0 auto 16px;
      padding: 10px 16px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
      cursor: pointer;
    }
    .btn-script:hover {
      background: #f5f5f5;
    }
    .btn-generate {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 14px 24px;
      background: #e53935;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-generate:hover {
      background: #c62828;
    }
    .btn-generate .play-icon {
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      position: relative;
    }
    .btn-generate .play-icon::after {
      content: '';
      position: absolute;
      left: 7px;
      top: 5px;
      border: 5px solid transparent;
      border-left: 8px solid #e53935;
      border-right: 0;
    }

    /* ëŒ€ë³¸ ì§ì ‘ ë„£ê¸° ëª¨ë‹¬ */
    .script-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .script-modal-overlay.show { display: flex; }
    .script-modal {
      width: 100%;
      max-width: 720px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      border: 1px solid rgba(0,0,0,0.08);
      overflow: hidden;
    }
    .script-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid #e2e8f0;
      background: #fafafa;
    }
    .script-modal-title { font-size: 15px; font-weight: 700; color: #222; }
    .script-modal-close {
      width: 30px;
      height: 30px;
      border: none;
      background: #e0e0e0;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      color: #333;
    }
    .script-modal-body {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .script-modal-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .script-modal-grid .full { grid-column: 1 / -1; }
    .script-field-label { font-size: 13px; font-weight: 700; color: #2d3748; margin-bottom: 6px; }
    .script-textarea {
      overflow-y: auto;
      overflow-x: hidden;
      width: 100%;
      min-height: 140px;
      resize: vertical;
      padding: 12px;
      border: 1px solid #cbd5e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      box-sizing: border-box;
    }
    .script-input {
      width: 100%;
      height: 36px;
      padding: 0 12px;
      border: 1px solid #cbd5e0;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .script-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 6px;
    }
    .btn-secondary {
      height: 34px;
      padding: 0 14px;
      background: #e0e0e0;
      color: #333;
      border: 1px solid #c0c0c0;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-secondary:hover { background: #d5d5d5; }

    /* ì „ê³¼ì • Auto ë²„íŠ¼ */
    .btn-auto-full {
      width: 100%;
      padding: 24px 36px;
      background: linear-gradient(135deg, #9333ea 0%, #ec4899 50%, #f472b6 100%);
      color: #fff;
      border: none;
      border-radius: 16px;
      font-size: 20px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 24px rgba(147, 51, 234, 0.4), 0 0 40px rgba(236, 72, 153, 0.3);
      margin-top: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }
    .btn-auto-full::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s;
    }
    .btn-auto-full:hover::before {
      left: 100%;
    }
    .btn-auto-full:hover {
      background: linear-gradient(135deg, #7c3aed 0%, #db2777 50%, #f472b6 100%);
      box-shadow: 0 12px 32px rgba(147, 51, 234, 0.5), 0 0 60px rgba(236, 72, 153, 0.4);
      transform: translateY(-3px);
    }
    .btn-auto-full:active {
      transform: translateY(-1px);
    }
    .btn-auto-full:disabled {
      background: #cbd5e0;
      color: #999;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    .btn-auto-full:disabled::before {
      display: none;
    }

    /* ì§„í–‰ ëª¨ë‹¬ */
    .progress-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .progress-modal-overlay.show {
      display: flex;
    }
    .progress-modal {
      background: #fff;
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      animation: modalFadeIn 0.3s ease-out;
    }
    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    .progress-modal-title {
      font-size: 28px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 24px;
      text-align: center;
      animation: pulseText 2s ease-in-out infinite;
    }
    @keyframes pulseText {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.8;
        transform: scale(1.02);
      }
    }
    .progress-bar-container {
      width: 100%;
      height: 16px;
      background: #e2e8f0;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 16px;
      position: relative;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #9333ea 0%, #ec4899 50%, #f472b6 100%);
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 8px;
      position: relative;
      overflow: hidden;
    }
    .progress-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer {
      0% {
        transform: translateX(-100%);
      }
      100% {
        transform: translateX(100%);
      }
    }
    .progress-step-info {
      text-align: center;
      margin-bottom: 8px;
    }
    .progress-step-number {
      font-size: 16px;
      font-weight: 700;
      color: #9333ea;
      margin-bottom: 8px;
    }
    .progress-step-message {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 16px;
      min-height: 28px;
    }
    .progress-percentage {
      font-size: 14px;
      font-weight: 600;
      color: #64748b;
      margin-top: 8px;
      text-align: center;
    }
    .progress-loading {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e2e8f0;
      border-top-color: #9333ea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .progress-error {
      margin-top: 16px;
      padding: 12px;
      background: #fee2e2;
      border: 1px solid #fca5a5;
      border-radius: 8px;
      color: #991b1b;
      font-size: 14px;
      display: none;
    }
    .progress-error.show {
      display: block;
    }
    .progress-retry-btn,
    .progress-manual-btn {
      margin-top: 12px;
      padding: 10px 20px;
      background: #dc2626;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .progress-retry-btn:hover,
    .progress-manual-btn:hover {
      background: #b91c1c;
      transform: translateY(-1px);
    }
    .progress-manual-btn {
      background: #9333ea;
      margin-left: 8px;
    }
    .progress-manual-btn:hover {
      background: #7c3aed;
    }

    /* ë³µêµ¬ ëª¨ë‹¬ */
    .recovery-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .recovery-modal {
      background: #fff;
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      animation: modalFadeIn 0.3s ease-out;
    }
    .recovery-modal-title {
      font-size: 24px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 20px;
      text-align: center;
    }
    .recovery-modal-content {
      margin-bottom: 24px;
      line-height: 1.6;
      color: #4a5568;
    }
    .recovery-modal-content p {
      margin-bottom: 12px;
    }
    .recovery-modal-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    .btn-recovery-resume,
    .btn-recovery-cancel {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-recovery-resume {
      background: linear-gradient(135deg, #9333ea 0%, #ec4899 100%);
      color: #fff;
    }
    .btn-recovery-resume:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(147, 51, 234, 0.4);
    }
    .btn-recovery-cancel {
      background: #e2e8f0;
      color: #4a5568;
    }
    .btn-recovery-cancel:hover {
      background: #cbd5e0;
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Left Sidebar - 1ì—´ ì—…ë°ì´íŠ¸ ì‚¬í•­ -->
    <aside class="sidebar">
      <div class="sidebar-logo" onclick="window.location.href='ai-automation-project.html'" title="í™ˆìœ¼ë¡œ ì´ë™">HANRA STUDIO</div>

      <!-- í˜„ì¬ í”„ë¡œì íŠ¸ -->
      <div class="sidebar-card">
        <div class="project-label">í˜„ì¬ í”„ë¡œì íŠ¸</div>
        <div class="project-name-row">
          <span class="project-name">ìƒˆë¡œìš´ í”„ë¡œì íŠ¸</span>
          <span class="project-name-edit" title="ì´ë¦„ ìˆ˜ì •">âœ</span>
        </div>
        <div class="project-actions-row">
          <button type="button" class="sidebar-btn-inline sidebar-btn-inline-primary" id="btnCreateProject">
            Pìƒì„±
          </button>
          <button type="button" class="sidebar-btn-inline sidebar-btn-inline-secondary" id="btnProjectList">
            Pëª©ë¡
          </button>
        </div>
      </div>

      <!-- ì›Œí¬í”Œë¡œìš° ë‹¨ê³„ -->
      <div class="workflow-wrap">
        <div class="workflow-title">ì§„í–‰ ë‹¨ê³„</div>
        <ul class="workflow-list">
          <li><a href="ai-automation-project.html" class="workflow-item active">1. ì£¼ì œ ì¶”ì²œ</a></li>
          <li><a href="step-2.html" class="workflow-item">2. AI ëŒ€ë³¸ ìƒì„±</a></li>
          <li><a href="step-3.html" class="workflow-item">3. ëŒ€ë³¸ ì§ì ‘ ì…ë ¥</a></li>
          <li><a href="step-4-1.html" class="workflow-item">4-1. JSON ìƒì„±</a></li>
          <li><a href="step-4-2.html" class="workflow-item">4-2. ì´ë¯¸ì§€ ìƒì„±</a></li>
          <li><a href="step-6.html" class="workflow-item">5. TTS ìƒì„±</a></li>
          <li><a href="step-5-2.html" class="workflow-item">5-2. BGM ì‚½ì…</a></li>
          <li><a href="step-7.html" class="workflow-item">6. ì˜ìƒ ë Œë”ë§</a></li>
          <li><a href="step-8.html" class="workflow-item">7. ì œëª©/ì„¤ëª… ì‘ì„±</a></li>
          <li><a href="step-9.html" class="workflow-item">8. ì¸ë„¤ì¼ ìƒì„±ê¸°</a></li>
          <li><a href="step-10.html" class="workflow-item">9. ìµœì¢… ì œì‘</a></li>
          <li><a href="step-11.html" class="workflow-item">10. ì‡¼ì¸  ìë™ ë³€í™˜</a></li>
          <li><a href="step-12.html" class="workflow-item">11. ì±„ë„ ë§¤ë‹ˆì €</a></li>
          <li><a href="step-13.html" class="workflow-item">12. ì‘ì—… ë³´ê´€í•¨</a></li>
        </ul>
      </div>

      <!-- í•˜ë‹¨: ëŒ€ëŒ“ê¸€ ì œì‘ê¸° -->
      <button type="button" class="sidebar-footer-btn">
        <span class="chat-icon">ğŸ’¬</span> ëŒ€ëŒ“ê¸€ ì œì‘ê¸°
      </button>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <div class="header-row">
        <div class="title-area">
          <h1>AI ìë™í™” í”„ë¡œì íŠ¸</h1>
          <p class="subtitle">ì‘ì—…í•œ ë‚´ìš©ì„ ì €ì¥í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>
        </div>
        <div class="header-right">
          <div class="login-inline-row">
            <input type="text" class="login-input" id="loginId" placeholder="ID">
            <input type="password" class="login-input" id="loginPw" placeholder="Password">
            <button type="button" class="btn-admin" id="btnAdmin">ê´€ë¦¬</button>
            <button type="button" class="btn-login" id="btnLogin">ë¡œê·¸ì˜¨</button>
          </div>
          <div class="header-buttons">
            <a href="/" class="btn-icon" style="text-decoration:none;color:inherit;">ğŸ  ë©”ì¸í™”ë©´</a>
            <button type="button" class="btn-icon">â„¹ï¸ ì•ˆë‚´ì‚¬í•­</button>
          </div>
        </div>
      </div>

      <h2 class="section-title">ì£¼ì œ ìƒì„±</h2>
      <p class="section-desc">í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ ê¸°ì¤€ìœ¼ë¡œ ì£¼ì œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
      
      <a href="step-3.html" class="btn-generate" style="margin-bottom: 16px; display:inline-block; text-decoration:none; text-align:center;">
        ë‚´ ëŒ€ë³¸ìœ¼ë¡œ ì¦‰ì‹œ ì œì‘í•˜ê¸° (3ë‹¨ê³„ë¡œ ì´ë™)
      </a>

      <!-- ì£¼ì œ íƒ€ì… ì„ íƒ íƒ­ -->
      <div class="topic-type-tabs">
        <button class="topic-type-tab active" data-type="basic">ê¸°ë³¸ ì£¼ì œ</button>
        <button class="topic-type-tab" data-type="niche">í‹ˆìƒˆ ì£¼ì œ</button>
        <button class="topic-type-tab" data-type="channel">ìš´ì˜ ì±„ë„</button>
        <button type="button" class="btn-clear-selection" id="btnClearTopicSelection" data-section="topic">ì„ íƒ í•´ì œ</button>
      </div>

      <!-- ì£¼ì œ ì•„ì´ì½˜ ë¦¬ìŠ¤íŠ¸ -->
      <div class="topic-icon-list" id="basicTopicIcons"></div>
      <div class="topic-icon-list" id="nicheTopicIcons" style="display: none;"></div>
      <div class="topic-icon-list" id="channelTopicIcons" style="display: none;"></div>

      <!-- í† í”½ íƒ­ -->
      <div class="topics-tabs" style="margin-top: 24px;">
        <button class="topic-tab active" data-tab="weekly">ì£¼ê°„ ê¸‰ìƒìŠ¹</button>
        <button class="topic-tab" data-tab="daily">ì¼ê°„ í•«ì´ìŠˆ</button>
      </div>
      <div class="topics-header">
        <span id="topicsHeader">ì£¼ê°„ ê¸‰ìƒìŠ¹ í† í”½ TOP 20 âš¡ğŸ”¥</span>
        <span class="topics-date" id="topicsDate"></span>
      </div>
      <div class="topics-grid" id="topicsGrid">
        <!-- ë°ì´í„°ëŠ” APIì—ì„œ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
        <div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: #999;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>

      <p class="data-footer" id="dataFooter">ë°ì´í„° ê¸°ì¤€: ë¡œë”© ì¤‘...</p>

      <!-- í‚¤ì›Œë“œ ì„ ì • -->
      <h2 class="section-title" style="margin-top: 24px;">í‚¤ì›Œë“œ ì„ ì •</h2>
      <div class="input-area" style="padding: 0; border: none; background: transparent;">
        <input type="text" id="keywordInput" placeholder="í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ë©´ í•´ë‹¹ í‚¤ì›Œë“œ ì¤‘ì‹¬ìœ¼ë¡œ ì£¼ì œë¥¼ ìƒì„±í•©ë‹ˆë‹¤">
      </div>

      <!-- ì „ê³¼ì • Auto ë²„íŠ¼ -->
      <button type="button" class="btn-auto-full" id="btnFullAuto" disabled>
        ğŸš€ ì „ê³¼ì • Auto ì˜ìƒ ì œì‘ ì‹œì‘
      </button>

      <!-- ìµœí•˜ë‹¨ ì‹¤í–‰ ë²„íŠ¼ -->
      <button type="button" class="btn-generate" id="btnAnalyzeGenerate" style="margin-top: 16px;">
        <span class="play-icon"></span>
        AI ë¶„ì„ ì£¼ì œ ìƒì„±í•˜ê¸°
      </button>

      <!-- AI ì¶”ì²œ ì£¼ì œ ì„ íƒ ê²°ê³¼ ì„¹ì…˜ -->
      <div class="ai-result-section" id="aiTopicResults" style="display:none;">
        <h2 class="section-title" style="margin-top: 24px;">ì¶”ì²œ ì£¼ì œ ì„ íƒ</h2>
        <p class="section-desc">ìƒì„±ëœ ì£¼ì œ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ë©´ ë°”ë¡œ 2. AI ëŒ€ë³¸ ìƒì„± ë‹¨ê³„ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
        <div class="ai-topic-list" id="aiTopicList">
          <!-- AIê°€ ìƒì„±í•œ ì£¼ì œë¥¼ ì—¬ê¸°ì—ì„œ ë Œë”ë§ -->
        </div>
      </div>
    </main>
  </div>

  <!-- ì§„í–‰ ëª¨ë‹¬ -->
  <div class="progress-modal-overlay" id="progressModal">
    <div class="progress-modal">
      <div class="progress-modal-title">ğŸ¤– AI ì˜ìƒ ìë™ ìƒì„± ì¤‘...</div>
      <div class="progress-step-info">
        <div class="progress-step-number" id="progressStepNumber">Step 0 / 9</div>
        <div class="progress-step-message" id="progressStepMessage">ì´ˆê¸°í™” ì¤‘...</div>
        <div class="progress-percentage" id="progressPercentage">0%</div>
      </div>
      <div class="progress-bar-container">
        <div class="progress-bar-fill" id="progressBarFill" style="width: 0%;"></div>
      </div>
      <div class="progress-loading">
        <div class="loading-spinner"></div>
      </div>
      <div class="progress-error" id="progressError">
        <div id="progressErrorText"></div>
        <div style="display: flex; gap: 8px; justify-content: center;">
          <button class="progress-retry-btn" id="progressRetryBtn" style="display: none;">ì¬ì‹œë„</button>
          <button class="progress-manual-btn" id="progressManualBtn" style="display: none;">ìˆ˜ë™ ì „í™˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ëŒ€ë³¸ ì§ì ‘ ë„£ê¸°: í…ìŠ¤íŠ¸/íŒŒì¼/URL ì…ë ¥ ëª¨ë‹¬ -->
  <div class="script-modal-overlay" id="scriptModal">
    <div class="script-modal">
      <div class="script-modal-header">
        <div class="script-modal-title">ëŒ€ë³¸ ì§ì ‘ ë„£ê¸°</div>
        <button type="button" class="script-modal-close" id="scriptModalClose">âœ•</button>
      </div>
      <div class="script-modal-body">
        <div class="script-modal-grid">
          <div class="full">
            <div class="script-field-label">í…ìŠ¤íŠ¸ ì…ë ¥</div>
            <textarea class="script-textarea" id="scriptText" placeholder="ëŒ€ë³¸ì„ ì…ë ¥í•˜ê±°ë‚˜ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”"></textarea>
          </div>
          <div>
            <div class="script-field-label">íŒŒì¼ ì—…ë¡œë“œ (.txt)</div>
            <input type="file" id="scriptFile" class="script-input" accept=".txt,text/plain">
          </div>
          <div>
            <div class="script-field-label">URL ì…ë ¥</div>
            <div style="display:flex;gap:8px;align-items:center;">
              <input type="text" id="scriptUrl" class="script-input" placeholder="https://..." style="flex:1;">
              <button type="button" class="btn-generate" id="scriptUrlLoadBtn" style="width:auto;padding:0 12px;height:34px;white-space:nowrap;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
          </div>
        </div>
        <div class="script-actions">
          <button type="button" class="btn-secondary" id="scriptModalCancel">ì·¨ì†Œ</button>
          <button type="button" class="btn-generate" id="scriptApplyBtn" style="width:auto;padding:0 16px;height:34px;">
            ê·¸ëŒ€ë¡œ ì ìš©
          </button>
          <button type="button" class="btn-generate" id="scriptAnalyzeBtn" style="width:auto;padding:0 16px;height:34px;">
            ì¬êµ¬ì„±
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ì „ì—­ ìƒíƒœ ê´€ë¦¬
    var globalState = {
      selectedTopicType: 'basic',
      selectedCategory: null,
      selectedTopics: [],
      generatedMaterials: null,
      keyword: '',
      scriptText: '',
      aiTopics: []
    };
    var isAutoProcessing = false;
    var currentAutoStep = 0;
    var autoProcessError = null;
    var currentProjectId = null;
    var autoSaveInterval = null;

    // ===== ì£¼ì œ ëª©ë¡ (ê°€ë‚˜ë‹¤ìˆœ ìë™ ì •ë ¬) =====
    var BASIC_TOPICS = [
      'AI ë„êµ¬ ë¦¬ë·°','ASMR','ê²Œì„ ê°€ì´ë“œ','ê³µë¶€ íŒ','ë‰´ìŠ¤/ì‹œì‚¬ ìš”ì•½','ë™ê¸°ë¶€ì—¬','ë¦¬ì•¡ì…˜ ì˜ìƒ','ë°˜ë ¤ë™ë¬¼','ë¸Œì´ë¡œê·¸','ë©”ì´í¬ì—… íŠœí† ë¦¬ì–¼','ì—¬í–‰ ê°€ì´ë“œ','ìš”ë¦¬ ë ˆì‹œí”¼','ì˜í™”/ë“œë¼ë§ˆ ë¦¬ë·°','ì œí’ˆ ì–¸ë°•ì‹±','ì¬í…Œí¬ ê¸°ì´ˆ','íŒ¨ì…˜ ì½”ë””','í™ˆ íŠ¸ë ˆì´ë”©','IT ê¸°ê¸° ë¹„êµ'
    ].sort(function(a,b){ return a.localeCompare(b,'ko'); });

    var NICHE_TOPICS = [
      '1ì¸ ë¯¸ë””ì–´','3D í”„ë¦°íŒ…','AI ìë™í™”','VR/AR ì‘ì—…','ê°€êµ¬ ë¦¬í¼','ê³ ì „ ê²Œì„','ê³µì˜ˆ ì¬í…Œí¬','ë‚˜í™€ë¡œ ìº í•‘','ë°ì´í„° ë¶„ì„','ë””ì§€í„¸ ë…¸ë§ˆë“œ','ë””ì§€í„¸ ë“œë¡œì‰','ëª…ìƒ í…Œë¼í”¼','ë¯¸êµ­ ë°°ë‹¹ì£¼','ë¯¸ë‹ˆë©€ ë¼ì´í”„','ë¬´ì¸ ì°½ì—…','ë¹„ê±´ ë¹„ì¦ˆë‹ˆìŠ¤','ë¶€ë™ì‚° ê²½ë§¤','ì†Œìƒê³µì¸ ë§ˆì¼€íŒ…','ìŠ¤ë§ˆíŠ¸í™ˆ','ì‹œë‹ˆì–´ IT','ì‹ë¬¼ ì¬í…Œí¬','ì‹¬ë¦¬ ìƒë‹´','ì™€ì¸ ì†Œë¯ˆë¦¬ì—','ì€í‡´ ì„¤ê³„','ì¬ìƒ ì—ë„ˆì§€','ì •ë¶€ ì§€ì›ê¸ˆ','ì¤‘ê³ ì°¨ ê´€ë¦¬','ì»¤ë¦¬ì–´ ì»¨ì„¤íŒ…','ì¹œí™˜ê²½ ì°½ì—…','í† í”Œ/ì•„ì´ì—˜ì¸ ','íŠ¹ìˆ˜ ì™¸êµ­ì–´','í¼ìŠ¤ë„ ë¸Œëœë”©','í˜‘ì—…íˆ´ ë¦¬ë·°'
    ].sort(function(a,b){ return a.localeCompare(b,'ko'); });

    var CHANNEL_TOPICS = [
      'ë‰´ìŠ¤ ì±„ë„','ìˆœìœ„ ì±„ë„(Top 10)','ì‡¼í•‘ ì‡¼ì¸ ','ì‹œë‹ˆì–´ ê±´ê°•','ì‹œë‹ˆì–´ ì°'
    ].sort(function(a,b){ return a.localeCompare(b,'ko'); });

    function getTopicIcon(label) {
      if (label.indexOf('AI') !== -1) return 'ğŸ¤–';
      if (label.indexOf('ASMR') !== -1) return 'ğŸ§';
      if (label.indexOf('ê²Œì„') !== -1) return 'ğŸ®';
      if (label.indexOf('ê³µë¶€') !== -1) return 'ğŸ“š';
      if (label.indexOf('ë‰´ìŠ¤') !== -1 || label.indexOf('ì‹œì‚¬') !== -1) return 'ğŸ“°';
      if (label.indexOf('ì—¬í–‰') !== -1) return 'âœˆï¸';
      if (label.indexOf('ìš”ë¦¬') !== -1 || label.indexOf('ë ˆì‹œí”¼') !== -1) return 'ğŸ³';
      if (label.indexOf('ë©”ì´í¬ì—…') !== -1) return 'ğŸ’„';
      if (label.indexOf('íŒ¨ì…˜') !== -1) return 'ğŸ‘—';
      if (label.indexOf('ì–¸ë°•ì‹±') !== -1 || label.indexOf('ê¸°ê¸°') !== -1) return 'ğŸ“¦';
      if (label.indexOf('ì¬í…Œí¬') !== -1 || label.indexOf('ë°°ë‹¹') !== -1 || label.indexOf('ê²½ë§¤') !== -1) return 'ğŸ’°';
      if (label.indexOf('ì‹œë‹ˆì–´') !== -1 || label.indexOf('ì€í‡´') !== -1) return 'ğŸ§“';
      if (label.indexOf('ëª…ìƒ') !== -1 || label.indexOf('ì‹¬ë¦¬') !== -1) return 'ğŸ§˜';
      if (label.indexOf('ìº í•‘') !== -1) return 'ğŸ•ï¸';
      if (label.indexOf('ìŠ¤ë§ˆíŠ¸í™ˆ') !== -1) return 'ğŸ ';
      return 'ğŸ“Œ';
    }

    function renderTopicIconList(containerId, topics) {
      var el = document.getElementById(containerId);
      if (!el) return;
      el.innerHTML = '';
      topics.forEach(function(label) {
        var item = document.createElement('div');
        item.className = 'topic-icon-item';
        item.setAttribute('data-category', label);
        item.innerHTML = '<div class="icon">' + getTopicIcon(label) + '</div><div class="label">' + label + '</div>';
        el.appendChild(item);
      });
    }

    function renderAllTopicIconLists() {
      renderTopicIconList('basicTopicIcons', BASIC_TOPICS);
      renderTopicIconList('nicheTopicIcons', NICHE_TOPICS);
      renderTopicIconList('channelTopicIcons', CHANNEL_TOPICS);
    }

    function setActiveTopicType(type) {
      globalState.selectedTopicType = type;
      var basic = document.getElementById('basicTopicIcons');
      var niche = document.getElementById('nicheTopicIcons');
      var channel = document.getElementById('channelTopicIcons');
      if (basic) basic.style.display = type === 'basic' ? 'grid' : 'none';
      if (niche) niche.style.display = type === 'niche' ? 'grid' : 'none';
      if (channel) channel.style.display = type === 'channel' ? 'grid' : 'none';
    }

    // ì£¼ì œ íƒ€ì… íƒ­ ê¸°ëŠ¥ (ê¸°ë³¸/í‹ˆìƒˆ/ìš´ì˜ ì±„ë„)
    renderAllTopicIconLists();
    setActiveTopicType(globalState.selectedTopicType);
    document.querySelectorAll('.topic-type-tab').forEach(function(tab) {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.topic-type-tab').forEach(function(t) {
          t.classList.remove('active');
        });
        this.classList.add('active');

        var type = this.getAttribute('data-type');
        setActiveTopicType(type);
      });
    });

    var keywordInputEl = document.getElementById('keywordInput');
    var topicsGridEl = document.getElementById('topicsGrid');
    var aiResultSectionEl = document.getElementById('aiTopicResults');
    var aiTopicListEl = document.getElementById('aiTopicList');

    // ===== AI ì£¼ì œ ìƒì„± ë¡œì§ (ì „ë¬¸ê°€ í˜ë¥´ì†Œë‚˜ + 5ê°€ì§€ ê´€ì ) =====
    function getBaseContext() {
      var keyword = keywordInputEl ? keywordInputEl.value.trim() : '';
      var seed =
        keyword ||
        globalState.keyword ||
        globalState.selectedCategory ||
        (globalState.selectedTopics && globalState.selectedTopics[0]) ||
        'AI ì½˜í…ì¸ ';

      var field = 'ì½˜í…ì¸ ';
      if (/ì¬í…Œí¬|ë°°ë‹¹|ì£¼ì‹|ë¶€ë™ì‚°|ê²½ë§¤/.test(seed)) field = 'ì¬í…Œí¬';
      else if (/í…Œí¬|IT|AI|ê¸°ê¸°|ê¸°ìˆ /.test(seed)) field = 'í…Œí¬/AI';
      else if (/ì‹œë‹ˆì–´|ì€í‡´|ë…¸ì¸/.test(seed)) field = 'ì‹œë‹ˆì–´';

      return {
        seed: seed,
        field: field,
        personaPrefix: '10ë…„ ê²½ë ¥ì˜ ì „ë¬¸ ì½˜í…ì¸  ì „ëµê°€ì´ì ' + field + ' ë¶„ì•¼ ìˆ˜ì„ ì—°êµ¬ì› ê´€ì ì—ì„œ, '
      };
    }

    function scoreTopic(searchKeyword, targetPersona) {
      // ê°„ë‹¨í•œ ê°€ì¤‘ì¹˜ í•©ì‚°ìœ¼ë¡œ ë‚´ë¶€ ì ìˆ˜ ê³„ì‚° (UIì—ëŠ” ë…¸ì¶œí•˜ì§€ ì•ŠìŒ)
      var score = 0;
      if (searchKeyword.length >= 2) score += 0.3;
      if (/[?|!]/.test(searchKeyword)) score += 0.2;
      if (/202[6-9]|ë¯¸ë˜|ì˜ˆì¸¡|ì „ë§/.test(searchKeyword)) score += 0.2;
      if (/ì´ˆë³´|ì…ë¬¸|ì²˜ìŒ|ì‹œì‘/.test(targetPersona)) score += 0.15;
      if (/ì „ì—…|ì‹¤ì „|ì „ëµ/.test(targetPersona)) score += 0.15;
      return Math.min(1, score);
    }

    function buildPerspectiveTopics(ctx) {
      var seed = ctx.seed;
      var persona = ctx.personaPrefix;
      var topics = [];

      // A: Deep Dive (1~3)
      [
        {
          title: seed + 'ì˜ íƒ„ìƒê³¼ ì§„í™”: ìš°ë¦¬ê°€ ë†“ì³¤ë˜ ìˆ¨ê²¨ì§„ ì—­ì‚¬',
          reason: persona + 'ì´ˆê¸° ë“±ì¥ë¶€í„° ì§€ê¸ˆê¹Œì§€ ' + seed + 'ê°€ ì–´ë–»ê²Œ ì§„í™”í–ˆëŠ”ì§€ ì‹œê°„ ìˆœìœ¼ë¡œ ì§šì–´ì£¼ë©° ì‹œì²­ìì˜ ì´í•´ë„ë¥¼ ëŒì–´ì˜¬ë¦½ë‹ˆë‹¤.',
          searchKeyword: seed + ' ì—­ì‚¬',
          targetPersona: 'ë°°ê²½ì§€ì‹ì„ ì•Œê³  ì‹¶ì€ ì§„ì§€í•œ ì‹œì²­ì'
        },
        {
          title: 'ìˆ«ìë¡œ ë³´ëŠ” ' + seed + ' ì„±ì¥ ê³¡ì„ ',
          reason: persona + 'ì‹œì¥ ë°ì´í„°ì™€ í†µê³„ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ' + seed + 'ì˜ ì„±ì¥ ì†ë„ì™€ ì „í™˜ì ì„ ë¶„ì„í•´ ì‹ ë¢°ê°ì„ ì¤ë‹ˆë‹¤.',
          searchKeyword: seed + ' í†µê³„ ë°ì´í„°',
          targetPersona: 'íˆ¬ìÂ·ë¹„ì¦ˆë‹ˆìŠ¤ ê´€ì ìœ¼ë¡œ íŠ¸ë Œë“œë¥¼ ë³´ëŠ” ì‹œì²­ì'
        },
        {
          title: 'í˜„ì—…ì´ ë§í•˜ëŠ” ' + seed + 'ì˜ ì§„ì§œ í•µì‹¬ ê¸°ìˆ  í•œëˆˆì— ì •ë¦¬',
          reason: persona + 'ë§ˆì¼€íŒ… ë¬¸êµ¬ê°€ ì•„ë‹Œ ì‹¤ì œ í˜„ì—…ì—ì„œ ì“°ì´ëŠ” í•µì‹¬ ê¸°ìˆ  ìš”ì†Œë§Œ ì¶”ë ¤ ì•Œë ¤ì¤˜ ì „ë¬¸ê°€ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.',
          searchKeyword: seed + ' í•µì‹¬ ê¸°ìˆ ',
          targetPersona: 'ì‹¤ë¬´ ì¤‘ì‹¬ì˜ ì •ë³´ê°€ ê¶ê¸ˆí•œ ì‹œì²­ì'
        }
      ].forEach(function(t) {
        t.perspective = 'A';
        t.score = scoreTopic(t.searchKeyword, t.targetPersona);
        topics.push(t);
      });

      // B: Controversial (4~6)
      [
        {
          title: "'" + seed + "' ê³¼ì—° ê±°í’ˆì¼ê¹Œ, í•„ìˆ˜ íŠ¸ë Œë“œì¼ê¹Œ?",
          reason: persona + 'ì–‘ê·¹ë‹¨ì˜ ì˜ê²¬ì„ ê³µì •í•˜ê²Œ ì •ë¦¬í•´ ì‹œì²­ìê°€ ìŠ¤ìŠ¤ë¡œ íŒë‹¨í•  ìˆ˜ ìˆë„ë¡ ë•ëŠ” êµ¬ë„ë¥¼ ë§Œë“­ë‹ˆë‹¤.',
          searchKeyword: seed + ' ê±°í’ˆ ë…¼ë€',
          targetPersona: 'íŠ¸ë Œë“œì— ë’¤ì²˜ì§€ê¸° ì‹«ì§€ë§Œ ì„£ë¶ˆë¦¬ ë›°ì–´ë“¤ê¸° ë¶€ë‹´ìŠ¤ëŸ¬ìš´ ì‹œì²­ì'
        },
        {
          title: seed + ' ê·œì œì™€ ìœ¤ë¦¬ ë…¼ìŸ, ì–´ë””ê¹Œì§€ê°€ ì•ˆì „ì„ ì¸ê°€',
          reason: persona + seed + ' ê´€ë ¨ ê·œì œÂ·ìœ¤ë¦¬ ì´ìŠˆë¥¼ ì‹¤ì œ ì‚¬ë¡€ì™€ í•¨ê»˜ í’€ì–´ë‚´ì–´ ëŒ“ê¸€ í† ë¡ ì„ ìì—°ìŠ¤ëŸ½ê²Œ ìœ ë„í•©ë‹ˆë‹¤.',
          searchKeyword: seed + ' ê·œì œ ìœ¤ë¦¬',
          targetPersona: 'ì‚¬íšŒì  íŒŒê¸‰ë ¥ì„ ë”°ì§€ëŠ” ì‹œì²­ì'
        },
        {
          title: seed + 'ë¡œ ëˆ ë²„ëŠ” ì‚¬ëŒ vs ìƒëŠ” ì‚¬ëŒ, ê²°ì •ì  ì°¨ì´ í•œ ê°€ì§€',
          reason: persona + 'ì„±ê³µÂ·ì‹¤íŒ¨ ì¼€ì´ìŠ¤ë¥¼ ê·¹ë‹¨ ë¹„êµí•´ ì‹œì²­ìì˜ ê³µí¬ì™€ ìš•ë§ì„ ë™ì‹œì— ìê·¹í•˜ëŠ” êµ¬ì¡°ë¡œ ì„¤ê³„í•©ë‹ˆë‹¤.',
          searchKeyword: seed + ' ì‹¤íŒ¨ ì‚¬ë¡€',
          targetPersona: 'ë‹¹ì¥ ìˆ˜ìµí™”Â·ì„±ê³¼ì— ê´€ì‹¬ì´ í° ì‹œì²­ì'
        }
      ].forEach(function(t) {
        t.perspective = 'B';
        t.score = scoreTopic(t.searchKeyword, t.targetPersona);
        topics.push(t);
      });

      // C: How-to (7~9)
      [
        {
          title: 'í•˜ë£¨ 30ë¶„, ' + seed + 'ë¡œ ì‹œì‘í•˜ëŠ” í˜„ì‹¤ì ì¸ ì²«ê±¸ìŒ ê°€ì´ë“œ',
          reason: persona + 'ê³¼ì¥ëœ ì„±ê³µë‹´ì´ ì•„ë‹Œ, ë°”ìœ ì§ì¥ì¸ë„ ë”°ë¼ í•  ìˆ˜ ìˆëŠ” ìµœì†Œ í–‰ë™ ë£¨í‹´ë§Œ ì •ë¦¬í•´ ì¤ë‹ˆë‹¤.',
          searchKeyword: seed + ' ì‹œì‘ ë°©ë²•',
          targetPersona: 'ì‹œê°„ì´ ë¶€ì¡±í•œ ì§ì¥ì¸Â·ì´ˆë³´ì'
        },
        {
          title: 'ì‹¤íŒ¨ë¥¼ ì¤„ì´ëŠ” ' + seed + ' ì²´í¬ë¦¬ìŠ¤íŠ¸ 7ê°€ì§€',
          reason: persona + 'ì‹œì²­ìê°€ ë°”ë¡œ ìº¡ì²˜í•´ ê°ˆ ìˆ˜ ìˆëŠ” ì²´í¬ë¦¬ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ êµ¬ì„±í•´ ê³µìœ Â·ì €ì¥ì„ ìœ ë„í•©ë‹ˆë‹¤.',
          searchKeyword: seed + ' ì²´í¬ë¦¬ìŠ¤íŠ¸',
          targetPersona: 'ì‹¤ìˆ˜ ì—†ì´ ì°¨ê·¼ì°¨ê·¼ ë°°ìš°ê³  ì‹¶ì€ ì‹œì²­ì'
        },
        {
          title: 'í•œ ë‹¬ ì•ˆì— ì²´ê° ì„±ê³¼ë¥¼ ë§Œë“œëŠ” ' + seed + ' ì‹¤ì „ ë£¨í‹´',
          reason: persona + '4ì£¼ ë‹¨ìœ„ ì‹¤í–‰ ê³„íšìœ¼ë¡œ êµ¬ì¡°í™”í•´, ì‹œì²­ìê°€ ëª©í‘œì™€ ì¼ì •ì„ ëª…í™•íˆ ê·¸ë¦´ ìˆ˜ ìˆê²Œ ë„ì™€ì¤ë‹ˆë‹¤.',
          searchKeyword: seed + ' ì‹¤ì „ ë£¨í‹´',
          targetPersona: 'ë‹¨ê¸°ê°„ì— ë³€í™”ë¥¼ ë³´ê³  ì‹¶ì€ ì‹œì²­ì'
        }
      ].forEach(function(t) {
        t.perspective = 'C';
        t.score = scoreTopic(t.searchKeyword, t.targetPersona);
        topics.push(t);
      });

      // D: Future Insight (10~12)
      [
        {
          title: '3ë…„ ë’¤ ' + seed + 'ë¡œ ì¸í•´ ì‚¬ë¼ì§ˆ ì§ì—…Â·ìƒˆë¡œ ìƒê¸¸ ì¼ìë¦¬',
          reason: persona + 'ë…¸ë™ì‹œì¥ ë³€í™”ë¥¼ ì‹œë‚˜ë¦¬ì˜¤ í˜•íƒœë¡œ ì œì‹œí•´, ì‹œì²­ìê°€ ìì‹ ì˜ ì»¤ë¦¬ì–´ë¥¼ ë‹¤ì‹œ ì ê²€í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤.',
          searchKeyword: seed + ' ë¯¸ë˜ ì¼ìë¦¬ 2029',
          targetPersona: 'ì»¤ë¦¬ì–´ ë°©í–¥ì„ ê³ ë¯¼í•˜ëŠ” 20~40ëŒ€ ì‹œì²­ì'
        },
        {
          title: 'ì§€ê¸ˆ íˆ¬ìí•˜ë©´ 3ë…„ ë’¤ ê²©ì°¨ê°€ ë²Œì–´ì§ˆ ' + seed + ' í•µì‹¬ ì˜ì—­ 3ê³³',
          reason: persona + 'ì¥ê¸°ì  ê´€ì ì—ì„œ ê¸°íšŒê°€ í° ì„¸ë¶€ ì˜ì—­ì„ ì½• ì§‘ì–´ ì£¼ì–´, ì‹œì²­ìì˜ FOMOë¥¼ ê±´ê°•í•˜ê²Œ ìê·¹í•©ë‹ˆë‹¤.',
          searchKeyword: seed + ' ìœ ë§ ë¶„ì•¼ ì „ë§',
          targetPersona: 'ì„ ì œì ìœ¼ë¡œ ì›€ì§ì´ê³  ì‹¶ì€ ì„ ë„ íˆ¬ììÂ·ì°½ì—… í¬ë§ì'
        },
        {
          title: 'ì •ë¶€Â·ê¸°ì—…ì´ ì¤€ë¹„ ì¤‘ì¸ ' + seed + ' 3ë…„ ë¡œë“œë§µ ì´ì •ë¦¬',
          reason: persona + 'ê³µê°œëœ ì •ì±…Â·ë¡œë“œë§µì„ í•´ì„í•´ ì£¼ë©°, ë‹¨ìˆœ ë‰´ìŠ¤ ìš”ì•½ì„ ë„˜ëŠ” ì „ëµì  í•´ì„ì„ ì œê³µí•©ë‹ˆë‹¤.',
          searchKeyword: seed + ' ì •ì±… ë¡œë“œë§µ',
          targetPersona: 'ì •ì±… ë³€í™”ì— ë¯¼ê°í•œ ì‹¤ë¬´ìÂ·ì‚¬ì—…ê°€'
        }
      ].forEach(function(t) {
        t.perspective = 'D';
        t.score = scoreTopic(t.searchKeyword, t.targetPersona);
        topics.push(t);
      });

      // E: Myth Busting (13~15)
      [
        {
          title: "'" + seed + "' í•˜ë©´ ë‹¤ë“¤ ì°©ê°í•˜ëŠ” ëŒ€í‘œ ì˜¤í•´ 5ê°€ì§€",
          reason: persona + 'ì»¤ë®¤ë‹ˆí‹°Â·ëŒ“ê¸€ì—ì„œ ìì£¼ ë³´ì´ëŠ” ì˜¤í•´ë¥¼ ì •ë¦¬í•´ ì£¼ë©°, ì‹œì²­ìì˜ ê¶ê¸ˆì¦ì„ ì‹œì›í•˜ê²Œ í•´ì†Œí•©ë‹ˆë‹¤.',
          searchKeyword: seed + ' ì˜¤í•´ ì§„ì‹¤',
          targetPersona: 'ì •ë³´ ê³¼ì‰ ì†ì—ì„œ ë¬´ì—‡ì´ ë§ëŠ”ì§€ í—·ê°ˆë¦¬ëŠ” ì‹œì²­ì'
        },
        {
          title: "ì „ë¬¸ê°€ê°€ ì§ì ‘ ì§šì–´ì£¼ëŠ” '" + seed + "' ê´€ë ¨ ëŒ€í‘œ ë‚šì‹œ ì½˜í…ì¸  êµ¬ë³„ë²•",
          reason: persona + 'ê³¼ì¥ëœ ì¸ë„¤ì¼Â·ë–¡ë½/ë–¡ìƒ ì½˜í…ì¸ ë¥¼ ì‚¬ë¡€ë¡œ ë³´ì—¬ì£¼ë©°, ì‹œì²­ìê°€ ìŠ¤ìŠ¤ë¡œ íŒë³„í•˜ëŠ” ê¸°ì¤€ì„ ì•Œë ¤ì¤ë‹ˆë‹¤.',
          searchKeyword: seed + ' ì§„ì§œ ì •ë³´ êµ¬ë³„',
          targetPersona: 'ìœ íŠœë¸ŒÂ·SNS ì •ë³´ì— í”¼ë¡œê°ì„ ëŠë¼ëŠ” ì‹œì²­ì'
        },
        {
          title: "'" + seed + "' ì‹œì‘í•˜ê¸°ì— ëŠ¦ì—ˆë‹¤ëŠ” ë§ì´ í‹€ë¦° ì´ìœ ",
          reason: persona + 'ì—°ë ¹Â·ê²½ë ¥ê³¼ ìƒê´€ì—†ì´ ì§€ê¸ˆ ë›°ì–´ë“¤ì–´ë„ ë˜ëŠ” êµ¬ì²´ì  ê·¼ê±°ë¥¼ ì œì‹œí•´ í–‰ë™ì„ ìœ ë„í•©ë‹ˆë‹¤.',
          searchKeyword: seed + ' ì§€ê¸ˆ ì‹œì‘ ëŠ¦ì—ˆë‚˜',
          targetPersona: 'ì‹œë‹ˆì–´Â·ê²½ë ¥ ì „í™˜ì„ ê³ ë¯¼í•˜ëŠ” ì‹œì²­ì'
        }
      ].forEach(function(t) {
        t.perspective = 'E';
        t.score = scoreTopic(t.searchKeyword, t.targetPersona);
        topics.push(t);
      });

      // ë‚´ë¶€ ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì†ŒíŠ¸ í›„ ìƒìœ„ 15ê°œë§Œ ì‚¬ìš©
      topics.sort(function(a, b) { return (b.score || 0) - (a.score || 0); });
      return topics.slice(0, 15);
    }

    function generateAiTopics() {
      var ctx = getBaseContext();
      return buildPerspectiveTopics(ctx);
    }

    function renderAiTopicResults(topics) {
      if (!aiTopicListEl) return;
      if (!topics || !topics.length) {
        aiTopicListEl.innerHTML = '<div class="ai-topic-empty">ìƒì„±ëœ ì£¼ì œê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € AI ë¶„ì„ ì£¼ì œ ìƒì„±í•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.</div>';
        if (aiResultSectionEl) aiResultSectionEl.style.display = 'block';
        return;
      }
      aiTopicListEl.innerHTML = topics
        .map(function(topic, idx) {
          var safeTitle = (topic.title || '').replace(/"/g, '&quot;');
          var safeReason = (topic.reason || '').replace(/"/g, '&quot;');
          return (
            '<button type="button" class="ai-topic-item" data-index="' +
            idx +
            '">' +
            '<span class="ai-topic-index">' +
            (idx + 1) +
            '</span>' +
            '<div class="ai-topic-text">' +
            '<div class="ai-topic-title">' +
            safeTitle +
            '</div>' +
            '<div class="ai-topic-reason">' +
            safeReason +
            '</div>' +
            '</div>' +
            '</button>'
          );
        })
        .join('');
      if (aiResultSectionEl) aiResultSectionEl.style.display = 'block';
    }

    function clearTrendSelection() {
      globalState.selectedTopics = [];
      document.querySelectorAll('.topic-card.selected').forEach(function(card) {
        card.classList.remove('selected');
      });
      // ì„ íƒ í•´ì œ ì‹œ ë°°ê²½ìƒ‰ ì œê±°
      updateFormBackground();
      // ì„ íƒ í•´ì œ ì‹œ ì¦‰ì‹œ ë°˜ëŒ€í¸ ì ê¸ˆ í•´ì œ
      syncMutualExclusion();
    }
    function clearKeywordSelection() {
      globalState.selectedCategory = null;
      globalState.keyword = '';
      if (keywordInputEl) keywordInputEl.value = '';
      document.querySelectorAll('.topic-icon-item.selected').forEach(function(item) {
        item.classList.remove('selected');
      });
      // ì„ íƒ í•´ì œ ì‹œ ë°°ê²½ìƒ‰ ì œê±°
      updateFormBackground();
      // ì„ íƒ í•´ì œ ì‹œ ì¦‰ì‹œ ë°˜ëŒ€í¸ ì ê¸ˆ í•´ì œ
      syncMutualExclusion();
    }

    function setTrendDisabled(disabled) {
      document.querySelectorAll('.topic-tab').forEach(function(btn) {
        btn.disabled = !!disabled;
      });
      document.querySelectorAll('.topic-card').forEach(function(card) {
        if (disabled) {
          card.classList.add('disabled');
          card.style.opacity = '0.45';
          card.style.pointerEvents = 'none';
        } else {
          card.classList.remove('disabled');
          card.style.opacity = '1';
          card.style.pointerEvents = 'auto';
        }
      });
    }
    function setKeywordDisabled(disabled) {
      document.querySelectorAll('.topic-type-tab').forEach(function(btn) {
        if (btn.classList.contains('btn-clear-selection')) return; // ì„ íƒ í•´ì œ ë²„íŠ¼ì€ ì œì™¸
        btn.disabled = !!disabled;
      });
      document.querySelectorAll('.topic-icon-item').forEach(function(item) {
        if (disabled) {
          item.classList.add('disabled');
          item.style.opacity = '0.45';
          item.style.pointerEvents = 'none';
        } else {
          item.classList.remove('disabled');
          item.style.opacity = '1';
          item.style.pointerEvents = 'auto';
        }
      });
      if (keywordInputEl) keywordInputEl.disabled = !!disabled;
    }

    function isKeywordModeActive() {
      return !!(globalState.selectedCategory || (keywordInputEl && keywordInputEl.value.trim()));
    }
    function isTrendModeActive() {
      return (globalState.selectedTopics || []).length > 0;
    }

    function syncMutualExclusion() {
      if (isKeywordModeActive()) {
        setTrendDisabled(true);
        setKeywordDisabled(false);
      } else if (isTrendModeActive()) {
        setKeywordDisabled(true);
        setTrendDisabled(false);
      } else {
        setKeywordDisabled(false);
        setTrendDisabled(false);
      }
      updateFormBackground();
    }

    // ì„ íƒ íš¨ê³¼: í‚¤ì›Œë“œ ì…ë ¥ì°½ ë°°ê²½
    function updateFormBackground() {
      var hasSelection = isKeywordModeActive() || isTrendModeActive();
      if (keywordInputEl) {
        keywordInputEl.style.background = hasSelection ? '#ffeef5' : '#fff';
        keywordInputEl.style.borderColor = hasSelection ? '#ffb3d9' : '#cbd5e0';
      }
    }

    // ì„ íƒ í•´ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    var btnClearSelection = document.getElementById('btnClearTopicSelection');
    if (btnClearSelection) {
      btnClearSelection.addEventListener('click', function() {
        // í‚¤ì›Œë“œ ì„ ì • ì„¹ì…˜ ì„ íƒ í•´ì œ
        clearKeywordSelection();
        
        // ë¡œë”© ìƒíƒœ ì´ˆê¸°í™”
        isLoadingState.weekly = false;
        isLoadingState.daily = false;
        
        // ë°ì´í„° ë¦¬í”„ë ˆì‹œ
        var activeTab = document.querySelector('.topic-tab.active');
        if (activeTab) {
          var tabType = activeTab.getAttribute('data-tab');
          if (tabType === 'weekly') {
            loadWeeklyTopics();
          } else if (tabType === 'daily') {
            loadDailyTopics();
          }
        }
        
        saveGlobalState();
      });
    }

    // ì£¼ì œ ì•„ì´ì½˜ ì„ íƒ (ì´ë²¤íŠ¸ ìœ„ì„)
    document.addEventListener('click', function(e) {
      var icon = e.target.closest('.topic-icon-item');
      if (!icon) return;
      if (icon.classList.contains('disabled')) return;

      // í‚¤ì›Œë“œ ì„ íƒ ì‹œ íŠ¸ë Œë“œ ì„ íƒì€ ë¶ˆê°€ (ìƒí˜¸ë°°íƒ€)
      clearTrendSelection();

      document.querySelectorAll('.topic-icon-item').forEach(function(i) {
        i.classList.remove('selected');
      });
      icon.classList.add('selected');
      globalState.selectedCategory = icon.getAttribute('data-category');
      saveGlobalState();
      syncMutualExclusion();
    });

    // í‚¤ì›Œë“œ ì…ë ¥ ì‹œ íŠ¸ë Œë“œ ì„ íƒ ë¹„í™œì„±í™”
    if (keywordInputEl) {
      keywordInputEl.addEventListener('input', function() {
        globalState.keyword = (keywordInputEl.value || '').trim();
        if (globalState.keyword) {
          clearTrendSelection();
        }
        saveGlobalState();
        syncMutualExclusion();
      });
    }

    // í† í”½ ì¹´ë“œ ì„ íƒ (ì´ë²¤íŠ¸ ìœ„ì„) - ë‹¨ì¼ ì„ íƒ ëª¨ë“œ
    if (topicsGridEl) {
      topicsGridEl.addEventListener('click', function(e) {
        var card = e.target.closest('.topic-card');
        if (!card) return;
        if (card.classList.contains('disabled')) return;

        // íŠ¸ë Œë“œ ì„ íƒ ì‹œ í‚¤ì›Œë“œ ì„ ì •ì€ ë¶ˆê°€ (ìƒí˜¸ë°°íƒ€)
        if (isKeywordModeActive()) return;
        clearKeywordSelection();

        var topicTitleEl = card.querySelector('.topic-title');
        var topicTitle = topicTitleEl ? topicTitleEl.textContent : '';
        var wasSelected = card.classList.contains('selected');

        // ì´ì „ ì„ íƒ ìƒíƒœ ì´ˆê¸°í™” (í•­ìƒ 1ê°œë§Œ ì„ íƒë˜ë„ë¡)
        document.querySelectorAll('.topic-card.selected').forEach(function(c) {
          c.classList.remove('selected');
        });
        globalState.selectedTopics = [];

        // ì´ë¯¸ ì„ íƒëœ ì¹´ë“œë¥¼ ë‹¤ì‹œ ëˆ„ë¥´ë©´ ì„ íƒ í•´ì œ, ì•„ë‹ˆë©´ í•´ë‹¹ ì¹´ë“œë§Œ ì„ íƒ
        if (!wasSelected) {
          card.classList.add('selected');
          globalState.selectedTopics = [topicTitle];
        }

        saveGlobalState();
        syncMutualExclusion();
      });
    }

    // ===== ì£¼ê°„/ì¼ê°„ íƒ­ ë° ë°ì´í„° ë Œë”ë§ =====
    var topicsHeaderEl = document.getElementById('topicsHeader');
    var topicsDateEl = document.getElementById('topicsDate');
    var dataFooterEl = document.getElementById('dataFooter');
    var weeklyGridSnapshot = '';

    function formatDateYYYYMMDD(d) {
      return d.getFullYear() + '.' + String(d.getMonth() + 1).padStart(2, '0') + '.' + String(d.getDate()).padStart(2, '0');
    }

    function setTopicsMeta(type, customDate) {
      if (!topicsHeaderEl || !topicsDateEl) return;
      if (type === 'weekly') {
        topicsHeaderEl.textContent = 'ì£¼ê°„ ê¸‰ìƒìŠ¹ í† í”½ TOP 20 âš¡ğŸ”¥';
        if (customDate) {
          topicsDateEl.textContent = 'ì ìš©: ' + customDate;
        } else {
          // í˜„ì¬ ì£¼ì˜ ë‚ ì§œ ë²”ìœ„ ê³„ì‚°
          var today = new Date();
          var dayOfWeek = today.getDay();
          var diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
          var weekStart = new Date(today.setDate(diff));
          var weekEnd = new Date(weekStart);
          weekEnd.setDate(weekEnd.getDate() + 6);
          topicsDateEl.textContent = 'ì ìš©: ' + formatDateYYYYMMDD(weekStart) + ' ~ ' + formatDateYYYYMMDD(weekEnd);
        }
      } else {
        topicsHeaderEl.textContent = 'ì¼ê°„ í•«ì´ìŠˆ TOP 20 ğŸ”¥';
        if (customDate) {
          topicsDateEl.textContent = 'ì ìš©: ' + customDate;
        } else {
          var today = new Date();
          topicsDateEl.textContent = 'ì ìš©: ' + formatDateYYYYMMDD(today);
        }
      }
    }

    function getRelatedKeywords(title) {
      var map = {
        'OpenAI Sora 3.0 ë¦¬ë·°': ['OpenAI','Sora','ì˜ìƒAI','ë¦¬ë·°'],
        'GTA VI íˆë“  í€˜ìŠ¤íŠ¸ ê³µëµ': ['GTA6','íˆë“ í€˜ìŠ¤íŠ¸','ê³µëµ','íŒ'],
        'ì´ˆì €ê°€ ë‹¤ì´ì†Œ ê¿€í…œ ê¿€': ['ë‹¤ì´ì†Œ','ê¿€í…œ','ì €ê°€','ì¶”ì²œ'],
        'ì˜¬í•´ ìµœê³ ì˜ K-POP ì»´ë°±': ['K-POP','ì»´ë°±','ì‹ ê³¡','íŠ¸ë Œë“œ'],
        'í”„ë¦¬ë¯¸ì–´ë¦¬ê·¸ ê²½ê¸° í•˜ì´ë¼ì´íŠ¸': ['í”„ë¦¬ë¯¸ì–´ë¦¬ê·¸','í•˜ì´ë¼ì´íŠ¸','ê³¨ëª¨ìŒ','ì¶•êµ¬'],
        'ì§‘ì—ì„œ ë§Œë“œëŠ” ê°„ë‹¨ ë ˆì‹œí”¼': ['ìì·¨ìš”ë¦¬','ê°„ë‹¨ë ˆì‹œí”¼','ì§‘ë°¥','ìš”ë¦¬'],
        'ChatGPT 5 í™œìš© ê¿€íŒ': ['ChatGPT','ì—…ë¬´ìë™í™”','í”„ë¡¬í”„íŠ¸','í™œìš©'],
        'ì—ë¥´ë‹¤ ì „ì„¤ ê³µëµ': ['ì—ë¥´ë‹¤','ê³µëµ','ë¹Œë“œ','ê²Œì„íŒ'],
        '2026 íŠ¸ë Œë“œ ì½”ë””': ['íŒ¨ì…˜','ì½”ë””','íŠ¸ë Œë“œ','ë£©ë¶'],
        'ë„·í”Œë¦­ìŠ¤ ì‹ ì‘ ë“œë¼ë§ˆ': ['ë„·í”Œë¦­ìŠ¤','ì‹ ì‘','ë“œë¼ë§ˆ','ì¶”ì²œ'],
        'NBA ì˜¬ìŠ¤íƒ€ ìœ„í¬': ['NBA','ì˜¬ìŠ¤íƒ€','í•˜ì´ë¼ì´íŠ¸','ë†êµ¬'],
        'ë‹¤ì´ì–´íŠ¸ ì‹ë‹¨ ì¶”ì²œ': ['ë‹¤ì´ì–´íŠ¸','ì‹ë‹¨','ì €ì¹¼ë¡œë¦¬','ë ˆì‹œí”¼'],
        'í´ë¼ìš°ë“œ AI ë¹„êµ': ['í´ë¼ìš°ë“œ','AI','ë¹„êµ','ê°€ì´ë“œ'],
        'ìŠ¤íŒ€ ê²¨ìš¸ ì„¸ì¼': ['ìŠ¤íŒ€','ì„¸ì¼','í• ì¸','ì¶”ì²œê²Œì„'],
        'ë¯¸ë‹ˆë©€ ì¸í…Œë¦¬ì–´': ['ì¸í…Œë¦¬ì–´','ë¯¸ë‹ˆë©€','ì •ë¦¬','ì§‘ê¾¸ë¯¸ê¸°'],
        'ì˜í™” OST ëª¨ìŒ': ['ì˜í™”OST','í”Œë ˆì´ë¦¬ìŠ¤íŠ¸','ê°ì„±','ìŒì•…'],
        'ë§ˆë¼í†¤ ì¤€ë¹„ ìš´ë™ë²•': ['ë§ˆë¼í†¤','ëŸ¬ë‹','ìŠ¤íŠ¸ë ˆì¹­','í›ˆë ¨'],
        'ì¹´í˜ ë©”ë‰´ ì¶”ì²œ': ['ì¹´í˜','ë©”ë‰´','ì¶”ì²œ','ë””ì €íŠ¸'],
        'ìŠ¤ë§ˆíŠ¸í° ë¹„êµ ë¦¬ë·°': ['ìŠ¤ë§ˆíŠ¸í°','ë¹„êµ','ì¹´ë©”ë¼','ìŠ¤í™'],
        'ì¸ë”” ê²Œì„ ì¶”ì²œ': ['ì¸ë””ê²Œì„','ì¶”ì²œ','ì‹ ì‘','ë¦¬ë·°']
      };
      if (map[title]) return map[title];
      // fallback: ë‹¨ì–´ ê¸°ë°˜
      var words = (title || '').split(/\s+/).filter(Boolean).slice(0, 4);
      return words.length ? words : ['íŠ¸ë Œë“œ','ì¶”ì²œ','í•«ì´ìŠˆ'];
    }

    function attachKeywordsToExistingWeeklyCards() {
      document.querySelectorAll('#topicsGrid .topic-card').forEach(function(card) {
        var titleEl = card.querySelector('.topic-title');
        if (!titleEl) return;
        if (card.querySelector('.topic-keywords')) return;
        var kw = getRelatedKeywords(titleEl.textContent);
        var kwWrap = document.createElement('div');
        kwWrap.className = 'topic-keywords';
        kw.forEach(function(k) {
          var chip = document.createElement('span');
          chip.className = 'topic-keyword';
          chip.textContent = k;
          kwWrap.appendChild(chip);
        });
        var content = card.querySelector('.topic-content');
        if (content) content.appendChild(kwWrap);
      });
    }

    // íŠ¸ë Œë“œ ì£¼ì œ ìš°ì„  ì •ë ¬ ë° ë°°ì§€ ì¶”ê°€
    async function enrichTopicsWithTrends(topics) {
      try {
        // ì‹œì¦Œë³„ ì£¼ì œ ê°€ì ¸ì˜¤ê¸°
        var seasonalResponse = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/trends/seasonal');
        var seasonalData = seasonalResponse.ok ? await seasonalResponse.json() : null;
        
        // ì‹¤ì‹œê°„ íŠ¸ë Œë“œ ê°€ì ¸ì˜¤ê¸°
        var trendsResponse = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/trends/realtime');
        var trendsData = trendsResponse.ok ? await trendsResponse.json() : null;
        
        // ì£¼ì œì— íŠ¸ë Œë“œ ì •ë³´ ì¶”ê°€
        if (topics && Array.isArray(topics)) {
          topics.forEach(function(topic) {
            // ì‹œì¦Œë³„ ì£¼ì œ ë§¤ì¹­
            if (seasonalData && seasonalData.topics) {
              var seasonalMatch = seasonalData.topics.find(function(st) {
                return st.title && topic.title && topic.title.includes(st.title.substring(0, 10));
              });
              if (seasonalMatch) {
                topic.badge = seasonalMatch.badge || 'ğŸ‚ ì‹œì¦Œ ì¶”ì²œ';
                topic.priority = seasonalMatch.priority || 1;
                topic.isSeasonal = true;
              }
            }
            
            // ì‹¤ì‹œê°„ íŠ¸ë Œë“œ ë§¤ì¹­
            if (trendsData && trendsData.trends) {
              var trendMatch = trendsData.trends.find(function(rt) {
                return rt.keyword && topic.title && topic.title.toLowerCase().includes(rt.keyword.toLowerCase());
              });
              if (trendMatch && trendMatch.trend === 'hot') {
                topic.badge = 'âš¡ íŠ¸ë Œë“œ ê¸‰ìƒìŠ¹';
                topic.priority = 0; // ìµœìš°ì„ 
                topic.isTrending = true;
              } else if (trendMatch && trendMatch.trend === 'rising') {
                if (!topic.badge) {
                  topic.badge = 'ğŸ“ˆ íŠ¸ë Œë“œ ìƒìŠ¹';
                  topic.priority = topic.priority || 2;
                }
              }
            }
          });
          
          // ìš°ì„ ìˆœìœ„ë³„ ì •ë ¬ (priorityê°€ ë‚®ì„ìˆ˜ë¡ ìš°ì„ )
          topics.sort(function(a, b) {
            var aPriority = a.priority !== undefined ? a.priority : 999;
            var bPriority = b.priority !== undefined ? b.priority : 999;
            return aPriority - bPriority;
          });
        }
      } catch (error) {
        console.warn('[Trends] íŠ¸ë Œë“œ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        // ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
      }
      
      return topics;
    }

    async function renderTopics(topics) {
      if (!topicsGridEl) return;
      
      if (!topics || topics.length === 0) {
        showErrorMessage('í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      
      // íŠ¸ë Œë“œ ì •ë³´ë¡œ ì£¼ì œ ê°•í™”
      topics = await enrichTopicsWithTrends(topics);
      
      topicsGridEl.innerHTML = topics.map(function(t, idx) {
        // API ë°ì´í„° êµ¬ì¡°ì— ë§ê²Œ ë§¤í•‘
        var title = t.title || t.name || '';
        var categoryClass = t.categoryClass || (t.category ? 'cat-' + t.category.toLowerCase().replace(/\s+/g, '-') : '');
        var categoryLabel = t.categoryLabel || t.category || 'ê¸°íƒ€';
        var views = t.views || t.viewCount || t.viewsCount || '0';
        var keywords = t.keywords || t.tags || [];
        var badge = t.badge || '';
        
        // í‚¤ì›Œë“œê°€ ë¬¸ìì—´ ë°°ì—´ì´ ì•„ë‹Œ ê²½ìš° ì²˜ë¦¬
        if (typeof keywords === 'string') {
          keywords = keywords.split(',').map(function(k) { return k.trim(); });
        }
        
        var kws = keywords.map(function(k) {
          return '<span class="topic-keyword">' + (k || '').replace(/[<>]/g, '') + '</span>';
        }).join('');
        
        var badgeHtml = badge ? '<span class="topic-badge" style="display: inline-block; margin-left: 6px; padding: 2px 6px; background: ' + 
                              (badge.includes('ê¸‰ìƒìŠ¹') ? '#fef3c7' : '#e0e7ff') + '; color: ' + 
                              (badge.includes('ê¸‰ìƒìŠ¹') ? '#92400e' : '#3730a3') + '; border-radius: 4px; font-size: 10px; font-weight: 600;">' + 
                              badge + '</span>' : '';
        
        return '<div class="topic-card" data-title="' + title.replace(/"/g, '&quot;') + '" ' +
               (t.isTrending || t.isSeasonal ? 'style="border: 2px solid ' + (t.isTrending ? '#fbbf24' : '#a78bfa') + ';"' : '') + '>' +
          '<span class="topic-num">' + (idx + 1) + '</span>' +
          '<div class="topic-content">' +
            '<div class="topic-title">' + title + badgeHtml + '</div>' +
            '<div class="topic-meta">' +
              '<span class="topic-category ' + categoryClass + '">' + categoryLabel + '</span>' +
              '<span class="topic-views">' + views + '</span>' +
            '</div>' +
            (kws ? '<div class="topic-keywords">' + kws + '</div>' : '') +
          '</div>' +
        '</div>';
      }).join('');
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ì—°ê²° (ë™ì ìœ¼ë¡œ ìƒì„±ëœ ì¹´ë“œì— ëŒ€í•´)
      syncMutualExclusion();
    }

    // API ì—”ë“œí¬ì¸íŠ¸ ì„¤ì • (server 4000 í˜¸ì¶œ)
    var API_BASE = window.__API_BASE__ || 'http://localhost:4000';
    var API_ENDPOINTS = {
      weekly: API_BASE + '/api/topics/weekly',
      daily: API_BASE + '/api/topics/daily'
    };

    // ë¡œë”© ìƒíƒœ ê´€ë¦¬
    var isLoadingState = {
      weekly: false,
      daily: false
    };

    // ìºì‹œ ë°ì´í„° ì €ì¥ì†Œ
    var cachedData = {
      weekly: null,
      daily: null
    };

    // Mock Data (ê¸°ë³¸ ë°ì´í„°)
    function getMockWeeklyTopics() {
      var today = new Date();
      var dayOfWeek = today.getDay();
      var diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
      var weekStart = new Date(today);
      weekStart.setDate(weekStart.getDate() + diff - today.getDate());
      var weekEnd = new Date(weekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);
      
      return {
        topics: [
          { title: 'OpenAI Sora 3.0 ë¦¬ë·°', categoryClass: 'cat-tech', categoryLabel: 'í…Œí¬/AI', views: '350ë§Œ+', keywords: ['OpenAI', 'Sora', 'ì˜ìƒAI', 'ë¦¬ë·°'] },
          { title: 'GTA VI íˆë“  í€˜ìŠ¤íŠ¸ ê³µëµ', categoryClass: 'cat-game', categoryLabel: 'ê²Œì„', views: '280ë§Œ+', keywords: ['GTA6', 'íˆë“ í€˜ìŠ¤íŠ¸', 'ê³µëµ', 'íŒ'] },
          { title: 'ì´ˆì €ê°€ ë‹¤ì´ì†Œ ê¿€í…œ', categoryClass: 'cat-life', categoryLabel: 'ë¼ì´í”„/ì‡¼í•‘', views: '210ë§Œ+', keywords: ['ë‹¤ì´ì†Œ', 'ê¿€í…œ', 'ì €ê°€', 'ì¶”ì²œ'] },
          { title: 'ì˜¬í•´ ìµœê³ ì˜ K-POP ì»´ë°±', categoryClass: 'cat-ent', categoryLabel: 'ì—”í„°í…Œì¸ë¨¼íŠ¸', views: '190ë§Œ+', keywords: ['K-POP', 'ì»´ë°±', 'ì‹ ê³¡', 'íŠ¸ë Œë“œ'] },
          { title: 'í”„ë¦¬ë¯¸ì–´ë¦¬ê·¸ ê²½ê¸° í•˜ì´ë¼ì´íŠ¸', categoryClass: 'cat-sport', categoryLabel: 'ìŠ¤í¬ì¸ ', views: '170ë§Œ+', keywords: ['í”„ë¦¬ë¯¸ì–´ë¦¬ê·¸', 'í•˜ì´ë¼ì´íŠ¸', 'ê³¨ëª¨ìŒ', 'ì¶•êµ¬'] },
          { title: 'ì§‘ì—ì„œ ë§Œë“œëŠ” ê°„ë‹¨ ë ˆì‹œí”¼', categoryClass: 'cat-food', categoryLabel: 'í‘¸ë“œ', views: '150ë§Œ+', keywords: ['ìì·¨ìš”ë¦¬', 'ê°„ë‹¨ë ˆì‹œí”¼', 'ì§‘ë°¥', 'ìš”ë¦¬'] },
          { title: 'ChatGPT 5 í™œìš© ê¿€íŒ', categoryClass: 'cat-tech', categoryLabel: 'í…Œí¬/AI', views: '140ë§Œ+', keywords: ['ChatGPT', 'ì—…ë¬´ìë™í™”', 'í”„ë¡¬í”„íŠ¸', 'í™œìš©'] },
          { title: 'ì—ë¥´ë‹¤ ì „ì„¤ ê³µëµ', categoryClass: 'cat-game', categoryLabel: 'ê²Œì„', views: '130ë§Œ+', keywords: ['ì—ë¥´ë‹¤', 'ê³µëµ', 'ë¹Œë“œ', 'ê²Œì„íŒ'] },
          { title: '2026 íŠ¸ë Œë“œ ì½”ë””', categoryClass: 'cat-life', categoryLabel: 'ë¼ì´í”„/ì‡¼í•‘', views: '120ë§Œ+', keywords: ['íŒ¨ì…˜', 'ì½”ë””', 'íŠ¸ë Œë“œ', 'ë£©ë¶'] },
          { title: 'ë„·í”Œë¦­ìŠ¤ ì‹ ì‘ ë“œë¼ë§ˆ', categoryClass: 'cat-ent', categoryLabel: 'ì—”í„°í…Œì¸ë¨¼íŠ¸', views: '110ë§Œ+', keywords: ['ë„·í”Œë¦­ìŠ¤', 'ì‹ ì‘', 'ë“œë¼ë§ˆ', 'ì¶”ì²œ'] },
          { title: 'NBA ì˜¬ìŠ¤íƒ€ ìœ„í¬', categoryClass: 'cat-sport', categoryLabel: 'ìŠ¤í¬ì¸ ', views: '100ë§Œ+', keywords: ['NBA', 'ì˜¬ìŠ¤íƒ€', 'í•˜ì´ë¼ì´íŠ¸', 'ë†êµ¬'] },
          { title: 'ë‹¤ì´ì–´íŠ¸ ì‹ë‹¨ ì¶”ì²œ', categoryClass: 'cat-food', categoryLabel: 'í‘¸ë“œ', views: '95ë§Œ+', keywords: ['ë‹¤ì´ì–´íŠ¸', 'ì‹ë‹¨', 'ì €ì¹¼ë¡œë¦¬', 'ë ˆì‹œí”¼'] },
          { title: 'í´ë¼ìš°ë“œ AI ë¹„êµ', categoryClass: 'cat-tech', categoryLabel: 'í…Œí¬/AI', views: '90ë§Œ+', keywords: ['í´ë¼ìš°ë“œ', 'AI', 'ë¹„êµ', 'ê°€ì´ë“œ'] },
          { title: 'ìŠ¤íŒ€ ê²¨ìš¸ ì„¸ì¼', categoryClass: 'cat-game', categoryLabel: 'ê²Œì„', views: '85ë§Œ+', keywords: ['ìŠ¤íŒ€', 'ì„¸ì¼', 'í• ì¸', 'ì¶”ì²œê²Œì„'] },
          { title: 'ë¯¸ë‹ˆë©€ ì¸í…Œë¦¬ì–´', categoryClass: 'cat-life', categoryLabel: 'ë¼ì´í”„/ì‡¼í•‘', views: '80ë§Œ+', keywords: ['ì¸í…Œë¦¬ì–´', 'ë¯¸ë‹ˆë©€', 'ì •ë¦¬', 'ì§‘ê¾¸ë¯¸ê¸°'] },
          { title: 'ì˜í™” OST ëª¨ìŒ', categoryClass: 'cat-ent', categoryLabel: 'ì—”í„°í…Œì¸ë¨¼íŠ¸', views: '75ë§Œ+', keywords: ['ì˜í™”OST', 'í”Œë ˆì´ë¦¬ìŠ¤íŠ¸', 'ê°ì„±', 'ìŒì•…'] },
          { title: 'ë§ˆë¼í†¤ ì¤€ë¹„ ìš´ë™ë²•', categoryClass: 'cat-sport', categoryLabel: 'ìŠ¤í¬ì¸ ', views: '70ë§Œ+', keywords: ['ë§ˆë¼í†¤', 'ëŸ¬ë‹', 'ìŠ¤íŠ¸ë ˆì¹­', 'í›ˆë ¨'] },
          { title: 'ì¹´í˜ ë©”ë‰´ ì¶”ì²œ', categoryClass: 'cat-food', categoryLabel: 'í‘¸ë“œ', views: '65ë§Œ+', keywords: ['ì¹´í˜', 'ë©”ë‰´', 'ì¶”ì²œ', 'ë””ì €íŠ¸'] },
          { title: 'ìŠ¤ë§ˆíŠ¸í° ë¹„êµ ë¦¬ë·°', categoryClass: 'cat-tech', categoryLabel: 'í…Œí¬/AI', views: '60ë§Œ+', keywords: ['ìŠ¤ë§ˆíŠ¸í°', 'ë¹„êµ', 'ì¹´ë©”ë¼', 'ìŠ¤í™'] },
          { title: 'ì¸ë”” ê²Œì„ ì¶”ì²œ', categoryClass: 'cat-game', categoryLabel: 'ê²Œì„', views: '55ë§Œ+', keywords: ['ì¸ë””ê²Œì„', 'ì¶”ì²œ', 'ì‹ ì‘', 'ë¦¬ë·°'] }
        ],
        dateRange: formatDateYYYYMMDD(weekStart) + ' ~ ' + formatDateYYYYMMDD(weekEnd),
        lastUpdated: new Date().toISOString()
      };
    }

    function getMockDailyTopics() {
      var today = new Date();
      return {
        topics: [
          { title: 'ì˜¤ëŠ˜ì˜ AI í•«íˆ´ ì—…ë°ì´íŠ¸', categoryClass: 'cat-tech', categoryLabel: 'í…Œí¬/AI', views: '120ë§Œ+', keywords: ['ì‹ ê¸°ëŠ¥', 'íˆ´ì¶”ì²œ', 'ìë™í™”', 'ì—…ë°ì´íŠ¸'] },
          { title: 'Top 10 ì†Œë¹„ íŠ¸ë Œë“œ', categoryClass: 'cat-life', categoryLabel: 'ë¼ì´í”„/ì‡¼í•‘', views: '98ë§Œ+', keywords: ['Top10', 'ì†Œë¹„', 'íŠ¸ë Œë“œ', 'ì‡¼í•‘'] },
          { title: 'ìµœì‹  ê²Œì„ ì—…ë°ì´íŠ¸', categoryClass: 'cat-game', categoryLabel: 'ê²Œì„', views: '85ë§Œ+', keywords: ['ê²Œì„', 'ì—…ë°ì´íŠ¸', 'ì‹ ì‘', 'ë¦¬ë·°'] },
          { title: 'ì¼ì¼ ì—”í„°í…Œì¸ë¨¼íŠ¸ ë‰´ìŠ¤', categoryClass: 'cat-ent', categoryLabel: 'ì—”í„°í…Œì¸ë¨¼íŠ¸', views: '75ë§Œ+', keywords: ['ì—”í„°', 'ë‰´ìŠ¤', 'ìµœì‹ ', 'ì´ìŠˆ'] },
          { title: 'ì˜¤ëŠ˜ì˜ ìŠ¤í¬ì¸  í•˜ì´ë¼ì´íŠ¸', categoryClass: 'cat-sport', categoryLabel: 'ìŠ¤í¬ì¸ ', views: '65ë§Œ+', keywords: ['ìŠ¤í¬ì¸ ', 'í•˜ì´ë¼ì´íŠ¸', 'ê²½ê¸°', 'ë‰´ìŠ¤'] },
          { title: 'ì¼ì¼ í‘¸ë“œ íŠ¸ë Œë“œ', categoryClass: 'cat-food', categoryLabel: 'í‘¸ë“œ', views: '55ë§Œ+', keywords: ['í‘¸ë“œ', 'íŠ¸ë Œë“œ', 'ë ˆì‹œí”¼', 'ì¶”ì²œ'] },
          { title: 'ì˜¤ëŠ˜ì˜ í…Œí¬ ë‰´ìŠ¤', categoryClass: 'cat-tech', categoryLabel: 'í…Œí¬/AI', views: '50ë§Œ+', keywords: ['í…Œí¬', 'ë‰´ìŠ¤', 'IT', 'ìµœì‹ '] },
          { title: 'ì¼ì¼ ê²Œì„ ë¦¬ë·°', categoryClass: 'cat-game', categoryLabel: 'ê²Œì„', views: '48ë§Œ+', keywords: ['ê²Œì„', 'ë¦¬ë·°', 'í‰ê°€', 'ì¶”ì²œ'] },
          { title: 'ì˜¤ëŠ˜ì˜ ì‡¼í•‘ ì •ë³´', categoryClass: 'cat-life', categoryLabel: 'ë¼ì´í”„/ì‡¼í•‘', views: '45ë§Œ+', keywords: ['ì‡¼í•‘', 'í• ì¸', 'ì •ë³´', 'ì¶”ì²œ'] },
          { title: 'ì¼ì¼ ì—”í„° ì†Œì‹', categoryClass: 'cat-ent', categoryLabel: 'ì—”í„°í…Œì¸ë¨¼íŠ¸', views: '42ë§Œ+', keywords: ['ì—”í„°', 'ì†Œì‹', 'ì—°ì˜ˆ', 'ë‰´ìŠ¤'] },
          { title: 'ì˜¤ëŠ˜ì˜ ìŠ¤í¬ì¸  ê²°ê³¼', categoryClass: 'cat-sport', categoryLabel: 'ìŠ¤í¬ì¸ ', views: '40ë§Œ+', keywords: ['ìŠ¤í¬ì¸ ', 'ê²°ê³¼', 'ê²½ê¸°', 'ìŠ¤ì½”ì–´'] },
          { title: 'ì¼ì¼ ë ˆì‹œí”¼ ì¶”ì²œ', categoryClass: 'cat-food', categoryLabel: 'í‘¸ë“œ', views: '38ë§Œ+', keywords: ['ë ˆì‹œí”¼', 'ìš”ë¦¬', 'ì¶”ì²œ', 'ë§›ì§‘'] },
          { title: 'ì˜¤ëŠ˜ì˜ AI íŠ¸ë Œë“œ', categoryClass: 'cat-tech', categoryLabel: 'í…Œí¬/AI', views: '35ë§Œ+', keywords: ['AI', 'íŠ¸ë Œë“œ', 'ê¸°ìˆ ', 'í˜ì‹ '] },
          { title: 'ì¼ì¼ ê²Œì„ ê³µëµ', categoryClass: 'cat-game', categoryLabel: 'ê²Œì„', views: '33ë§Œ+', keywords: ['ê²Œì„', 'ê³µëµ', 'íŒ', 'ê°€ì´ë“œ'] },
          { title: 'ì˜¤ëŠ˜ì˜ ë¼ì´í”„ìŠ¤íƒ€ì¼', categoryClass: 'cat-life', categoryLabel: 'ë¼ì´í”„/ì‡¼í•‘', views: '30ë§Œ+', keywords: ['ë¼ì´í”„', 'ìŠ¤íƒ€ì¼', 'ì¼ìƒ', 'íŠ¸ë Œë“œ'] },
          { title: 'ì¼ì¼ ì—”í„° ì¸í„°ë·°', categoryClass: 'cat-ent', categoryLabel: 'ì—”í„°í…Œì¸ë¨¼íŠ¸', views: '28ë§Œ+', keywords: ['ì¸í„°ë·°', 'ì—°ì˜ˆì¸', 'ì—”í„°', 'ì´ìŠˆ'] },
          { title: 'ì˜¤ëŠ˜ì˜ ìŠ¤í¬ì¸  ë¶„ì„', categoryClass: 'cat-sport', categoryLabel: 'ìŠ¤í¬ì¸ ', views: '25ë§Œ+', keywords: ['ìŠ¤í¬ì¸ ', 'ë¶„ì„', 'ì „ìˆ ', 'ë¦¬ë·°'] },
          { title: 'ì¼ì¼ í‘¸ë“œ ë¦¬ë·°', categoryClass: 'cat-food', categoryLabel: 'í‘¸ë“œ', views: '23ë§Œ+', keywords: ['í‘¸ë“œ', 'ë¦¬ë·°', 'ë§›ì§‘', 'ì¶”ì²œ'] },
          { title: 'ì˜¤ëŠ˜ì˜ í…Œí¬ ê°€ì´ë“œ', categoryClass: 'cat-tech', categoryLabel: 'í…Œí¬/AI', views: '20ë§Œ+', keywords: ['í…Œí¬', 'ê°€ì´ë“œ', 'íŠœí† ë¦¬ì–¼', 'íŒ'] },
          { title: 'ì¼ì¼ ê²Œì„ ë‰´ìŠ¤', categoryClass: 'cat-game', categoryLabel: 'ê²Œì„', views: '18ë§Œ+', keywords: ['ê²Œì„', 'ë‰´ìŠ¤', 'ì—…ë°ì´íŠ¸', 'ì´ë²¤íŠ¸'] }
        ],
        date: formatDateYYYYMMDD(today),
        lastUpdated: new Date().toISOString()
      };
    }

    // ê³µí†µ ë°ì´í„° í˜ì¹­ í•¨ìˆ˜
    async function fetchTopicsData(type) {
      var isLoadingKey = type === 'weekly' ? 'weekly' : 'daily';
      
      // ì¤‘ë³µ ìš”ì²­ ë°©ì§€
      if (isLoadingState[isLoadingKey]) {
        console.warn(type + ' ë°ì´í„° ë¡œë”©ì´ ì´ë¯¸ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.');
        // ìºì‹œ ë°ì´í„° ë°˜í™˜
        if (cachedData[isLoadingKey]) {
          return cachedData[isLoadingKey];
        }
        // ìºì‹œë„ ì—†ìœ¼ë©´ Mock Data ë°˜í™˜
        return type === 'weekly' ? getMockWeeklyTopics() : getMockDailyTopics();
      }
      
      isLoadingState[isLoadingKey] = true;
      
      try {
        var url = '';
        var today = new Date();
        
        if (type === 'weekly') {
          // í˜„ì¬ ì£¼ì˜ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ ê³„ì‚° (ì›”ìš”ì¼ ~ ì¼ìš”ì¼)
          var dayOfWeek = today.getDay();
          var diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
          var weekStart = new Date(today);
          weekStart.setDate(weekStart.getDate() + diff - today.getDate());
          var weekEnd = new Date(weekStart);
          weekEnd.setDate(weekEnd.getDate() + 6);
          
          var startDate = formatDateYYYYMMDD(weekStart);
          var endDate = formatDateYYYYMMDD(weekEnd);
          url = API_ENDPOINTS.weekly + '?start=' + encodeURIComponent(startDate) + '&end=' + encodeURIComponent(endDate) + '&limit=20';
        } else {
          var dateStr = formatDateYYYYMMDD(today);
          url = API_ENDPOINTS.daily + '?date=' + encodeURIComponent(dateStr) + '&limit=20';
        }
        
        console.log('API ìš”ì²­ URL:', url);
        
        var res = await fetch(url, { 
          cache: 'no-store',
          headers: { 'Content-Type': 'application/json' },
          mode: 'cors'
        });
        
        if (!res.ok) {
          // 404, 500 ë“± ì—ëŸ¬ ì²˜ë¦¬
          if (res.status === 404) {
            console.warn(type + ' API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (404) - URL: ' + url);
          } else if (res.status >= 500) {
            console.error(type + ' ì„œë²„ ì˜¤ë¥˜ ë°œìƒ (500+) - URL: ' + url);
          } else {
            console.error(type + ' API í˜¸ì¶œ ì‹¤íŒ¨:', res.status, '- URL: ' + url);
          }
          throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨: ' + res.status);
        }
        
        var data = await res.json();
        
        // ë‹¤ì–‘í•œ API ì‘ë‹µ êµ¬ì¡° ì§€ì›
        var topics = null;
        if (data) {
          // êµ¬ì¡° 1: { topics: [...] }
          if (data.topics && Array.isArray(data.topics)) {
            topics = data.topics;
          }
          // êµ¬ì¡° 2: { data: { topics: [...] } }
          else if (data.data && data.data.topics && Array.isArray(data.data.topics)) {
            topics = data.data.topics;
          }
          // êµ¬ì¡° 3: { weeklyTopics: [...] } ë˜ëŠ” { dailyTopics: [...] }
          else if (data[type + 'Topics'] && Array.isArray(data[type + 'Topics'])) {
            topics = data[type + 'Topics'];
          }
          // êµ¬ì¡° 4: ë°°ì—´ ìì²´
          else if (Array.isArray(data)) {
            topics = data;
          }
        }
        
        if (!topics || topics.length === 0) {
          throw new Error('ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤');
        }
        
        // ê²°ê³¼ ìƒì„±
        var result = null;
        if (type === 'weekly') {
          result = {
            topics: topics,
            dateRange: data.dateRange || data.data?.dateRange || (formatDateYYYYMMDD(weekStart) + ' ~ ' + formatDateYYYYMMDD(weekEnd)),
            lastUpdated: data.lastUpdated || data.data?.lastUpdated || new Date().toISOString()
          };
        } else {
          result = {
            topics: topics,
            date: data.date || data.data?.date || formatDateYYYYMMDD(today),
            lastUpdated: data.lastUpdated || data.data?.lastUpdated || new Date().toISOString()
          };
        }
        
        // ì„±ê³µ ì‹œ ìºì‹œì— ì €ì¥
        cachedData[isLoadingKey] = result;
        return result;
        
      } catch (error) {
        console.error('API Error Detail:', error);
        console.error('ì—ëŸ¬ ë°œìƒ URL:', url);
        console.error('ì—ëŸ¬ íƒ€ì…:', type);
        console.error('ì—ëŸ¬ ë©”ì‹œì§€:', error.message || error);
        
        // CORS ì—ëŸ¬ í™•ì¸
        if (error.message && error.message.includes('CORS')) {
          console.error('CORS ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„œë²„ì—ì„œ CORS í—¤ë”ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }
        
        // ìºì‹œ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš©
        if (cachedData[isLoadingKey]) {
          console.log('ìºì‹œëœ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:', type);
          return cachedData[isLoadingKey];
        }
        
        // ìºì‹œë„ ì—†ìœ¼ë©´ Mock Data ë°˜í™˜
        console.log('Mock Dataë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:', type);
        var mockData = type === 'weekly' ? getMockWeeklyTopics() : getMockDailyTopics();
        cachedData[isLoadingKey] = mockData;
        return mockData;
      } finally {
        isLoadingState[isLoadingKey] = false;
      }
    }

    // ì£¼ê°„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©)
    async function fetchWeeklyTopics() {
      return await fetchTopicsData('weekly');
    }

    // ì¼ê°„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©)
    async function fetchDailyTopics() {
      return await fetchTopicsData('daily');
    }

    // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
    function showErrorMessage(message) {
      if (!topicsGridEl) return;
      topicsGridEl.innerHTML = '<div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: #666; background: #f5f5f5; border-radius: 8px;">' +
        '<div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">âš ï¸</div>' +
        '<div style="font-size: 14px;">' + (message || 'ìµœì‹  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤') + '</div>' +
        '</div>';
    }

    // ì£¼ê°„ í† í”½ ë¡œë“œ
    async function loadWeeklyTopics() {
      if (!topicsGridEl) return;
      if (isLoadingState.weekly) return; // ì¤‘ë³µ ë¡œë”© ë°©ì§€
      
      // ë¡œë”© ìƒíƒœ í‘œì‹œ
      topicsGridEl.innerHTML = '<div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: #999;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      if (dataFooterEl) {
        dataFooterEl.textContent = 'ë°ì´í„° ê¸°ì¤€: ë¡œë”© ì¤‘...';
      }
      
      var result = await fetchWeeklyTopics();
      
      // fetchTopicsDataì—ì„œ í•­ìƒ ë°ì´í„°ë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ null ì²´í¬ëŠ” ë¶ˆí•„ìš”í•˜ì§€ë§Œ ì•ˆì „ì„ ìœ„í•´ ìœ ì§€
      if (!result || !result.topics || result.topics.length === 0) {
        // Mock Dataë„ ì‹¤íŒ¨í•œ ê²½ìš° (ì´ë¡ ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥í•˜ì§€ë§Œ ì•ˆì „ì¥ì¹˜)
        result = getMockWeeklyTopics();
      }
      
      globalState.selectedTopics = [];
      renderTopics(result.topics.slice(0, 20));
      
      // ë‚ ì§œ ë²”ìœ„ ì—…ë°ì´íŠ¸ (ë™ì )
      var dateRangeText = result.dateRange || '';
      if (!dateRangeText) {
        // í˜„ì¬ ì£¼ì˜ ë‚ ì§œ ë²”ìœ„ ê³„ì‚°
        var today = new Date();
        var dayOfWeek = today.getDay();
        var diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
        var weekStart = new Date(today);
        weekStart.setDate(weekStart.getDate() + diff - today.getDate());
        var weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        dateRangeText = formatDateYYYYMMDD(weekStart) + ' ~ ' + formatDateYYYYMMDD(weekEnd);
      }
      
      if (dataFooterEl) {
        dataFooterEl.textContent = 'ë°ì´í„° ê¸°ì¤€: ' + dateRangeText + ' (Global)';
      }
      setTopicsMeta('weekly', dateRangeText);
      
      // ìŠ¤ëƒ…ìƒ· ì—…ë°ì´íŠ¸
      weeklyGridSnapshot = topicsGridEl.innerHTML;
      
      saveGlobalState();
      syncMutualExclusion();
    }

    // ì¼ê°„ í† í”½ ë¡œë“œ
    async function loadDailyTopics() {
      if (!topicsGridEl) return;
      if (isLoadingState.daily) return; // ì¤‘ë³µ ë¡œë”© ë°©ì§€
      
      // ë¡œë”© ìƒíƒœ í‘œì‹œ
      topicsGridEl.innerHTML = '<div style="grid-column: 1 / -1; padding: 40px; text-align: center; color: #999;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      if (topicsDateEl) {
        topicsDateEl.textContent = 'ì ìš©: ë¡œë”© ì¤‘...';
      }
      
      var result = await fetchDailyTopics();
      
      // fetchTopicsDataì—ì„œ í•­ìƒ ë°ì´í„°ë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ null ì²´í¬ëŠ” ë¶ˆí•„ìš”í•˜ì§€ë§Œ ì•ˆì „ì„ ìœ„í•´ ìœ ì§€
      if (!result || !result.topics || result.topics.length === 0) {
        // Mock Dataë„ ì‹¤íŒ¨í•œ ê²½ìš° (ì´ë¡ ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥í•˜ì§€ë§Œ ì•ˆì „ì¥ì¹˜)
        result = getMockDailyTopics();
      }
      
      globalState.selectedTopics = [];
      renderTopics(result.topics.slice(0, 20));
      
      // ë‚ ì§œ ì—…ë°ì´íŠ¸ (ë™ì  - ì‹¤íŒ¨ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ê°•ì œ í‘œì‹œ)
      var dateText = result.date || formatDateYYYYMMDD(new Date());
      setTopicsMeta('daily', dateText);
      
      saveGlobalState();
      syncMutualExclusion();
    }

    // ê¸‰ìƒìŠ¹ í† í”½ íƒ­ ê¸°ëŠ¥
    document.querySelectorAll('.topic-tab').forEach(function(tab) {
      tab.addEventListener('click', function() {
        if (tab.disabled) return;
        document.querySelectorAll('.topic-tab').forEach(function(t) {
          t.classList.remove('active');
        });
        this.classList.add('active');

        var tabType = this.getAttribute('data-tab');
        if (tabType === 'weekly') loadWeeklyTopics();
        if (tabType === 'daily') loadDailyTopics();
      });
    });

    // ===== ëŒ€ë³¸ ì§ì ‘ ë„£ê¸°: ëª¨ë‹¬ (í…ìŠ¤íŠ¸/íŒŒì¼/URL) =====
    var scriptModalEl = document.getElementById('scriptModal');
    var btnScript = document.querySelector('.btn-script');
    var btnScriptClose = document.getElementById('scriptModalClose');
    var btnScriptCancel = document.getElementById('scriptModalCancel');
    var btnScriptApply = document.getElementById('scriptApplyBtn');
    var btnScriptAnalyze = document.getElementById('scriptAnalyzeBtn');
    var btnScriptUrlLoad = document.getElementById('scriptUrlLoadBtn');

    function openScriptModal() {
      if (!scriptModalEl) return;
      scriptModalEl.classList.add('show');
    }
    function closeScriptModal() {
      if (!scriptModalEl) return;
      scriptModalEl.classList.remove('show');
    }

    if (btnScript) btnScript.addEventListener('click', openScriptModal);
    if (btnScriptClose) btnScriptClose.addEventListener('click', closeScriptModal);
    if (btnScriptCancel) btnScriptCancel.addEventListener('click', closeScriptModal);
    if (scriptModalEl) {
      scriptModalEl.addEventListener('click', function(e) {
        if (e.target === scriptModalEl) closeScriptModal();
      });
    }

    // URL ë¶ˆëŸ¬ì˜¤ê¸°: /api/fetch-url í˜¸ì¶œ í›„ í…ìŠ¤íŠ¸ ì˜ì—­ì— ì±„ì›€ (CORS ì—†ìŒ)
    if (btnScriptUrlLoad) {
      btnScriptUrlLoad.addEventListener('click', async function() {
        var urlEl = document.getElementById('scriptUrl');
        var textEl = document.getElementById('scriptText');
        var url = urlEl ? urlEl.value.trim() : '';
        if (!url) {
          alert('URLì„ ì…ë ¥í•œ ë’¤ ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ëˆŒëŸ¬ ì£¼ì„¸ìš”.');
          return;
        }
        btnScriptUrlLoad.disabled = true;
        btnScriptUrlLoad.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
        try {
          var res = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/fetch-url', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url })
          });
          var data = await res.json();
          if (data.success && (data.text || data.title || data.description)) {
            var text = data.text || (data.title && data.description ? data.title + '\n\n' + data.description : data.title || data.description);
            if (textEl) textEl.value = text;
          } else {
            alert(data.error || 'URL ë‚´ìš©ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
          }
        } catch (e) {
          alert('URLì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.');
        }
        btnScriptUrlLoad.disabled = false;
        btnScriptUrlLoad.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸°';
      });
    }

    function extractKeywords(text) {
      var words = (text || '').replace(/[^\wê°€-í£\s]/g, ' ').split(/\s+/).filter(Boolean);
      // ê¸¸ì´/ì¤‘ë³µ ê°„ë‹¨ ì²˜ë¦¬
      var uniq = [];
      words.forEach(function(w) {
        if (w.length < 2) return;
        if (uniq.indexOf(w) === -1) uniq.push(w);
      });
      return uniq.slice(0, 8);
    }
    function generateSummary(text) {
      var t = (text || '').trim();
      return t.length <= 140 ? t : (t.substring(0, 140) + 'â€¦');
    }

    function analyzeScriptText(scriptText) {
      var kw = extractKeywords(scriptText);
      globalState.scriptText = scriptText;
      globalState.generatedMaterials = {
        keywords: kw,
        summary: generateSummary(scriptText),
        mode: 'restructured'
      };
      globalState.keyword = kw.join(', ');
      if (keywordInputEl) keywordInputEl.value = globalState.keyword;

      // ìƒí˜¸ë°°íƒ€: í‚¤ì›Œë“œ ëª¨ë“œë¡œ ì „í™˜
      clearTrendSelection();
      saveGlobalState();
      syncMutualExclusion();
      closeScriptModal();
      alert('ëŒ€ë³¸ì´ ë¶„ì„ë˜ì—ˆìŠµë‹ˆë‹¤. í‚¤ì›Œë“œê°€ ìë™ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    async function readScriptFromModal() {
      var textEl = document.getElementById('scriptText');
      var fileEl = document.getElementById('scriptFile');
      var urlEl = document.getElementById('scriptUrl');

      var textVal = textEl ? textEl.value.trim() : '';
      if (textVal) return textVal;

      var file = fileEl && fileEl.files && fileEl.files[0] ? fileEl.files[0] : null;
      if (file) {
        return await new Promise(function(resolve, reject) {
          var reader = new FileReader();
          reader.onload = function() { resolve(String(reader.result || '').trim()); };
          reader.onerror = function() { reject(new Error('file read error')); };
          reader.readAsText(file);
        });
      }

      var urlVal = urlEl ? urlEl.value.trim() : '';
      if (urlVal) {
        try {
          var res = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/fetch-url', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: urlVal })
          });
          var data = await res.json();
          if (data.success && (data.text || data.title || data.description)) {
            return data.text || (data.title && data.description ? data.title + '\n\n' + data.description : data.title || data.description);
          }
          alert(data.error || 'URL ë‚´ìš©ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        } catch (e) {
          alert('URLì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.');
        }
      }

      return '';
    }

    function applyScriptDirect(scriptText) {
      globalState.scriptText = scriptText;
      globalState.generatedMaterials = {
        keywords: [],
        summary: generateSummary(scriptText),
        mode: 'direct'
      };
      try {
        localStorage.setItem('raw_source_script', scriptText);
        localStorage.setItem('script_direct_apply', 'true');
      } catch (e) {}
      saveGlobalState();
      closeScriptModal();
      alert('ëŒ€ë³¸ ì›ë¬¸ì´ ê·¸ëŒ€ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. 2Â·3ë‹¨ê³„ì—ì„œ ì´ ë‚´ìš©ì„ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.');
    }

    if (btnScriptAnalyze) {
      btnScriptAnalyze.addEventListener('click', async function() {
        var scriptText = await readScriptFromModal();
        if (!scriptText) {
          alert('í…ìŠ¤íŠ¸/íŒŒì¼/URL ì¤‘ í•˜ë‚˜ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
          return;
        }
        btnScriptAnalyze.disabled = true;
        btnScriptAnalyze.textContent = 'ì¬êµ¬ì„± ì¤‘â€¦';
        try {
          var res = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/summarize-for-planning', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: scriptText })
          });
          var data = await res.json();
          if (data.success && data.title != null) {
            try {
              localStorage.setItem('step2PreFillBlueprint', JSON.stringify({
                title: data.title || '',
                target: data.target || '',
                hook: data.hook || '',
                storyline: data.storyline || ''
              }));
            } catch (e) {}
            closeScriptModal();
            alert('ê¸°íšì•ˆ í˜•íƒœë¡œ ìš”ì•½ë˜ì—ˆìŠµë‹ˆë‹¤. 2ë‹¨ê³„ë¡œ ì´ë™í•´ í™•ì¸í•˜ì„¸ìš”.');
            window.location.href = '/step-2';
            return;
          }
          alert(data.error || 'ì¬êµ¬ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        } catch (e) {
          alert('ì¬êµ¬ì„± ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
        btnScriptAnalyze.disabled = false;
        btnScriptAnalyze.textContent = 'ì¬êµ¬ì„±';
      });
    }

    if (btnScriptApply) {
      btnScriptApply.addEventListener('click', async function() {
        var scriptText = await readScriptFromModal();
        if (!scriptText) {
          alert('í…ìŠ¤íŠ¸/íŒŒì¼/URL ì¤‘ í•˜ë‚˜ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
          return;
        }
        applyScriptDirect(scriptText);
      });
    }

    // ===== ìµœí•˜ë‹¨ ì‹¤í–‰ ë²„íŠ¼: ë¶„ì„ í›„ 2ë‹¨ê³„ë¡œ ì´ë™ =====
    var btnAnalyzeGenerate = document.getElementById('btnAnalyzeGenerate');
    if (btnAnalyzeGenerate) {
      btnAnalyzeGenerate.addEventListener('click', function() {
        var keyword = keywordInputEl ? keywordInputEl.value.trim() : '';
        globalState.keyword = keyword;

        if (!keyword && !globalState.selectedCategory && !(globalState.selectedTopics || []).length) {
          alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì£¼ì œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
          return;
        }

        // AI ì¶”ì²œ ì£¼ì œ 15ê°œ ìƒì„± ë° ë Œë”ë§
        var topics = generateAiTopics();
        globalState.aiTopics = topics;
        saveGlobalState();
        renderAiTopicResults(topics);

        // ê²°ê³¼ ì„¹ì…˜ìœ¼ë¡œ ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤
        if (aiResultSectionEl) {
          aiResultSectionEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }

    // ì¶”ì²œ ì£¼ì œ ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì‹œ ì„ íƒ -> 2ë‹¨ê³„ë¡œ ì´ë™
    if (aiTopicListEl) {
      aiTopicListEl.addEventListener('click', function(e) {
        var item = e.target.closest('.ai-topic-item');
        if (!item) return;

        var idx = parseInt(item.getAttribute('data-index') || '-1', 10);
        var topic = (globalState.aiTopics || [])[idx] || null;
        if (!topic) return;

        var title = topic.title || '';
        var expertSummary = topic.reason || '';
        var keyword = keywordInputEl ? keywordInputEl.value.trim() : '';
        globalState.keyword = keyword;

        var payload = {
          fromStep: 'topic-recommendation',
          createdAt: new Date().toISOString(),
          keyword: keyword,
          topicType: globalState.selectedTopicType,
          keywordTopic: globalState.selectedCategory,
          trendTopics: globalState.selectedTopics || [],
          chosenAiTopic: title,
          expertSummary: expertSummary,
          scriptText: globalState.scriptText || '',
          analysis: globalState.generatedMaterials || null
        };
        localStorage.setItem('step2Payload', JSON.stringify(payload));
        saveGlobalState();

        window.location.href = 'step-2.html';
      });
    }

    // ì „ì—­ ìƒíƒœ ì €ì¥
    function saveGlobalState() {
      localStorage.setItem('projectGlobalState', JSON.stringify(globalState));
    }

    // ì „ì—­ ìƒíƒœ ë¡œë“œ
    function loadGlobalState() {
      var saved = localStorage.getItem('projectGlobalState');
      if (saved) {
        globalState = JSON.parse(saved);
        // UI ë³µì›
        if (globalState.keyword) {
          document.getElementById('keywordInput').value = globalState.keyword;
        }
        // ì£¼ì œ íƒ€ì… ë³µì›
        if (globalState.selectedTopicType) {
          document.querySelectorAll('.topic-type-tab').forEach(function(btn) {
            btn.classList.toggle('active', btn.getAttribute('data-type') === globalState.selectedTopicType);
          });
          setActiveTopicType(globalState.selectedTopicType);
        }
        // í‚¤ì›Œë“œ ì£¼ì œ ì„ íƒ ë³µì›
        if (globalState.selectedCategory) {
          document.querySelectorAll('.topic-icon-item').forEach(function(item) {
            item.classList.toggle('selected', item.getAttribute('data-category') === globalState.selectedCategory);
          });
        }
      }
    }

    // ë¡œê·¸ì˜¨ ì‹œìŠ¤í…œ (index.htmlê³¼ ë™ì¼)
    var isLoggedIn = false;
    function checkLoginStatus() {
      var loginStatus = localStorage.getItem('isLoggedIn');
      var loginTime = localStorage.getItem('loginTime');
      if (loginStatus === 'true' && loginTime) {
        var loginDate = new Date(loginTime);
        var now = new Date();
        var hoursDiff = (now - loginDate) / (1000 * 60 * 60);
        if (hoursDiff < 24) {
          isLoggedIn = true;
          updateUIForLogin();
          return true;
        } else {
          logout();
        }
      }
      isLoggedIn = false;
      updateUIForLogout();
      return false;
    }
    function login() {
      var id = document.getElementById('loginId').value.trim();
      var pw = document.getElementById('loginPw').value.trim();
      if (!id || !pw) {
        alert('IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }
      var users = JSON.parse(localStorage.getItem('approvedUsers') || '[]');
      var user = users.find(function(u) { return u.id === id && u.password === pw; });
      if (user) {
        isLoggedIn = true;
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('loginTime', new Date().toISOString());
        localStorage.setItem('currentUserId', id);
        updateUIForLogin();
        alert('ë¡œê·¸ì˜¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
        document.getElementById('loginId').value = '';
        document.getElementById('loginPw').value = '';
      } else {
        alert('ìŠ¹ì¸ëœ IDì™€ ë¹„ë°€ë²ˆí˜¸ê°€ ì•„ë‹™ë‹ˆë‹¤.');
      }
    }
    function logout() {
      isLoggedIn = false;
      localStorage.removeItem('isLoggedIn');
      localStorage.removeItem('loginTime');
      localStorage.removeItem('currentUserId');
      updateUIForLogout();
    }
    function updateUIForLogin() {
      document.getElementById('btnLogin').textContent = 'ë¡œê·¸ì•„ì›ƒ';
      document.getElementById('btnLogin').onclick = function() {
        if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          logout();
          alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      };
      document.getElementById('loginId').disabled = true;
      document.getElementById('loginPw').disabled = true;
    }
    function updateUIForLogout() {
      document.getElementById('btnLogin').textContent = 'ë¡œê·¸ì˜¨';
      document.getElementById('btnLogin').onclick = login;
      document.getElementById('loginId').disabled = false;
      document.getElementById('loginPw').disabled = false;
    }
    document.getElementById('btnAdmin').onclick = function() {
      alert('ê´€ë¦¬ í˜ì´ì§€ëŠ” ë©”ì¸(index.html)ì—ì„œ ì´ìš©í•˜ì„¸ìš”.');
    };
    document.getElementById('btnLogin').onclick = login;
    
    // í”„ë¡œì íŠ¸ ë²„íŠ¼ ê¶Œí•œ ì²´í¬ ë° ì´ë²¤íŠ¸
    (function() {
      function checkAdminPermission() {
        var loginStatus = localStorage.getItem('isLoggedIn');
        var loginTime = localStorage.getItem('loginTime');
        if (loginStatus === 'true' && loginTime) {
          var loginDate = new Date(loginTime);
          var now = new Date();
          var hoursDiff = (now - loginDate) / (1000 * 60 * 60);
          if (hoursDiff < 24) {
            var currentUserId = localStorage.getItem('currentUserId');
            var users = JSON.parse(localStorage.getItem('approvedUsers') || '[]');
            var user = users.find(function(u) { return u.id === currentUserId; });
            return user && user.isAdmin === true;
          }
        }
        return false;
      }
      
      function updateProjectButtonsVisibility() {
        var hasPermission = checkAdminPermission();
        var btnCreate = document.getElementById('btnCreateProject');
        var btnList = document.getElementById('btnProjectList');
        if (btnCreate) {
          btnCreate.style.display = hasPermission ? 'block' : 'none';
          btnCreate.disabled = !hasPermission;
        }
        if (btnList) {
          btnList.style.display = hasPermission ? 'block' : 'none';
          btnList.disabled = !hasPermission;
        }
      }
      
      var btnCreate = document.getElementById('btnCreateProject');
      var btnList = document.getElementById('btnProjectList');
      
      if (btnCreate) {
        btnCreate.onclick = function() {
          if (!checkAdminPermission()) {
            alert('ê´€ë¦¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ê´€ë¦¬ ê¶Œí•œì„ ë°›ì•„ì£¼ì„¸ìš”.');
            return;
          }
          // í”„ë¡œì íŠ¸ ìƒì„± ë¡œì§ (ì¶”í›„ êµ¬í˜„)
          alert('í”„ë¡œì íŠ¸ ìƒì„± ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
        };
      }
      
      if (btnList) {
        btnList.onclick = function() {
          if (!checkAdminPermission()) {
            alert('ê´€ë¦¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ê´€ë¦¬ ê¶Œí•œì„ ë°›ì•„ì£¼ì„¸ìš”.');
            return;
          }
          // í”„ë¡œì íŠ¸ ëª©ë¡ ë¡œì§ (ì¶”í›„ êµ¬í˜„)
          window.location.href = '/';
        };
      }
      
      updateProjectButtonsVisibility();
      // ë¡œê·¸ì¸ ìƒíƒœ ë³€ê²½ ì‹œ ë²„íŠ¼ í‘œì‹œ ì—…ë°ì´íŠ¸
      setInterval(updateProjectButtonsVisibility, 5000);
    })();
    
    // ë‚ ì§œ ì²´í¬ ë° ìë™ ê°±ì‹  ë¡œì§ (useEffect ì—­í• )
    function checkAndRefreshData() {
      try {
        var now = new Date();
        var todayStr = formatDateYYYYMMDD(now);
        var lastLoadDate = localStorage.getItem('lastDailyLoadDate');
        var lastLoadWeek = localStorage.getItem('lastWeeklyLoadWeek');
        
        // ì¼ê°„ ë°ì´í„°: ë‚ ì§œê°€ ë°”ë€Œì—ˆìœ¼ë©´ ê°±ì‹ 
        if (lastLoadDate !== todayStr) {
          var activeTab = document.querySelector('.topic-tab.active');
          if (activeTab && activeTab.getAttribute('data-tab') === 'daily') {
            loadDailyTopics();
          }
          localStorage.setItem('lastDailyLoadDate', todayStr);
        }
        
        // ì£¼ê°„ ë°ì´í„°: ì£¼ê°€ ë°”ë€Œì—ˆìœ¼ë©´ ê°±ì‹ 
        var dayOfWeek = now.getDay();
        var diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
        var weekStart = new Date(now);
        weekStart.setDate(weekStart.getDate() + diff - now.getDate());
        var weekStr = formatDateYYYYMMDD(weekStart);
        
        if (lastLoadWeek !== weekStr) {
          var activeTab = document.querySelector('.topic-tab.active');
          if (activeTab && activeTab.getAttribute('data-tab') === 'weekly') {
            loadWeeklyTopics();
          }
          localStorage.setItem('lastWeeklyLoadWeek', weekStr);
        }
        
        // ë‚ ì§œê°€ í•­ìƒ í‘œì‹œë˜ë„ë¡ ë³´ì¥ (ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€)
        if (topicsDateEl && (!topicsDateEl.textContent || topicsDateEl.textContent.includes('ë¡œë”©') || topicsDateEl.textContent.includes('ì‹¤íŒ¨'))) {
          topicsDateEl.textContent = 'ì ìš©: ' + todayStr;
        }
        if (dataFooterEl && (dataFooterEl.textContent.includes('ë¡œë”© ì¤‘') || dataFooterEl.textContent.includes('ë¡œë“œ ì‹¤íŒ¨'))) {
          var today = new Date();
          var dayOfWeek2 = today.getDay();
          var diff2 = today.getDate() - dayOfWeek2 + (dayOfWeek2 === 0 ? -6 : 1);
          var weekStart2 = new Date(today);
          weekStart2.setDate(weekStart2.getDate() + diff2 - today.getDate());
          var weekEnd2 = new Date(weekStart2);
          weekEnd2.setDate(weekEnd2.getDate() + 6);
          dataFooterEl.textContent = 'ë°ì´í„° ê¸°ì¤€: ' + formatDateYYYYMMDD(weekStart2) + ' ~ ' + formatDateYYYYMMDD(weekEnd2) + ' (Global)';
        }
      } catch (e) {
        console.error('checkAndRefreshData ì˜¤ë¥˜:', e);
        // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë‚ ì§œëŠ” í‘œì‹œ
        var today = new Date();
        if (topicsDateEl) {
          topicsDateEl.textContent = 'ì ìš©: ' + formatDateYYYYMMDD(today);
        }
        if (dataFooterEl) {
          var dayOfWeek = today.getDay();
          var diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
          var weekStart = new Date(today);
          weekStart.setDate(weekStart.getDate() + diff - today.getDate());
          var weekEnd = new Date(weekStart);
          weekEnd.setDate(weekEnd.getDate() + 6);
          dataFooterEl.textContent = 'ë°ì´í„° ê¸°ì¤€: ' + formatDateYYYYMMDD(weekStart) + ' ~ ' + formatDateYYYYMMDD(weekEnd) + ' (Global)';
        }
      }
    }

    // ìë™ ê°±ì‹  ë¡œì§
    function setupAutoRefresh() {
      // ì¼ê°„ ë°ì´í„°: ë§¤ì¼ ìì •ì— ê°±ì‹ 
      var now = new Date();
      var tomorrow = new Date(now);
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(0, 0, 0, 0);
      var msUntilMidnight = tomorrow - now;
      
      setTimeout(function() {
        // ìì •ì— ë‚ ì§œ ì²´í¬ ë° ê°±ì‹ 
        checkAndRefreshData();
        // ë§¤ì¼ ìì •ë§ˆë‹¤ ë°˜ë³µ
        setInterval(function() {
          checkAndRefreshData();
        }, 24 * 60 * 60 * 1000); // 24ì‹œê°„ë§ˆë‹¤
      }, msUntilMidnight);
    }

    // ì „ê³¼ì • Auto ë²„íŠ¼ í™œì„±í™” ì²´í¬ (ì…ë ¥ê°’ ìœ íš¨ì„± ê²€ì‚¬ ê°•í™”)
    function checkAutoButtonState() {
      var btnAuto = document.getElementById('btnFullAuto');
      if (!btnAuto) return;

      // í™œì„±í™” ì¡°ê±´ í™•ì¸ (null ì²´í¬ í¬í•¨)
      var keywordInput = document.getElementById('keywordInput');
      var keywordValue = keywordInput ? keywordInput.value.trim() : '';
      
      var hasTopic = !!(globalState.selectedCategory || keywordValue || (globalState.selectedTopics && globalState.selectedTopics.length > 0));
      var hasChannelInfo = !!(globalState.selectedCategory || (globalState.selectedTopics && globalState.selectedTopics.length > 0));
      var hasIssueData = true; // ì£¼ê°„/ì¼ê°„ ì´ìŠˆ ë°ì´í„°ëŠ” ì„ íƒì‚¬í•­
      var hasKeyword = !!(keywordValue || (globalState.selectedTopics && globalState.selectedTopics.length > 0));

      // ëª¨ë“  ì¡°ê±´ì´ nullì´ ì•„ë‹Œì§€ ëª…ì‹œì ìœ¼ë¡œ ì²´í¬
      var isEnabled = hasTopic !== null && hasTopic !== undefined && hasTopic &&
                     hasChannelInfo !== null && hasChannelInfo !== undefined && hasChannelInfo &&
                     hasIssueData !== null && hasIssueData !== undefined && hasIssueData &&
                     hasKeyword !== null && hasKeyword !== undefined && hasKeyword &&
                     !isAutoProcessing;
      
      btnAuto.disabled = !isEnabled;
      
      // ë””ë²„ê¹…ìš© ë¡œê·¸ (ê°œë°œ í™˜ê²½ì—ì„œë§Œ)
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        console.log('Auto ë²„íŠ¼ í™œì„±í™” ì²´í¬:', {
          hasTopic: hasTopic,
          hasChannelInfo: hasChannelInfo,
          hasIssueData: hasIssueData,
          hasKeyword: hasKeyword,
          isAutoProcessing: isAutoProcessing,
          isEnabled: isEnabled
        });
      }
    }

    // ì§„í–‰ ëª¨ë‹¬ ì—…ë°ì´íŠ¸
    function updateProgressModal(step, totalSteps, message, customProgress) {
      currentAutoStep = step;
      var modal = document.getElementById('progressModal');
      var stepNumberEl = document.getElementById('progressStepNumber');
      var stepMessageEl = document.getElementById('progressStepMessage');
      var progressBarEl = document.getElementById('progressBarFill');
      var progressPercentageEl = document.getElementById('progressPercentage');
      var errorEl = document.getElementById('progressError');
      var errorTextEl = document.getElementById('progressErrorText');
      var retryBtn = document.getElementById('progressRetryBtn');
      var manualBtn = document.getElementById('progressManualBtn');

      if (stepNumberEl) {
        stepNumberEl.textContent = 'Step ' + step + ' / ' + totalSteps;
      }
      if (stepMessageEl) {
        stepMessageEl.textContent = message || 'ì²˜ë¦¬ ì¤‘...';
      }
      if (progressBarEl) {
        var progress = customProgress !== undefined ? customProgress : (step / totalSteps) * 100;
        progressBarEl.style.width = progress + '%';
      }
      if (progressPercentageEl) {
        var progress = customProgress !== undefined ? customProgress : (step / totalSteps) * 100;
        progressPercentageEl.textContent = Math.round(progress) + '%';
      }

      // ì˜¤ë¥˜ í‘œì‹œ ìˆ¨ê¸°ê¸°
      if (errorEl) {
        errorEl.classList.remove('show');
      }
      if (retryBtn) {
        retryBtn.style.display = 'none';
      }
      if (manualBtn) {
        manualBtn.style.display = 'none';
      }
    }

    // ì§„í–‰ ëª¨ë‹¬ í‘œì‹œ/ìˆ¨ê¹€
    function showProgressModal() {
      isAutoProcessing = true;
      var modal = document.getElementById('progressModal');
      if (modal) {
        modal.classList.add('show');
      }
      checkAutoButtonState();
    }

    function hideProgressModal() {
      isAutoProcessing = false;
      var modal = document.getElementById('progressModal');
      if (modal) {
        modal.classList.remove('show');
      }
      checkAutoButtonState();
    }

    // ì˜¤ë¥˜ í‘œì‹œ
    function showProgressError(message, canRetry, canManual) {
      var errorEl = document.getElementById('progressError');
      var errorTextEl = document.getElementById('progressErrorText');
      var retryBtn = document.getElementById('progressRetryBtn');
      var manualBtn = document.getElementById('progressManualBtn');

      if (errorEl && errorTextEl) {
        errorTextEl.textContent = message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        errorEl.classList.add('show');
      }

      if (retryBtn) {
        retryBtn.style.display = canRetry ? 'block' : 'none';
      }
      if (manualBtn) {
        manualBtn.style.display = canManual ? 'block' : 'none';
        if (canManual && manualBtn) {
          manualBtn.onclick = function() {
            hideProgressModal();
            // í˜„ì¬ ë‹¨ê³„ì— ë§ëŠ” í˜ì´ì§€ë¡œ ì´ë™
            var targetPage = getTargetPageByStep(currentAutoStep);
            if (targetPage) {
              window.location.href = targetPage;
            } else {
              alert('ìˆ˜ë™ìœ¼ë¡œ ì§„í–‰í•˜ë ¤ë©´ í•´ë‹¹ ë‹¨ê³„ í˜ì´ì§€ë¡œ ì´ë™í•´ì£¼ì„¸ìš”.');
            }
          };
        }
      }
    }

    // ë‹¨ê³„ë³„ íƒ€ê²Ÿ í˜ì´ì§€ ë°˜í™˜
    function getTargetPageByStep(step) {
      var pageMap = {
        1: 'ai-automation-project.html',
        2: 'step-2.html',
        3: 'step-3.html',
        4: 'step-4-1.html',
        5: 'step-4-2.html',
        6: 'step-6.html',
        7: 'step-5-2.html',
        8: 'step-7.html',
        9: 'step-8.html'
      };
      return pageMap[step] || null;
    }

    // í”„ë¡œì íŠ¸ ID ìƒì„±
    function generateProjectId() {
      return 'project_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // ì²´í¬í¬ì¸íŠ¸ ì €ì¥ (ì¤‘ê°„ ì €ì¥)
    async function saveCheckpoint(step, stepName, data) {
      try {
        currentProjectId = currentProjectId || generateProjectId();
        localStorage.setItem('currentProjectId', currentProjectId);
        
        var checkpoint = {
          project_id: currentProjectId,
          last_success_step: step,
          last_success_step_name: stepName,
          intermediate_data: data,
          status: 'PROCESSING',
          updated_at: new Date().toISOString()
        };
        
        // ë°±ì—”ë“œì—ë„ ì²´í¬í¬ì¸íŠ¸ ì €ì¥
        try {
          await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/auto-workflow/checkpoint', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              project_id: currentProjectId,
              step: step,
              step_name: stepName,
              result_data: data
            })
          });
        } catch (e) {
          console.warn('ë°±ì—”ë“œ ì²´í¬í¬ì¸íŠ¸ ì €ì¥ ì‹¤íŒ¨:', e);
        }

        // LocalStorageì— ì €ì¥
        localStorage.setItem('auto_save_snapshot', JSON.stringify(checkpoint));
        
        // ë°±ì—”ë“œ API í˜¸ì¶œ (ì˜µì…˜)
        try {
          await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/project/save-checkpoint', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(checkpoint)
          });
        } catch (apiError) {
          console.warn('ì²´í¬í¬ì¸íŠ¸ API ì €ì¥ ì‹¤íŒ¨ (ë¡œì»¬ ì €ì¥ì€ ì„±ê³µ):', apiError);
        }

        console.log('ì²´í¬í¬ì¸íŠ¸ ì €ì¥ ì™„ë£Œ:', stepName);
      } catch (error) {
        console.error('ì²´í¬í¬ì¸íŠ¸ ì €ì¥ ì‹¤íŒ¨:', error);
      }
    }

    // ë‹¨ê³„ ì‹¤í–‰ Wrapper (ì €ì¥ ë° ì—ëŸ¬ ì²˜ë¦¬ í¬í•¨)
    async function executeStepWithSave(step, stepName, stepFunction, retryCount) {
      retryCount = retryCount || 0;
      var maxRetries = 3;
      var retryDelay = 5000; // 5ì´ˆ

      try {
        // ë‹¨ê³„ ì‹¤í–‰
        var result = await stepFunction();
        
        // ì„±ê³µ ì‹œ ì²´í¬í¬ì¸íŠ¸ ì €ì¥
        var checkpointData = {
          step: step,
          stepName: stepName,
          result: result,
          timestamp: new Date().toISOString()
        };
        await saveCheckpoint(step, stepName, checkpointData);
        
        return result;
      } catch (error) {
        console.error(stepName + ' ì‹¤í–‰ ì˜¤ë¥˜:', error);
        
        // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì´ê³  ì¬ì‹œë„ ê°€ëŠ¥í•œ ê²½ìš°
        if (retryCount < maxRetries && (error.message.includes('network') || error.message.includes('fetch') || error.status >= 500)) {
          console.log(stepName + ' ì¬ì‹œë„ ì¤‘... (' + (retryCount + 1) + '/' + maxRetries + ')');
          await delay(retryDelay);
          return executeStepWithSave(step, stepName, stepFunction, retryCount + 1);
        }
        
        // ì¬ì‹œë„ ì‹¤íŒ¨ ë˜ëŠ” ì¹˜ëª…ì  ì˜¤ë¥˜
        throw error;
      }
    }

    // ë³µêµ¬ í™•ì¸ ë° ì œì•ˆ
    async function checkRecovery() {
      try {
        // ë¨¼ì € ë°±ì—”ë“œ APIë¡œ ì§„í–‰ ì¤‘ì¸ ì‘ì—… í™•ì¸ (ìš°ì„ ìˆœìœ„)
        try {
          var projectId = localStorage.getItem('currentProjectId');
          if (projectId) {
            var response = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/auto-workflow/status/' + projectId);
            if (response.ok) {
              var data = await response.json();
              if (data.status === 'processing' || data.status === 'queued') {
                // ì§„í–‰ ì¤‘ì¸ ì‘ì—… ë°œê²¬ - ë³µêµ¬ ëª¨ë‹¬ í‘œì‹œ
                showRecoveryModal({
                  project_id: projectId,
                  last_success_step: data.current_step || 0,
                  last_success_step_name: data.current_step_name || 'ì•Œ ìˆ˜ ì—†ìŒ',
                  status: data.status,
                  progress: data.progress || 0,
                  intermediate_data: data.result_data || {}
                });
                
                // ìƒíƒœ í´ë§ ì‹œì‘
                pollWorkflowStatus(projectId);
                return;
              }
            }
          }
        } catch (e) {
          console.warn('ë°±ì—”ë“œ ë³µêµ¬ í™•ì¸ ì‹¤íŒ¨:', e);
        }

        // LocalStorageì—ì„œ ì²´í¬í¬ì¸íŠ¸ í™•ì¸ (ë°±ì—…)
        var savedCheckpoint = localStorage.getItem('auto_save_snapshot');
        if (!savedCheckpoint) {
          // ë°±ì—”ë“œ APIë¡œë„ í™•ì¸ (ë ˆê±°ì‹œ)
          try {
            var response = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/project/check-recovery');
            if (response.ok) {
              var data = await response.json();
              if (data.has_recovery) {
                savedCheckpoint = JSON.stringify(data.checkpoint);
              }
            }
          } catch (apiError) {
            console.warn('ë³µêµ¬ í™•ì¸ API í˜¸ì¶œ ì‹¤íŒ¨:', apiError);
          }
        }

        if (savedCheckpoint) {
          var checkpoint = JSON.parse(savedCheckpoint);
          
          // PROCESSING ìƒíƒœì¸ ê²½ìš°ì—ë§Œ ë³µêµ¬ ì œì•ˆ
          if (checkpoint.status === 'PROCESSING') {
            showRecoveryModal(checkpoint);
          }
        }
      } catch (error) {
        console.error('ë³µêµ¬ í™•ì¸ ì˜¤ë¥˜:', error);
      }
    }

    // ë³µêµ¬ ëª¨ë‹¬ í‘œì‹œ
    function showRecoveryModal(checkpoint) {
      var modal = document.createElement('div');
      modal.className = 'recovery-modal-overlay';
      modal.innerHTML = `
        <div class="recovery-modal">
          <div class="recovery-modal-title">ğŸ”„ ì§„í–‰ ì¤‘ì´ë˜ ì‘ì—… ë°œê²¬</div>
          <div class="recovery-modal-content">
            <p>ì§„í–‰ ì¤‘ì´ë˜ ìë™ ì œì‘ ì‘ì—…ì´ ìˆìŠµë‹ˆë‹¤.</p>
            <p><strong>ë§ˆì§€ë§‰ ì™„ë£Œ ë‹¨ê³„: ${checkpoint.last_success_step_name || 'Step ' + checkpoint.last_success_step}</strong></p>
            <p>ë§ˆì§€ë§‰ ì§€ì ë¶€í„° ì´ì–´ì„œ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
          </div>
          <div class="recovery-modal-actions">
            <button class="btn-recovery-resume" id="btnRecoveryResume">ì´ì–´ì„œ ì§„í–‰í•˜ê¸°</button>
            <button class="btn-recovery-cancel" id="btnRecoveryCancel">ìƒˆë¡œ ì‹œì‘í•˜ê¸°</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // ì´ì–´ì„œ ì§„í–‰í•˜ê¸°
      document.getElementById('btnRecoveryResume').onclick = function() {
        document.body.removeChild(modal);
        resumeAutoProcess(checkpoint);
      };

      // ìƒˆë¡œ ì‹œì‘í•˜ê¸°
      document.getElementById('btnRecoveryCancel').onclick = function() {
        document.body.removeChild(modal);
        clearCheckpoint();
      };
    }

    // ìë™í™” í”„ë¡œì„¸ìŠ¤ ì¬ê°œ
    async function resumeAutoProcess(checkpoint) {
      currentProjectId = checkpoint.project_id;
      var lastStep = checkpoint.last_success_step;
      
      // ì¤‘ê°„ ë°ì´í„° ë³µì›
      if (checkpoint.intermediate_data) {
        var data = checkpoint.intermediate_data;
        
        // ê° ë‹¨ê³„ë³„ ë°ì´í„° ë³µì›
        if (data.step >= 1) {
          globalState.chosenAiTopic = data.result?.title || localStorage.getItem('chosenAiTopic');
          globalState.expertSummary = data.result?.expertSummary || localStorage.getItem('expertSummary');
        }
        if (data.step >= 2) {
          localStorage.setItem('step2Payload', JSON.stringify(data.result?.step2Payload || {}));
        }
        if (data.step >= 3) {
          localStorage.setItem('step3Blueprint', JSON.stringify(data.result?.step3Blueprint || {}));
        }
        if (data.step >= 4) {
          localStorage.setItem('step4JsonPayload', JSON.stringify(data.result?.step4JsonPayload || {}));
        }
        if (data.step >= 5) {
          localStorage.setItem('step42JsonData', JSON.stringify(data.result?.step42JsonData || {}));
          localStorage.setItem('step6TTSData', JSON.stringify(data.result?.step6TTSData || {}));
        }
        if (data.step >= 6) {
          localStorage.setItem('step52BGMData', JSON.stringify(data.result?.step52BGMData || {}));
        }
        if (data.step >= 7) {
          localStorage.setItem('step7VideoData', JSON.stringify(data.result?.step7VideoData || {}));
        }
        if (data.step >= 8) {
          localStorage.setItem('step8TitleData', JSON.stringify(data.result?.step8TitleData || {}));
        }
      }

      // ë‹¤ìŒ ë‹¨ê³„ë¶€í„° ì¬ê°œ
      showProgressModal();
      updateProgressModal(lastStep, 9, 'ì‘ì—… ì¬ê°œ ì¤‘...', (lastStep / 9) * 100);
      
      await delay(1000);
      
      // ì¬ê°œ ì‹¤í–‰
      await startFullAutoProcessFromStep(lastStep + 1);
    }

    // ë°±ì—”ë“œ ìƒíƒœ í´ë§
    var pollingInterval = null;
    async function pollWorkflowStatus(projectId) {
      if (pollingInterval) {
        clearInterval(pollingInterval);
      }
      
      pollingInterval = setInterval(async function() {
        try {
          var response = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/auto-workflow/status/' + projectId);
          if (response.ok) {
            var data = await response.json();
            
            if (data.status === 'processing') {
              // ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸
              updateProgressModal(
                data.current_step || 0,
                9,
                data.current_step_name || 'ì§„í–‰ ì¤‘...',
                data.progress || 0
              );
            } else if (data.status === 'completed') {
              // ì™„ë£Œ
              clearInterval(pollingInterval);
              pollingInterval = null;
              hideProgressModal();
              alert('ğŸ‰ ì „ê³¼ì • ìë™ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\n9. ìµœì¢… ì œì‘ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
              window.location.href = 'step-10.html';
            } else if (data.status === 'failed') {
              // ì‹¤íŒ¨
              clearInterval(pollingInterval);
              pollingInterval = null;
              showProgressError('ì˜¤ë¥˜: ' + (data.error_message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'), true, true);
            }
          }
        } catch (error) {
          console.error('ìƒíƒœ í´ë§ ì˜¤ë¥˜:', error);
        }
      }, 5000); // 5ì´ˆë§ˆë‹¤ í´ë§
    }

    // ì²´í¬í¬ì¸íŠ¸ ì‚­ì œ
    function clearCheckpoint() {
      localStorage.removeItem('auto_save_snapshot');
      currentProjectId = null;
      
      // í´ë§ ì¤‘ì§€
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
      }
      
      // ë°±ì—”ë“œì—ë„ ì‚­ì œ ìš”ì²­
      if (currentProjectId) {
        fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/project/clear-checkpoint', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ project_id: currentProjectId })
        }).catch(function(error) {
          console.warn('ì²´í¬í¬ì¸íŠ¸ ì‚­ì œ API í˜¸ì¶œ ì‹¤íŒ¨:', error);
        });
      }
    }

    // íŠ¹ì • ë‹¨ê³„ë¶€í„° ì‹œì‘
    async function startFullAutoProcessFromStep(startStep) {
      // ì´ í•¨ìˆ˜ëŠ” startFullAutoProcessì˜ ìˆ˜ì •ëœ ë²„ì „ìœ¼ë¡œ,
      // startStepë¶€í„° ì‹œì‘í•˜ë„ë¡ êµ¬í˜„ë©ë‹ˆë‹¤.
      // ê¸°ì¡´ startFullAutoProcess í•¨ìˆ˜ë¥¼ ìˆ˜ì •í•˜ì—¬ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤.
      await startFullAutoProcess(true, startStep);
    }

    // ì „ê³¼ì • ìë™í™” ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ (ë°±ì—”ë“œ ì›Œì»¤ ì „í™˜)
    async function startFullAutoProcess(isResume, resumeFromStep) {
      if (isAutoProcessing) {
        alert('ì´ë¯¸ ìë™ ìƒì„±ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.');
        return;
      }

      // ë°±ì—”ë“œ ì›Œì»¤ë¡œ ì „í™˜: ì‘ì—… íì— ì¶”ê°€
      try {
        currentProjectId = currentProjectId || generateProjectId();
        localStorage.setItem('currentProjectId', currentProjectId);

        var step1Data = {
          selectedCategory: globalState.selectedCategory,
          keyword: globalState.keyword,
          selectedTopics: globalState.selectedTopics,
          channelInfo: globalState.channelInfo,
          chosenAiTopic: globalState.chosenAiTopic,
          expertSummary: globalState.expertSummary
        };

        var response = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/auto-workflow/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            project_id: currentProjectId,
            step1_data: step1Data,
            is_resume: isResume || false,
            resume_from_step: resumeFromStep || 1
          })
        });

        if (response.ok) {
          var data = await response.json();
          
          // ì§„í–‰ ëª¨ë‹¬ í‘œì‹œ
          showProgressModal();
          updateProgressModal(0, 9, 'ë°±ì—”ë“œ ì‘ì—… íì— ì¶”ê°€ë¨...', 0);
          
          // ìƒíƒœ í´ë§ ì‹œì‘
          pollWorkflowStatus(currentProjectId);
          
          return; // ë°±ì—”ë“œì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œ ì¢…ë£Œ
        } else {
          console.warn('ë°±ì—”ë“œ ì›Œì»¤ ì „í™˜ ì‹¤íŒ¨, ë¡œì»¬ ëª¨ë“œë¡œ ì§„í–‰');
          // ë°±ì—”ë“œ ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ë¡œì»¬ ëª¨ë“œë¡œ ì§„í–‰
        }
      } catch (error) {
        console.warn('ë°±ì—”ë“œ ì›Œì»¤ ì „í™˜ ì˜¤ë¥˜:', error);
        // ë°±ì—”ë“œ ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ë¡œì»¬ ëª¨ë“œë¡œ ì§„í–‰
      }

      // í™œì„±í™” ì¡°ê±´ ìµœì¢… í™•ì¸
      var hasTopic = globalState.selectedCategory || globalState.keyword || (globalState.selectedTopics && globalState.selectedTopics.length > 0);
      var hasKeyword = globalState.keyword || (globalState.selectedTopics && globalState.selectedTopics.length > 0);

      if (!hasTopic || !hasKeyword) {
        alert('ì£¼ì œì™€ í‚¤ì›Œë“œë¥¼ ëª¨ë‘ ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      // í”„ë¡œì íŠ¸ ID ì´ˆê¸°í™” (ì¬ê°œê°€ ì•„ë‹Œ ê²½ìš°)
      if (!isResume) {
        currentProjectId = generateProjectId();
      }

      showProgressModal();
      updateProgressModal(0, 9, 'ì´ˆê¸°í™” ì¤‘...', 0);

      try {
        var startStep = isResume ? resumeFromStep : 1;
        
        // Step 1: ì£¼ì œ ì„ íƒ ë° AI ì£¼ì œ ìƒì„± (10%)
        if (startStep <= 1) {
          updateProgressModal(1, 9, 'Step 1: AI ì£¼ì œ ìƒì„± ì¤‘...', 10);
          var topics = await executeStepWithSave(1, 'Step 1: AI ì£¼ì œ ìƒì„±', async function() {
            var topics = generateAiTopics();
            if (!topics || topics.length === 0) {
              throw new Error('AI ì£¼ì œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            
            // ì²« ë²ˆì§¸ ì£¼ì œ ìë™ ì„ íƒ
            var selectedTopic = topics[0];
            globalState.aiTopics = topics;
            globalState.chosenAiTopic = selectedTopic.title;
            globalState.expertSummary = selectedTopic.reason || selectedTopic.summary || '';
            localStorage.setItem('chosenAiTopic', globalState.chosenAiTopic);
            localStorage.setItem('expertSummary', globalState.expertSummary);
            localStorage.setItem('aiTopics', JSON.stringify(topics));
            
            return { topics: topics, selectedTopic: selectedTopic };
          });
          
          var selectedTopic = topics.selectedTopic;
          await delay(500);
        } else {
          // ì¬ê°œ ì‹œ: ì €ì¥ëœ ë°ì´í„° ë¡œë“œ
          var savedTopics = JSON.parse(localStorage.getItem('aiTopics') || '[]');
          var selectedTopic = savedTopics[0] || { title: localStorage.getItem('chosenAiTopic') || '', reason: localStorage.getItem('expertSummary') || '' };
        }

        // Step 2-3: ê¸°íš & ëŒ€ë³¸ (10% â†’ 30%)
        var step2Payload;
        if (startStep <= 2) {
          updateProgressModal(2, 9, 'Step 2: ëŒ€ë³¸ ê¸°íš ì¤‘...', 15);
          step2Payload = await executeStepWithSave(2, 'Step 2: ëŒ€ë³¸ ê¸°íš', async function() {
            return await autoStep2Blueprint(selectedTopic);
          });
          if (!step2Payload) {
            throw new Error('ëŒ€ë³¸ ê¸°íšì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
          localStorage.setItem('step2Payload', JSON.stringify(step2Payload));
          await delay(300);
        } else {
          step2Payload = JSON.parse(localStorage.getItem('step2Payload') || '{}');
        }

        var step3Blueprint;
        if (startStep <= 3) {
          updateProgressModal(3, 9, 'Step 3: ì‹œë‹ˆì–´ ë§ì¶¤í˜• ëŒ€ë³¸ ìƒì„± ì¤‘...', 30);
          step3Blueprint = await executeStepWithSave(3, 'Step 3: ëŒ€ë³¸ ìƒì„±', async function() {
            return await autoStep3Script(step2Payload);
          });
          if (!step3Blueprint) {
            throw new Error('ëŒ€ë³¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
          localStorage.setItem('step3Blueprint', JSON.stringify(step3Blueprint));
          await delay(300);
        } else {
          step3Blueprint = JSON.parse(localStorage.getItem('step3Blueprint') || '{}');
        }

        // Step 4-1: JSON ìƒì„±
        var step4JsonPayload;
        if (startStep <= 4) {
          updateProgressModal(4, 9, 'Step 4-1: JSON ë°ì´í„° ì¶”ì¶œ ì¤‘...', 35);
          step4JsonPayload = await executeStepWithSave(4, 'Step 4-1: JSON ì¶”ì¶œ', async function() {
            return await autoStep4Json(step3Blueprint);
          });
          if (!step4JsonPayload) {
            throw new Error('JSON ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
          localStorage.setItem('step4JsonPayload', JSON.stringify(step4JsonPayload));
          await delay(300);
        } else {
          step4JsonPayload = JSON.parse(localStorage.getItem('step4JsonPayload') || '{}');
        }

        // Step 4-2 & 5: ë¦¬ì†ŒìŠ¤ ìƒì„± (ë³‘ë ¬ ì‹¤í–‰) (30% â†’ 50%)
        if (startStep <= 5) {
          updateProgressModal(5, 9, 'Step 4-2 & 5: ì´ë¯¸ì§€ ë° TTS ë™ì‹œ ìƒì„± ì¤‘...', 40);
          
          // ë³‘ë ¬ ì‹¤í–‰ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
          var step5Result = await executeStepWithSave(5, 'Step 4-2 & 5: ë¦¬ì†ŒìŠ¤ ìƒì„±', async function() {
            var imagePromise = autoStep42Images(step4JsonPayload);
            var ttsPromise = autoStep5TTS(step3Blueprint);
            
            var results = await Promise.allSettled([imagePromise, ttsPromise]);
        
            var step42JsonData = results[0].status === 'fulfilled' ? results[0].value : null;
            var step6TTSData = results[1].status === 'fulfilled' ? results[1].value : null;

            if (!step42JsonData) {
              console.warn('ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨, Placeholder ì‚¬ìš©');
              step42JsonData = { jsonData: step4JsonPayload.jsonData, images: [] };
            }
            if (!step6TTSData) {
              console.warn('TTS ìƒì„± ì‹¤íŒ¨, Placeholder ì‚¬ìš©');
              step6TTSData = { scenes: [] };
            }

            localStorage.setItem('step42JsonData', JSON.stringify(step42JsonData));
            localStorage.setItem('step6TTSData', JSON.stringify(step6TTSData));
            
            return { step42JsonData: step42JsonData, step6TTSData: step6TTSData };
          });
          
          var step42JsonData = step5Result.step42JsonData;
          var step6TTSData = step5Result.step6TTSData;
          await delay(500);
        } else {
          step42JsonData = JSON.parse(localStorage.getItem('step42JsonData') || '{}');
          step6TTSData = JSON.parse(localStorage.getItem('step6TTSData') || '{}');
        }

        // Step 5-2: ìŒì•… ë§¤ì¹­ (50% â†’ 70%)
        if (startStep <= 6) {
          updateProgressModal(6, 9, 'Step 5-2: BGM í•«ìŠ¤íŒŸ ë¶„ì„ ë° ë¹„íŠ¸ ë™ê¸°í™” ì¤‘...', 50);
          var step52BGMData = await executeStepWithSave(6, 'Step 5-2: BGM ì‚½ì…', async function() {
            return await autoStep52BGM(step2Payload, step6TTSData);
          });
          if (!step52BGMData) {
            throw new Error('BGM ì‚½ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
          localStorage.setItem('step52BGMData', JSON.stringify(step52BGMData));
          await delay(500);
        } else {
          step52BGMData = JSON.parse(localStorage.getItem('step52BGMData') || '{}');
        }

        // Step 6: ì˜ìƒ ë Œë”ë§ (ì¥ì‹œê°„ ì‘ì—…)
        var step7VideoData;
        if (startStep <= 7) {
          updateProgressModal(7, 9, 'Step 6: VEO ì˜ìƒ ë Œë”ë§ ì¤‘... (ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)', 70);
          
          // ì¥ì‹œê°„ ì‘ì—… ì•Œë¦¼ ì˜µì…˜ í‘œì‹œ
          var notifyOption = confirm('ì˜ìƒ ë Œë”ë§ì€ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\në¸Œë¼ìš°ì €ë¥¼ ë‹«ì•„ë„ ì„œë²„ì—ì„œ ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤.\nì™„ë£Œ ì‹œ ì•Œë¦¼ì„ ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?');
          
          step7VideoData = await executeStepWithSave(7, 'Step 6: ì˜ìƒ ë Œë”ë§', async function() {
            // ì„œë²„ ì‚¬ì´ë“œ ë Œë”ë§ ìš”ì²­ (ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…)
            var renderResponse = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/generate-video/async', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                project_id: currentProjectId,
                image_data: step42JsonData,
                tts_data: step6TTSData,
                bgm_data: step52BGMData,
                notify_email: notifyOption ? prompt('ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”:') : null
              })
            });
            
            if (!renderResponse.ok) {
              // ë™ê¸° ë°©ì‹ìœ¼ë¡œ í´ë°±
              return await autoStep6Video(step42JsonData, step6TTSData, step52BGMData);
            }
            
            var renderData = await renderResponse.json();
            
            // ë¹„ë™ê¸° ì‘ì—…ì´ë©´ í´ë§
            if (renderData.status === 'processing') {
              updateProgressModal(7, 9, 'Step 6: ì„œë²„ì—ì„œ ì˜ìƒ ë Œë”ë§ ì¤‘... (ë°±ê·¸ë¼ìš´ë“œ ì§„í–‰)', 70);
              
              // í´ë§ìœ¼ë¡œ ìƒíƒœ í™•ì¸
              var pollInterval = setInterval(async function() {
                try {
                  var statusResponse = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/generate-video/status/' + renderData.task_id);
                  var statusData = await statusResponse.json();
                  
                  if (statusData.status === 'completed') {
                    clearInterval(pollInterval);
                    return statusData.result;
                  } else if (statusData.status === 'failed') {
                    clearInterval(pollInterval);
                    throw new Error('ì˜ìƒ ë Œë”ë§ ì‹¤íŒ¨');
                  }
                } catch (error) {
                  clearInterval(pollInterval);
                  throw error;
                }
              }, 5000); // 5ì´ˆë§ˆë‹¤ í™•ì¸
              
              // ìµœëŒ€ 10ë¶„ ëŒ€ê¸°
              await new Promise(function(resolve) {
                setTimeout(resolve, 600000);
              });
              
              // ìµœì¢… ìƒíƒœ í™•ì¸
              var finalResponse = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/generate-video/status/' + renderData.task_id);
              var finalData = await finalResponse.json();
              
              if (finalData.status === 'completed') {
                return finalData.result;
              } else {
                throw new Error('ì˜ìƒ ë Œë”ë§ ì‹œê°„ ì´ˆê³¼');
              }
            }
            
            return renderData.result;
          });
          
          if (!step7VideoData) {
            throw new Error('ì˜ìƒ ë Œë”ë§ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
          localStorage.setItem('step7VideoData', JSON.stringify(step7VideoData));
          await delay(1000);
        } else {
          step7VideoData = JSON.parse(localStorage.getItem('step7VideoData') || '{}');
        }

        // Step 7-8: ë§ˆì¼€íŒ… íŒ¨í‚¤ì§• (70% â†’ 90%)
        if (startStep <= 8) {
          updateProgressModal(8, 9, 'Step 7-8: ì œëª©/ì„¤ëª… ì‘ì„± ë° ì¸ë„¤ì¼ ìƒì„± ì¤‘...', 90);
          var step8TitleData = await executeStepWithSave(8, 'Step 7-8: ë©”íƒ€ë°ì´í„° ìƒì„±', async function() {
            var titleData = await autoStep78Metadata(step2Payload, step3Blueprint, step7VideoData);
            if (!titleData) {
              throw new Error('ë©”íƒ€ë°ì´í„° ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            localStorage.setItem('step8TitleData', JSON.stringify(titleData));
            
            var thumbnailData = await autoStep8Thumbnail(step42JsonData, titleData);
            if (!thumbnailData) {
              throw new Error('ì¸ë„¤ì¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            localStorage.setItem('step9ThumbnailData', JSON.stringify(thumbnailData));
            
            return { step8TitleData: titleData, step9ThumbnailData: thumbnailData };
          });
          
          await delay(500);
        }

        // ì™„ë£Œ (100%)
        updateProgressModal(9, 9, 'âœ… ì œì‘ ì™„ë£Œ!', 100);
        
        // ìµœì¢… ì²´í¬í¬ì¸íŠ¸ ì €ì¥ (ì™„ë£Œ ìƒíƒœ)
        await saveCheckpoint(9, 'ì™„ë£Œ', { status: 'COMPLETED' });
        
        // ì²´í¬í¬ì¸íŠ¸ ì‚­ì œ
        clearCheckpoint();
        
        await delay(1500);

        hideProgressModal();
        alert('ğŸ‰ ì „ê³¼ì • ìë™ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\n9. ìµœì¢… ì œì‘ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
        window.location.href = 'step-10.html';

      } catch (error) {
        console.error('ìë™ ìƒì„± ì˜¤ë¥˜:', error);
        autoProcessError = error;
        
        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì²´í¬í¬ì¸íŠ¸ ì €ì¥ (ì—ëŸ¬ ìƒíƒœ)
        await saveCheckpoint(currentAutoStep, 'ì˜¤ë¥˜ ë°œìƒ', { 
          error: error.message,
          status: 'ERROR'
        });
        
        showProgressError('ì˜¤ë¥˜: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.') + '\n\ní˜„ì¬ ë‹¨ê³„ì—ì„œ ë©ˆì·„ìŠµë‹ˆë‹¤. ìˆ˜ë™ ì „í™˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ í•´ë‹¹ ë‹¨ê³„ë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', true, true);
        
        // ì¬ì‹œë„ ë²„íŠ¼ ì´ë²¤íŠ¸
        var retryBtn = document.getElementById('progressRetryBtn');
        if (retryBtn) {
          retryBtn.onclick = function() {
            startFullAutoProcess();
          };
        }
      }
    }

    // ì§€ì—° í•¨ìˆ˜
    function delay(ms) {
      return new Promise(function(resolve) {
        setTimeout(resolve, ms);
      });
    }

    // Step 2: ëŒ€ë³¸ ê¸°íš ìë™í™”
    async function autoStep2Blueprint(selectedTopic) {
      try {
        var response = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/generate-blueprint', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            topic: selectedTopic.title,
            expert_summary: selectedTopic.reason || selectedTopic.summary,
            keyword: globalState.keyword,
            category: globalState.selectedCategory
          })
        });

        if (!response.ok) {
          throw new Error('ëŒ€ë³¸ ê¸°íš API í˜¸ì¶œ ì‹¤íŒ¨');
        }

        var data = await response.json();
        var result = {
          title: data.title || selectedTopic.title,
          target: data.target || 'ì‹œë‹ˆì–´',
          hook: data.hook || 'ì‹œì‘ ë¬¸êµ¬',
          storyline: data.storyline || ['ì˜¤í”„ë‹', 'í•µì‹¬1', 'ë§ˆë¬´ë¦¬']
        };
        
        // Step 2 Success ë¡œê·¸
        console.log('[Step 2 Success] ëŒ€ë³¸ ê¸°íš ì™„ë£Œ', {
          title: result.title,
          target: result.target,
          storylineCount: result.storyline.length
        });
        
        // ì„œë²„ ë¡œê·¸ (ì˜µì…˜)
        try {
          await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              step: 2,
              stepName: 'ëŒ€ë³¸ ê¸°íš',
              status: 'success',
              data: { title: result.title, target: result.target }
            })
          }).catch(function(e) {
            console.warn('ì„œë²„ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', e);
          });
        } catch (e) {
          console.warn('ì„œë²„ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', e);
        }
        
        return result;
      } catch (error) {
        console.warn('ëŒ€ë³¸ ê¸°íš API ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', error);
        // ê¸°ë³¸ê°’ìœ¼ë¡œ ëŒ€ì²´
        return {
          title: selectedTopic.title,
          target: 'ì‹œë‹ˆì–´',
          hook: 'ì´ ì˜ìƒì€ ì‹œë‹ˆì–´ë¥¼ ìœ„í•œ ë§ì¶¤í˜• ì½˜í…ì¸ ì…ë‹ˆë‹¤.',
          storyline: ['ì˜¤í”„ë‹', 'í•µì‹¬1', 'í•µì‹¬2', 'ë§ˆë¬´ë¦¬']
        };
      }
    }

    // Step 3: ëŒ€ë³¸ ìƒì„± ìë™í™”
    async function autoStep3Script(blueprint) {
      try {
        var response = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/generate-script', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            blueprint: blueprint,
            tone: 'ì „ë¬¸ì ìœ¼ë¡œ',
            expert_persona: '10ë…„ ê²½ë ¥ì˜ ì „ë¬¸ ì½˜í…ì¸  ì „ëµê°€ì´ì í•´ë‹¹ ë¶„ì•¼ì˜ ìˆ˜ì„ ì—°êµ¬ì›'
          })
        });

        if (!response.ok) {
          throw new Error('ëŒ€ë³¸ ìƒì„± API í˜¸ì¶œ ì‹¤íŒ¨');
        }

        var data = await response.json();
        var result = {
          ...blueprint,
          script: data.script || 'ëŒ€ë³¸ ë‚´ìš©ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤.',
          scenes: data.scenes || blueprint.storyline.map(function(title, idx) {
            return { scene_num: idx + 1, scene_title: title, script: '' };
          })
        };
        
        // Step 3 Success ë¡œê·¸
        console.log('[Step 3 Success] ëŒ€ë³¸ ìƒì„± ì™„ë£Œ', {
          scriptLength: result.script.length,
          scenesCount: result.scenes.length,
          tone: 'ì „ë¬¸ì ìœ¼ë¡œ'
        });
        
        // ì„œë²„ ë¡œê·¸ (ì˜µì…˜)
        try {
          await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              step: 3,
              stepName: 'ëŒ€ë³¸ ìƒì„±',
              status: 'success',
              data: { scriptLength: result.script.length, scenesCount: result.scenes.length }
            })
          }).catch(function(e) {
            console.warn('ì„œë²„ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', e);
          });
        } catch (e) {
          console.warn('ì„œë²„ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', e);
        }
        
        return result;
      } catch (error) {
        console.warn('ëŒ€ë³¸ ìƒì„± API ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', error);
        // ê¸°ë³¸ê°’ìœ¼ë¡œ ëŒ€ì²´
        var defaultScript = blueprint.storyline.map(function(title, idx) {
          return '[' + title + '] ì´ êµ¬ê°„ì˜ ëŒ€ë³¸ì´ ìƒì„±ë©ë‹ˆë‹¤.';
        }).join('\n\n');
        return {
          ...blueprint,
          script: defaultScript,
          scenes: blueprint.storyline.map(function(title, idx) {
            return { scene_num: idx + 1, scene_title: title, script: '[' + title + '] ëŒ€ë³¸' };
          })
        };
      }
    }

    // Step 4-1: JSON ìƒì„± ìë™í™”
    async function autoStep4Json(blueprint) {
      try {
        var scenes = blueprint.scenes || blueprint.storyline.map(function(title, idx) {
          return { scene_num: idx + 1, scene_title: title };
        });

        var jsonData = {
          script: blueprint.script,
          jsonData: {
            scenes: scenes.map(function(scene) {
              return {
                scene_num: scene.scene_num || scene.scene_no || 1,
                script: scene.script || '',
                image_prompt: 'A professional image for ' + (scene.scene_title || 'scene') + ', high quality, detailed',
                visual_description: 'Visual description for ' + (scene.scene_title || 'scene')
              };
            })
          }
        };

        // Step 4-1 Success ë¡œê·¸
        console.log('[Step 4-1 Success] JSON ì¶”ì¶œ ì™„ë£Œ', {
          scenesCount: jsonData.jsonData.scenes.length
        });
        
        // ì„œë²„ ë¡œê·¸ (ì˜µì…˜)
        try {
          await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              step: 4,
              stepName: 'JSON ì¶”ì¶œ',
              status: 'success',
              data: { scenesCount: jsonData.jsonData.scenes.length }
            })
          }).catch(function(e) {
            console.warn('ì„œë²„ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', e);
          });
        } catch (e) {
          console.warn('ì„œë²„ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', e);
        }
        
        return jsonData;
      } catch (error) {
        console.error('JSON ìƒì„± ì‹¤íŒ¨:', error);
        throw error;
      }
    }

    // Step 4-2: ì´ë¯¸ì§€ ìƒì„± ìë™í™”
    async function autoStep42Images(jsonPayload) {
      try {
        var scenes = jsonPayload.jsonData.scenes;
        var imageResults = [];

        for (var i = 0; i < scenes.length; i++) {
          var scene = scenes[i];
          try {
            var response = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/generate-image', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                prompt: scene.image_prompt,
                engine: 'nano_basic'
              })
            });

            if (response.ok) {
              var data = await response.json();
              imageResults.push({
                scene_num: scene.scene_num,
                image_url: data.image_url || 'placeholder_image.jpg',
                status: 'success'
              });
            } else {
              throw new Error('ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨');
            }
          } catch (error) {
            console.warn('ì”¬ ' + scene.scene_num + ' ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨, Placeholder ì‚¬ìš©:', error);
            // Placeholderë¡œ ëŒ€ì²´
            imageResults.push({
              scene_num: scene.scene_num,
              image_url: 'placeholder_image.jpg',
              status: 'placeholder'
            });
          }
          await delay(500); // API í˜¸ì¶œ ê°„ê²©
        }

        var result = {
          jsonData: jsonPayload.jsonData,
          images: imageResults
        };
        
        // Step 4-2 Success ë¡œê·¸
        var successCount = imageResults.filter(function(img) { return img.status === 'success'; }).length;
        var placeholderCount = imageResults.filter(function(img) { return img.status === 'placeholder'; }).length;
        console.log('[Step 4-2 Success] ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ', {
          imagesCount: imageResults.length,
          successCount: successCount,
          placeholderCount: placeholderCount
        });
        
        // ì„œë²„ ë¡œê·¸ (ì˜µì…˜)
        try {
          await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              step: 4.2,
              stepName: 'ì´ë¯¸ì§€ ìƒì„±',
              status: 'success',
              data: { imagesCount: imageResults.length, successCount: successCount }
            })
          }).catch(function(e) {
            console.warn('ì„œë²„ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', e);
          });
        } catch (e) {
          console.warn('ì„œë²„ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', e);
        }
        
        return result;
      } catch (error) {
        console.error('ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:', error);
        throw error;
      }
    }

    // Step 5: TTS ìƒì„± ìë™í™”
    async function autoStep5TTS(blueprint) {
      try {
        var scenes = blueprint.scenes || [];
        var ttsResults = [];

        for (var i = 0; i < scenes.length; i++) {
          var scene = scenes[i];
          try {
            var response = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/generate-tts', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                text: scene.script || '',
                engine: 'google',
                voice: 'ko-KR-Standard-A',
                speed: 0.9,
                pitch: 1.0
              })
            });

            if (response.ok) {
              var data = await response.json();
              ttsResults.push({
                scene_num: scene.scene_num || i + 1,
                audio_url: data.audio_url || 'placeholder_audio.mp3',
                duration: data.duration || 30,
                status: 'success'
              });
            } else {
              throw new Error('TTS ìƒì„± ì‹¤íŒ¨');
            }
          } catch (error) {
            console.warn('ì”¬ ' + (scene.scene_num || i + 1) + ' TTS ìƒì„± ì‹¤íŒ¨, Placeholder ì‚¬ìš©:', error);
            // Placeholderë¡œ ëŒ€ì²´
            ttsResults.push({
              scene_num: scene.scene_num || i + 1,
              audio_url: 'placeholder_audio.mp3',
              duration: 30,
              status: 'placeholder'
            });
          }
          await delay(500);
        }

        var result = {
          scenes: ttsResults
        };
        
        // Step 5 Success ë¡œê·¸
        var successCount = ttsResults.filter(function(tts) { return tts.status === 'success'; }).length;
        console.log('[Step 5 Success] TTS ìƒì„± ì™„ë£Œ', {
          ttsCount: ttsResults.length,
          successCount: successCount
        });
        
        // ì„œë²„ ë¡œê·¸ (ì˜µì…˜)
        try {
          await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              step: 5,
              stepName: 'TTS ìƒì„±',
              status: 'success',
              data: { ttsCount: ttsResults.length, successCount: successCount }
            })
          }).catch(function(e) {
            console.warn('ì„œë²„ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', e);
          });
        } catch (e) {
          console.warn('ì„œë²„ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', e);
        }
        
        return result;
      } catch (error) {
        console.error('TTS ìƒì„± ì‹¤íŒ¨:', error);
        throw error;
      }
    }

    // Step 5-2: BGM ì‚½ì… ìë™í™”
    async function autoStep52BGM(blueprint, ttsData) {
      try {
        var response = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/recommend-bgm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: blueprint.title,
            target: blueprint.target,
            mood: 'ì •ë³´ì „ë‹¬',
            expert_summary: globalState.expertSummary
          })
        });

        var bgmData = null;
        if (response.ok) {
          bgmData = await response.json();
        } else {
          // ê¸°ë³¸ BGM ë°ì´í„° ì‚¬ìš©
          bgmData = {
            track_url: 'default_bgm.mp3',
            bpm: 120,
            mood: 'ì •ë³´ì „ë‹¬'
          };
        }

        var result = {
          bgm_data: bgmData,
          tts_data: ttsData,
          bgm_volume: 20,
          voice_volume: 100
        };
        
        // Step 5-2 Success ë¡œê·¸
        console.log('[Step 5-2 Success] BGM ì‚½ì… ì™„ë£Œ', {
          bgmMood: bgmData.mood || 'ì •ë³´ì „ë‹¬',
          bpm: bgmData.bpm || 120
        });
        
        // ì„œë²„ ë¡œê·¸ (ì˜µì…˜)
        try {
          await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              step: 5.2,
              stepName: 'BGM ì‚½ì…',
              status: 'success',
              data: { mood: bgmData.mood, bpm: bgmData.bpm }
            })
          }).catch(function(e) {
            console.warn('ì„œë²„ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', e);
          });
        } catch (e) {
          console.warn('ì„œë²„ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', e);
        }
        
        return result;
      } catch (error) {
        console.warn('BGM ì¶”ì²œ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', error);
        var result = {
          bgm_data: {
            track_url: 'default_bgm.mp3',
            bpm: 120,
            mood: 'ì •ë³´ì „ë‹¬'
          },
          tts_data: ttsData,
          bgm_volume: 20,
          voice_volume: 100
        };
        
        // ì‹¤íŒ¨ ì‹œì—ë„ ë¡œê·¸ ê¸°ë¡
        console.log('[Step 5-2 Success] BGM ì‚½ì… ì™„ë£Œ (ê¸°ë³¸ê°’ ì‚¬ìš©)', {
          bgmMood: 'ì •ë³´ì „ë‹¬',
          bpm: 120
        });
        
        return result;
      }
    }

    // Step 6: ì˜ìƒ ë Œë”ë§ ìë™í™”
    async function autoStep6Video(imageData, ttsData, bgmData) {
      try {
        var scenes = imageData.jsonData.scenes;
        var videoResults = [];

        for (var i = 0; i < scenes.length; i++) {
          var scene = scenes[i];
          var imageUrl = imageData.images.find(function(img) {
            return img.scene_num === scene.scene_num;
          });
          var audioUrl = ttsData.scenes.find(function(tts) {
            return tts.scene_num === scene.scene_num;
          });

          if (!imageUrl || !audioUrl) {
            console.warn('ì”¬ ' + scene.scene_num + ' ë°ì´í„° ëˆ„ë½, ê±´ë„ˆëœ€');
            continue;
          }

          try {
            var response = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/generate-video', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                image_url: imageUrl.image_url,
                audio_url: audioUrl.audio_url,
                audio_duration: audioUrl.duration,
                model: 'veo2',
                camera_motion: 'Zoom In',
                bpm: bgmData.bgm_data ? bgmData.bgm_data.bpm : null
              })
            });

            if (response.ok) {
              var data = await response.json();
              videoResults.push({
                scene_num: scene.scene_num,
                video_url: data.video_url || 'placeholder_video.mp4',
                status: 'success'
              });
            } else {
              throw new Error('ì˜ìƒ ìƒì„± ì‹¤íŒ¨');
            }
          } catch (error) {
            console.warn('ì”¬ ' + scene.scene_num + ' ì˜ìƒ ìƒì„± ì‹¤íŒ¨, Placeholder ì‚¬ìš©:', error);
            videoResults.push({
              scene_num: scene.scene_num,
              video_url: 'placeholder_video.mp4',
              status: 'placeholder'
            });
          }
          await delay(1000);
        }

        var result = {
          videos: videoResults,
          jsonData: imageData.jsonData
        };
        
        // Step 6 Success ë¡œê·¸
        var successCount = videoResults.filter(function(v) { return v.status === 'success'; }).length;
        console.log('[Step 6 Success] ì˜ìƒ ë Œë”ë§ ì™„ë£Œ', {
          videosCount: videoResults.length,
          successCount: successCount
        });
        
        // ì„œë²„ ë¡œê·¸ (ì˜µì…˜)
        try {
          await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              step: 6,
              stepName: 'ì˜ìƒ ë Œë”ë§',
              status: 'success',
              data: { videosCount: videoResults.length, successCount: successCount }
            })
          }).catch(function(e) {
            console.warn('ì„œë²„ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', e);
          });
        } catch (e) {
          console.warn('ì„œë²„ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', e);
        }
        
        return result;
      } catch (error) {
        console.error('ì˜ìƒ ë Œë”ë§ ì‹¤íŒ¨:', error);
        throw error;
      }
    }

    // Step 7-8: ì œëª©/ì„¤ëª… ë° ì¸ë„¤ì¼ ìë™í™”
    async function autoStep78Metadata(blueprint, scriptBlueprint, videoData) {
      try {
        var response = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/generate-metadata', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: blueprint.title,
            target: blueprint.target,
            script_summary: scriptBlueprint.script ? scriptBlueprint.script.substring(0, 500) : '',
            aggro_level: 3
          })
        });

        var metadata = null;
        if (response.ok) {
          metadata = await response.json();
        } else {
          // ê¸°ë³¸ê°’ ì‚¬ìš©
          metadata = {
            selectedTitle: blueprint.title,
            description: 'ì´ ì˜ìƒì€ ' + blueprint.target + 'ì„ ìœ„í•œ ì½˜í…ì¸ ì…ë‹ˆë‹¤.',
            hashtags: ['#' + blueprint.title.replace(/\s+/g, '')]
          };
        }

        // Step 7-8 Success ë¡œê·¸
        console.log('[Step 7-8 Success] ë©”íƒ€ë°ì´í„° ìƒì„± ì™„ë£Œ', {
          title: metadata.selectedTitle,
          hashtagsCount: metadata.hashtags ? metadata.hashtags.length : 0
        });
        
        // ì„œë²„ ë¡œê·¸ (ì˜µì…˜)
        try {
          await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              step: 7.8,
              stepName: 'ë©”íƒ€ë°ì´í„° ìƒì„±',
              status: 'success',
              data: { title: metadata.selectedTitle }
            })
          }).catch(function(e) {
            console.warn('ì„œë²„ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', e);
          });
        } catch (e) {
          console.warn('ì„œë²„ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', e);
        }
        
        return metadata;
      } catch (error) {
        console.warn('ë©”íƒ€ë°ì´í„° ìƒì„± ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', error);
        var metadata = {
          selectedTitle: blueprint.title,
          description: 'ì´ ì˜ìƒì€ ' + blueprint.target + 'ì„ ìœ„í•œ ì½˜í…ì¸ ì…ë‹ˆë‹¤.',
          hashtags: ['#' + blueprint.title.replace(/\s+/g, '')]
        };
        
        // ì‹¤íŒ¨ ì‹œì—ë„ ë¡œê·¸ ê¸°ë¡
        console.log('[Step 7-8 Success] ë©”íƒ€ë°ì´í„° ìƒì„± ì™„ë£Œ (ê¸°ë³¸ê°’ ì‚¬ìš©)', {
          title: metadata.selectedTitle
        });
        
        return metadata;
      }
    }

    async function autoStep8Thumbnail(imageData, titleData) {
      try {
        var firstImage = imageData.images && imageData.images.length > 0 ? imageData.images[0].image_url : null;
        
        if (!firstImage) {
          throw new Error('ì¸ë„¤ì¼ìš© ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }

        var response = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/generate-thumbnail', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            image_url: firstImage,
            title: titleData.selectedTitle,
            font_style: 'bold',
            effects: {
              stroke: true,
              shadow: true,
              background_box: false
            }
          })
        });

        var thumbnailData = null;
        if (response.ok) {
          thumbnailData = await response.json();
        } else {
          // ê¸°ë³¸ê°’ ì‚¬ìš©
          thumbnailData = {
            thumbnailImageUrl: firstImage || 'placeholder_thumbnail.jpg'
          };
        }

        return thumbnailData;
      } catch (error) {
        console.warn('ì¸ë„¤ì¼ ìƒì„± ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', error);
        return {
          thumbnailImageUrl: 'placeholder_thumbnail.jpg'
        };
      }
    }

    // ì „ê³¼ì • Auto ë²„íŠ¼ ì´ë²¤íŠ¸
    var btnFullAuto = document.getElementById('btnFullAuto');
    if (btnFullAuto) {
      btnFullAuto.addEventListener('click', function() {
        if (this.disabled) return;
        if (confirm('ì „ê³¼ì • ìë™ ìƒì„±ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nëª¨ë“  ë‹¨ê³„ê°€ ìë™ìœ¼ë¡œ ì§„í–‰ë˜ë©°, ì™„ë£Œ í›„ 9. ìµœì¢… ì œì‘ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.')) {
          startFullAutoProcess();
        }
      });
    }

    // ìƒíƒœ ë³€ê²½ ì‹œ ë²„íŠ¼ í™œì„±í™” ì²´í¬
    function setupAutoButtonWatcher() {
      // í‚¤ì›Œë“œ ì…ë ¥ ê°ì§€
      if (keywordInputEl) {
        keywordInputEl.addEventListener('input', function() {
          globalState.keyword = this.value.trim();
          saveGlobalState();
          checkAutoButtonState();
        });
      }

      // ì£¼ì œ ì„ íƒ ê°ì§€
      var observer = new MutationObserver(function() {
        checkAutoButtonState();
      });

      // topicsGrid ê°ì‹œ
      if (topicsGridEl) {
        observer.observe(topicsGridEl, { childList: true, subtree: true, attributes: true, attributeFilter: ['class'] });
      }
    }

    // ì´ˆê¸°í™”
    // ë³µì œëœ ì„¤ì • ë¡œë“œ (ì‘ì—… ë³´ê´€í•¨ì—ì„œ ë³µì œí•œ ê²½ìš°)
    (function loadClonedSettings() {
      try {
        var clonedSettingsRaw = localStorage.getItem('clonedSettings');
        if (clonedSettingsRaw) {
          var clonedSettings = JSON.parse(clonedSettingsRaw);
          
          // ë³µì œëœ ì„¤ì •ì„ UIì— ì ìš©í•  ìˆ˜ ìˆë„ë¡ ì €ì¥
          // (ë‚˜ì¤‘ì— ì‚¬ìš©ìê°€ ì„ íƒí•  ìˆ˜ ìˆë„ë¡)
          if (clonedSettings.tone) {
            console.log('[ë³µì œëœ ì„¤ì •] í†¤ì•¤ë§¤ë„ˆ:', clonedSettings.tone);
          }
          if (clonedSettings.imagePrompts && clonedSettings.imagePrompts.length > 0) {
            console.log('[ë³µì œëœ ì„¤ì •] ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸:', clonedSettings.imagePrompts.length + 'ê°œ ì”¬');
          }
          if (clonedSettings.bgmSettings) {
            console.log('[ë³µì œëœ ì„¤ì •] BGM ì„¤ì •:', clonedSettings.bgmSettings);
          }
          if (clonedSettings.beatDropEffects) {
            console.log('[ë³µì œëœ ì„¤ì •] ë¹„íŠ¸ ë“œë¡­ íš¨ê³¼:', clonedSettings.beatDropEffects);
          }
          
          // ë³µì œëœ ì„¤ì • ì‚¬ìš© í›„ ì‚­ì œ
          localStorage.removeItem('clonedSettings');
          
          // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
          setTimeout(function() {
            alert('ì´ì „ í”„ë¡œì íŠ¸ì˜ ì„¤ì •ì´ ë³µì œë˜ì—ˆìŠµë‹ˆë‹¤. ë™ì¼í•œ í†¤ì•¤ë§¤ë„ˆì™€ íš¨ê³¼ë¡œ ìƒˆ ì˜ìƒì„ ì œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          }, 500);
        }
      } catch (e) {
        console.error('ë³µì œëœ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e);
      }
    })();

    checkLoginStatus();
    loadGlobalState();
    
    // í˜ì´ì§€ ì ‘ì† ì‹œ ë‚ ì§œ ì²´í¬ ë° ìµœì‹  ë°ì´í„° ë¡œë“œ
    checkAndRefreshData();
    loadWeeklyTopics();
    
    // ìë™ ê°±ì‹  ì„¤ì •
    setupAutoRefresh();
    
    syncMutualExclusion();
    
    // ì „ê³¼ì • Auto ë²„íŠ¼ ìƒíƒœ ì²´í¬
    checkAutoButtonState();
    setupAutoButtonWatcher();
    
    // ë³µêµ¬ í™•ì¸ (í˜ì´ì§€ ë¡œë“œ ì‹œ)
    checkRecovery();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>8. ì¸ë„¤ì¼ ìƒì„±ê¸°</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Malgun Gothic", sans-serif;
      background: #f5f5f5;
      color: #333;
      min-height: 100vh;
    }
    .layout { display: flex; min-height: 100vh; padding-top: 0; }
    .sidebar {
      width: 300px;
      background: linear-gradient(180deg, #fafbff 0%, #f2f4f8 100%);
      border-right: 1px solid #e8ecf4;
      padding: 20px 16px 24px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 20px;
      height: 100vh;
      overflow-y: auto;
    }
    .sidebar-logo {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      font-weight: 700;
      font-size: 1.5rem;
      letter-spacing: 0.05em;
      color: #2d3748;
      margin-top: 8px;
      margin-bottom: 0;
      padding-left: 4px;
      text-align: left;
    }
    .sidebar-card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.04);
    }
    /* í˜„ì¬ í”„ë¡œì íŠ¸ */
    .project-label {
      font-size: 12px;
      color: #718096;
      margin-bottom: 6px;
    }
    .project-name-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 14px;
    }
    .project-name {
      font-size: 16px;
      font-weight: 700;
      color: #1a202c;
    }
    .project-name-edit {
      color: #718096;
      cursor: pointer;
      font-size: 14px;
    }
    .project-name-edit:hover {
      color: #3182ce;
    }
    /* í”„ë¡œì íŠ¸ ì•¡ì…˜ í•œ ì¤„ ë°°ì¹˜ */
    .project-actions-row {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }
    .sidebar-btn-inline {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .sidebar-btn-inline-primary {
      background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
      color: #fff;
    }
    .sidebar-btn-inline-primary:hover {
      background: linear-gradient(135deg, #6b46c1 0%, #553c9a 100%);
    }
    .sidebar-btn-inline-secondary {
      background: #fff;
      color: #2d3748;
      border: 1px solid #e2e8f0;
    }
    .sidebar-btn-inline-secondary:hover {
      background: #f7fafc;
      border-color: #cbd5e0;
    }
    .workflow-title {
      font-size: 13px;
      font-weight: 700;
      color: #4a5568;
      margin-bottom: 12px;
      padding: 0 4px;
    }
    .workflow-list { list-style: none; padding-right: 4px; }
    .workflow-item {
      display: block;
      padding: 12px 14px;
      margin-bottom: 6px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      color: #4a5568;
      background: #fff;
      border: 1px solid #e2e8f0;
      text-decoration: none;
      transition: background 0.2s, color 0.2s, border-color 0.2s;
    }
    .workflow-item:hover { background: #f7fafc; border-color: #cbd5e0; color: #2d3748; }
    .workflow-item.active {
      background: linear-gradient(135deg, #e9d8fd 0%, #e2e8f0 100%);
      border-color: #b794f4;
      color: #553c9a;
      font-weight: 600;
    }

    .main {
      flex: 1;
      padding: 24px 32px 40px;
      overflow-y: auto;
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      margin-top: 0;
      padding-top: 0;
    }
    .title-area { flex: 1; }
    .title-area h1 {
      font-size: 24px;
      font-weight: 700;
      color: #222;
      margin-bottom: 4px;
      margin-top: 0;
      line-height: 1.3;
    }
    .title-area .subtitle {
      font-size: 14px;
      color: #666;
      margin: 0;
      line-height: 1.4;
    }
    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }
    .login-inline-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .login-input {
      height: 32px;
      padding: 0 10px;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      font-size: 13px;
      box-sizing: border-box;
      transition: background-color 0.2s, border-color 0.2s;
      width: 140px;
    }
    .login-input::placeholder { color: #a0aec0; }
    .login-input:disabled {
      background-color: #E0E0E0;
      border-color: #999;
      color: #666;
      cursor: not-allowed;
      pointer-events: none;
    }
    .btn-admin, .btn-login {
      padding: 0 12px;
      height: 32px;
      background: #e0e0e0;
      color: #333;
      border: 1px solid #c0c0c0;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-admin:hover, .btn-login:hover { background: #d5d5d5; }

    .content-card {
      background: #fff;
      border: 1px solid #e8e8e8;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      margin-bottom: 20px;
    }
    .field-label {
      font-size: 14px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 8px;
    }
    .section-desc {
      font-size: 13px;
      color: #666;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    /* Rendering progress */
    .render-progress-card {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
    }
    .render-progress-bar {
      width: 100%;
      height: 14px;
      background: #e2e8f0;
      border-radius: 7px;
      overflow: hidden;
      margin-top: 8px;
    }
    .render-progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #38bdf8 0%, #6366f1 100%);
      transition: width 0.4s ease;
    }
    .render-progress-text {
      font-size: 12px;
      color: #0f172a;
      margin-top: 6px;
    }
    .render-progress-text strong {
      font-weight: 700;
    }

    /* Sidebar widget */
    .progress-widget {
      border: 1px solid #e2e8f0;
    }
    .progress-widget-title {
      font-size: 13px;
      font-weight: 700;
      color: #334155;
      margin-bottom: 8px;
    }
    .progress-widget-status {
      font-size: 12px;
      color: #64748b;
    }
    .progress-widget-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 6px;
    }
    .progress-widget-fill {
      height: 100%;
      width: 0%;
      background: #38bdf8;
      transition: width 0.4s ease;
    }

    /* Title Recap */
    .title-recap-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #cbd5e0;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      color: #2d3748;
      box-sizing: border-box;
    }

    /* Image Source Selection */
    .image-source-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .image-source-item {
      position: relative;
      aspect-ratio: 16/9;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
    }
    .image-source-item:hover {
      border-color: #805ad5;
      transform: scale(1.02);
    }
    .image-source-item.selected {
      border-color: #805ad5;
      box-shadow: 0 0 0 3px rgba(128, 90, 213, 0.2);
    }
    .image-source-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .image-source-item .source-label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: #fff;
      font-size: 11px;
      padding: 4px;
      text-align: center;
    }
    .btn-generate-new {
      padding: 8px 16px;
      background: #805ad5;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
    }
    .btn-generate-new:hover { background: #6b46c1; }

    /* Thumbnail Preview Canvas */
    .preview-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
      padding: 20px;
      background: #f7fafc;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }
    .preview-canvas-wrapper {
      position: relative;
      width: 100%;
      max-width: 800px;
      aspect-ratio: 16/9;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    #previewCanvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* AI Layout Button */
    .btn-ai-layout {
      padding: 10px 16px;
      background: #805ad5;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 16px;
    }
    .btn-ai-layout:hover { background: #6b46c1; }

    /* Custom Settings */
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .setting-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .setting-label {
      font-size: 12px;
      font-weight: 600;
      color: #4a5568;
    }
    .setting-select {
      padding: 8px 10px;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-size: 13px;
      background: #fff;
      cursor: pointer;
    }
    .switch-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .switch {
      position: relative;
      width: 44px;
      height: 24px;
      background: #cbd5e0;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .switch.active {
      background: #805ad5;
    }
    .switch-thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .switch.active .switch-thumb {
      transform: translateX(20px);
    }
    .switch-label {
      font-size: 12px;
      color: #4a5568;
    }

    .btn-primary {
      padding: 10px 16px;
      background: #e53935;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn-primary:hover { background: #c62828; }
    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .btn-secondary {
      padding: 10px 16px;
      background: #4a5568;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-left: 8px;
    }
    .btn-secondary:hover { background: #2d3748; }

    /* A/B í…ŒìŠ¤íŠ¸ í”„ë¦¬ë·° */
    .ab-preview-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
      margin-top: 20px;
    }
    .ab-preview-item {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .ab-preview-label {
      font-size: 14px;
      font-weight: 700;
      color: #2d3748;
      text-align: center;
      padding: 8px;
      background: #f7fafc;
      border-radius: 8px;
    }
    .ab-preview-canvas-wrapper {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    .ab-preview-canvas-wrapper canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    .ab-preview-text-editor {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .ab-text-input {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #cbd5e0;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    .ab-text-input:focus {
      outline: none;
      border-color: #805ad5;
      box-shadow: 0 0 0 3px rgba(128, 90, 213, 0.1);
    }
    .btn-regenerate-image {
      padding: 8px 16px;
      background: #4a5568;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-regenerate-image:hover {
      background: #2d3748;
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-logo">HANRA STUDIO</div>

      <!-- í˜„ì¬ í”„ë¡œì íŠ¸ -->
      <div class="sidebar-card">
        <div class="project-label">í˜„ì¬ í”„ë¡œì íŠ¸</div>
        <div class="project-name-row">
          <span class="project-name">ìƒˆë¡œìš´ í”„ë¡œì íŠ¸</span>
          <span class="project-name-edit" title="ì´ë¦„ ìˆ˜ì •">âœ</span>
        </div>
        <div class="project-actions-row">
          <button type="button" class="sidebar-btn-inline sidebar-btn-inline-primary" id="btnCreateProject">
            Pìƒì„±
          </button>
          <button type="button" class="sidebar-btn-inline sidebar-btn-inline-secondary" id="btnProjectList">
            Pëª©ë¡
          </button>
        </div>
      </div>

      <div class="sidebar-card">
        <div class="workflow-title">ì§„í–‰ ë‹¨ê³„</div>
        <ul class="workflow-list">
          <li><a href="ai-automation-project.html" class="workflow-item">1. ì£¼ì œ ì¶”ì²œ</a></li>
          <li><a href="step-2.html" class="workflow-item">2. AI ëŒ€ë³¸ ìƒì„±</a></li>
          <li><a href="step-3.html" class="workflow-item">3. ëŒ€ë³¸ ì§ì ‘ ì…ë ¥</a></li>
          <li><a href="step-4-1.html" class="workflow-item">4-1. JSON ìƒì„±</a></li>
          <li><a href="step-4-2.html" class="workflow-item">4-2. ì´ë¯¸ì§€ ìƒì„±</a></li>
          <li><a href="step-6.html" class="workflow-item">5. TTS ìƒì„±</a></li>
          <li><a href="step-5-2.html" class="workflow-item">5-2. BGM ì‚½ì…</a></li>
          <li><a href="step-7.html" class="workflow-item">6. ì˜ìƒ ë Œë”ë§</a></li>
          <li><a href="step-8.html" class="workflow-item">7. ì œëª©/ì„¤ëª… ì‘ì„±</a></li>
          <li><a href="step-9.html" class="workflow-item active">8. ì¸ë„¤ì¼ ìƒì„±ê¸°</a></li>
          <li><a href="step-10.html" class="workflow-item">9. ìµœì¢… ì œì‘</a></li>
          <li><a href="step-11.html" class="workflow-item">10. ì‡¼ì¸  ìë™ ë³€í™˜</a></li>
          <li><a href="step-12.html" class="workflow-item">11. ì±„ë„ ë§¤ë‹ˆì €</a></li>
          <li><a href="step-13.html" class="workflow-item">12. ì‘ì—… ë³´ê´€í•¨</a></li>
        </ul>
      </div>
      <div class="sidebar-card progress-widget" id="renderingWidget" style="display: none;">
        <div class="progress-widget-title">ì§„í–‰ ì¤‘ì¸ ì‘ì—…</div>
        <div class="progress-widget-status" id="renderingWidgetStatus">ëŒ€ê¸° ì¤‘</div>
        <div class="progress-widget-bar">
          <div class="progress-widget-fill" id="renderingWidgetFill"></div>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="header-row">
        <div class="title-area">
          <h1>8. ì¸ë„¤ì¼ ìƒì„±ê¸°</h1>
          <p class="subtitle">ìœ íŠœë¸Œ ìµœì í™” ì¸ë„¤ì¼ì„ ìƒì„±í•©ë‹ˆë‹¤</p>
        </div>
        <div class="header-right">
          <div class="login-inline-row">
            <input type="text" class="login-input" id="loginId" placeholder="ID" />
            <input type="password" class="login-input" id="loginPw" placeholder="Password" />
            <button type="button" class="btn-admin" id="btnAdmin">ê´€ë¦¬</button>
            <button type="button" class="btn-login" id="btnLogin">ë¡œê·¸ì˜¨</button>
          </div>
        </div>
      </div>

      <!-- ë Œë”ë§ ì§„í–‰ ìƒí™© -->
      <div class="content-card render-progress-card" id="renderProgressCard" style="display: none;">
        <div class="field-label">ë Œë”ë§ ì§„í–‰ ìƒí™©</div>
        <p class="section-desc">ì „ì²´ ì”¬ ê°œìˆ˜ ëŒ€ë¹„ í˜„ì¬ ë Œë”ë§ëœ ì”¬ ìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì§„í–‰ë¥ ì„ í‘œì‹œí•©ë‹ˆë‹¤.</p>
        <div class="render-progress-bar">
          <div class="render-progress-fill" id="renderProgressFill"></div>
        </div>
        <div class="render-progress-text" id="renderProgressText">ë Œë”ë§ ëŒ€ê¸° ì¤‘</div>
      </div>

      <!-- AI ì¸ë„¤ì¼ ìë™ ìƒì„± -->
      <div class="content-card">
        <div class="field-label">AI ì¸ë„¤ì¼ ìë™ ìƒì„±</div>
        <p class="section-desc">Step 1ì˜ í‚¤ì›Œë“œì™€ Step 3ì˜ ëŒ€ë³¸ ë¶„ìœ„ê¸°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸ë„¤ì¼ì„ ìë™ ìƒì„±í•©ë‹ˆë‹¤.</p>
        <button class="btn-primary" type="button" id="btnAutoGenerateThumbnail" style="width: 100%; margin-top: 12px;">
          ğŸ¨ AI ì¸ë„¤ì¼ ìë™ ìƒì„±í•˜ê¸° (A/B í…ŒìŠ¤íŠ¸ìš© 2ê°œ)
        </button>
      </div>

      <!-- A/B í…ŒìŠ¤íŠ¸ í”„ë¦¬ë·° -->
      <div class="content-card">
        <div class="field-label">A/B í…ŒìŠ¤íŠ¸ ì¸ë„¤ì¼ í”„ë¦¬ë·°</div>
        <p class="section-desc">ì˜µì…˜ A (ê°ì„±í˜•)ì™€ ì˜µì…˜ B (ì •ë³´í˜•) ë‘ ê°€ì§€ ë²„ì „ì„ ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        
        <div class="ab-preview-grid" id="abPreviewGrid">
          <!-- ì˜µì…˜ A -->
          <div class="ab-preview-item">
            <div class="ab-preview-label">ì˜µì…˜ A (ê°ì„±í˜•)</div>
            <div class="ab-preview-canvas-wrapper">
              <canvas id="previewCanvasA"></canvas>
            </div>
            <div class="ab-preview-text-editor">
              <input type="text" class="ab-text-input" id="hookTextA" placeholder="ë¯¸ë¼ ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
              <button class="btn-regenerate-image" type="button" onclick="regenerateImage('A')">ì´ë¯¸ì§€ ì¬ìƒì„±</button>
            </div>
          </div>
          
          <!-- ì˜µì…˜ B -->
          <div class="ab-preview-item">
            <div class="ab-preview-label">ì˜µì…˜ B (ì •ë³´í˜•)</div>
            <div class="ab-preview-canvas-wrapper">
              <canvas id="previewCanvasB"></canvas>
            </div>
            <div class="ab-preview-text-editor">
              <input type="text" class="ab-text-input" id="hookTextB" placeholder="ë¯¸ë¼ ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
              <button class="btn-regenerate-image" type="button" onclick="regenerateImage('B')">ì´ë¯¸ì§€ ì¬ìƒì„±</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ì œëª© ë¦¬ìº¡ (ê¸°ì¡´ ìœ ì§€, ìˆ¨ê¹€ ì²˜ë¦¬) -->
      <div class="content-card" style="display: none;">
        <div class="field-label">ì¸ë„¤ì¼ìš© ì œëª©</div>
        <p class="section-desc">7ë‹¨ê³„ì—ì„œ í™•ì •ëœ ì œëª©ì„ ì¸ë„¤ì¼ìš©ìœ¼ë¡œ ì§§ê²Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <input type="text" class="title-recap-input" id="thumbnailTitle" placeholder="ì¸ë„¤ì¼ìš© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”..." />
      </div>

      <!-- ì´ë¯¸ì§€ ì†ŒìŠ¤ ì„ íƒ (ê¸°ì¡´ ìœ ì§€, ìˆ¨ê¹€ ì²˜ë¦¬) -->
      <div class="content-card" style="display: none;">
        <div class="field-label">ì´ë¯¸ì§€ ì†ŒìŠ¤ ì„ íƒ</div>
        <p class="section-desc">4-2ë‹¨ê³„ì—ì„œ ìƒì„±ëœ ì´ë¯¸ì§€ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ê±°ë‚˜, ìƒˆë¡œìš´ ì¸ë„¤ì¼ ì „ìš© ì´ë¯¸ì§€ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <div class="image-source-grid" id="imageSourceGrid">
          <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
        </div>
        <button class="btn-generate-new" type="button" id="btnGenerateNewImage">ìƒˆ ì¸ë„¤ì¼ ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°</button>
      </div>

      <!-- í…ìŠ¤íŠ¸ ë ˆì´ì•„ì›ƒ ë° ìŠ¤íƒ€ì¼ ì„¤ì • -->
      <div class="content-card">
        <div class="field-label">í…ìŠ¤íŠ¸ ë ˆì´ì•„ì›ƒ ë° ìŠ¤íƒ€ì¼ ì„¤ì •</div>
        <p class="section-desc">AIê°€ ì œëª©ì˜ ì¤‘ìš”ë„ì— ë”°ë¼ í…ìŠ¤íŠ¸ì˜ í¬ê¸°, ìœ„ì¹˜, ê°•ì¡°ìƒ‰ì„ ìë™ìœ¼ë¡œ ë°°ì¹˜í•©ë‹ˆë‹¤.</p>
        
        <button class="btn-ai-layout" type="button" id="btnAiLayout">AI ì¸ë„¤ì¼ êµ¬ë„ ì¶”ì²œ</button>

        <!-- ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° -->
        <div class="preview-container">
          <div class="preview-canvas-wrapper">
            <canvas id="previewCanvas"></canvas>
          </div>
        </div>

        <!-- ì»¤ìŠ¤í…€ ì„¤ì • -->
        <div class="settings-grid">
          <div class="setting-item">
            <div class="setting-label">í°íŠ¸ ìŠ¤íƒ€ì¼</div>
            <select class="setting-select" id="fontStyle">
              <option value="bold">êµµì€ ê¸€ì”¨ (Bold) - ê¸°ë³¸</option>
              <option value="extra-bold">ì´ˆêµµì€ ê¸€ì”¨ (Extra Bold)</option>
              <option value="black">ë¸”ë™ (Black)</option>
            </select>
          </div>
          <div class="setting-item">
            <div class="setting-label">ê¸€ì í…Œë‘ë¦¬ (Stroke)</div>
            <div class="switch-row">
              <div class="switch" id="strokeSwitch" onclick="toggleSwitch(this)">
                <div class="switch-thumb"></div>
              </div>
              <span class="switch-label">í™œì„±í™”</span>
            </div>
          </div>
          <div class="setting-item">
            <div class="setting-label">ê·¸ë¦¼ì (Shadow)</div>
            <div class="switch-row">
              <div class="switch active" id="shadowSwitch" onclick="toggleSwitch(this)">
                <div class="switch-thumb"></div>
              </div>
              <span class="switch-label">í™œì„±í™”</span>
            </div>
          </div>
          <div class="setting-item">
            <div class="setting-label">ë°°ê²½ ë°•ìŠ¤</div>
            <div class="switch-row">
              <div class="switch" id="backgroundBoxSwitch" onclick="toggleSwitch(this)">
                <div class="switch-thumb"></div>
              </div>
              <span class="switch-label">í™œì„±í™”</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ìƒì„± ë° ë‹¤ìš´ë¡œë“œ -->
      <div class="content-card">
        <button class="btn-primary" type="button" id="btnGenerateThumbnail" style="display: none;">AI ì¸ë„¤ì¼ ì™„ì„±í•˜ê¸°</button>
        <button class="btn-secondary" type="button" id="btnDownload" style="display: none;">ë‹¤ìš´ë¡œë“œ</button>
      </div>

      <!-- í™•ì • ë° ë‹¤ìŒ ë‹¨ê³„ -->
      <div style="margin-top: 24px; display: flex; gap: 12px;">
        <button class="btn-primary" type="button" id="btnConfirmThumbnails" style="flex: 1; display: none;">
          âœ… ì´ëŒ€ë¡œ í™•ì • ë° ë‹¤ìŒ ë‹¨ê³„
        </button>
        <button class="btn-secondary" type="button" id="btnGoToStep9" style="flex: 1;">9. ìµœì¢… ì œì‘ ë‹¨ê³„ë¡œ ì´ë™</button>
      </div>
    </main>
  </div>

  <script>
    var thumbnailTitle = '';
    var selectedImageUrl = '';
    var imageSources = [];
    var canvas = null;
    var ctx = null;
    var thumbnailImage = null;
    var textLayout = {
      fontSize: 48,
      x: 40,
      y: 100,
      color: '#ffffff',
      strokeColor: '#000000',
      strokeWidth: 3,
      shadowBlur: 8,
      shadowColor: 'rgba(0,0,0,0.5)',
      hasBackgroundBox: false,
      backgroundBoxColor: 'rgba(0,0,0,0.6)'
    };

    // ë Œë”ë§ ì§„í–‰ë¥  ëª¨ë‹ˆí„°ë§
    function getActiveProjectId() {
      var projectId = localStorage.getItem('project_id')
        || localStorage.getItem('currentProjectId')
        || localStorage.getItem('projectId');
      if (!projectId) {
        try {
          var globalStateRaw = localStorage.getItem('globalState');
          if (globalStateRaw) {
            var globalState = JSON.parse(globalStateRaw);
            projectId = globalState.project_id || globalState.projectId;
          }
        } catch (e) {}
      }
      return projectId;
    }

    function updateRenderProgressUI(state) {
      var renderCard = document.getElementById('renderProgressCard');
      var renderFill = document.getElementById('renderProgressFill');
      var renderText = document.getElementById('renderProgressText');
      var widget = document.getElementById('renderingWidget');
      var widgetFill = document.getElementById('renderingWidgetFill');
      var widgetStatus = document.getElementById('renderingWidgetStatus');

      if (!renderCard || !renderFill || !renderText) return;

      if (!state || !state.show) {
        renderCard.style.display = 'none';
        if (widget) widget.style.display = 'none';
        return;
      }

      renderCard.style.display = 'block';
      if (widget) widget.style.display = 'block';

      renderFill.style.width = state.percent + '%';
      renderText.innerHTML = 'ë Œë”ë§ ì¤‘... <strong>' + state.completed + '/' + state.total + ' ì”¬</strong> ì™„ë£Œ (' + state.percent + '%)';

      if (widgetFill) widgetFill.style.width = state.percent + '%';
      if (widgetStatus) widgetStatus.textContent = 'ë Œë”ë§ ì¤‘... ' + state.completed + '/' + state.total + ' ì”¬';
    }

    async function pollRenderStatus() {
      var projectId = getActiveProjectId();
      if (!projectId) return;

      try {
        var response = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/auto-workflow/status/' + projectId);
        if (!response.ok) return;
        var status = await response.json();

        var resultData = status.result_data || {};
        var step8 = resultData.step8 || {};
        var totalScenes = step8.render_total_scenes
          || (resultData.step4 && resultData.step4.scenes ? resultData.step4.scenes.length : 0)
          || (resultData.step5 && resultData.step5.length ? resultData.step5.length : 0);

        if (status.status === 'processing' && status.current_step === 8 && totalScenes > 0) {
          var start = step8.render_started_at ? new Date(step8.render_started_at).getTime() : null;
          var end = step8.estimated_completion ? new Date(step8.estimated_completion).getTime() : null;
          var now = Date.now();
          var percent = 0;
          if (start && end && end > start) {
            percent = Math.min(100, Math.max(0, Math.round(((now - start) / (end - start)) * 100)));
          } else if (status.progress) {
            percent = Math.min(100, Math.max(0, status.progress));
          }
          var completed = Math.min(totalScenes, Math.round((percent / 100) * totalScenes));
          updateRenderProgressUI({
            show: true,
            percent: percent,
            completed: completed,
            total: totalScenes
          });
        } else if (status.status === 'completed') {
          updateRenderProgressUI({
            show: true,
            percent: 100,
            completed: totalScenes || 0,
            total: totalScenes || 0
          });

          // ì™„ë£Œ ì•Œë¦¼
          var notifiedKey = 'rendering_notified_' + projectId;
          if (!localStorage.getItem(notifiedKey)) {
            localStorage.setItem(notifiedKey, 'true');
            if ('Notification' in window) {
              if (Notification.permission === 'granted') {
                new Notification('HANRA STUDIO', {
                  body: '40ë¶„ ì˜ìƒ ì œì‘ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ìµœì¢… ê²€í† ë¥¼ ì‹œì‘í•˜ì„¸ìš”.',
                });
              } else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(function(permission) {
                  if (permission === 'granted') {
                    new Notification('HANRA STUDIO', {
                      body: '40ë¶„ ì˜ìƒ ì œì‘ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ìµœì¢… ê²€í† ë¥¼ ì‹œì‘í•˜ì„¸ìš”.',
                    });
                  }
                });
              }
            }
          }
        } else {
          updateRenderProgressUI({ show: false });
        }
      } catch (e) {
        console.warn('ë Œë”ë§ ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨:', e);
      }
    }

    // Step8 -> Step9 ë°ì´í„° ë¡œë“œ
    (function() {
      try {
        var titlePayloadRaw = localStorage.getItem('step8TitleData');
        var imagePayloadRaw = localStorage.getItem('step5ImageData');

        if (titlePayloadRaw) {
          var titleData = JSON.parse(titlePayloadRaw);
          thumbnailTitle = titleData.selectedTitle || '';
          document.getElementById('thumbnailTitle').value = thumbnailTitle;
        }

        if (imagePayloadRaw) {
          var imageData = JSON.parse(imagePayloadRaw);
          if (imageData.scenes && imageData.scenes.length) {
            imageSources = imageData.scenes.map(function(scene) {
              return {
                url: scene.image_url || scene.imageUrl,
                sceneNum: scene.scene_num || scene.sceneNum,
                label: 'ì”¬ ' + (scene.scene_num || scene.sceneNum)
              };
            }).filter(function(item) {
              return item.url;
            });
            renderImageSources();
          }
        }

        initCanvas();
      } catch (e) {
        console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
      }
    })();

    // ì´ë¯¸ì§€ ì†ŒìŠ¤ ë Œë”ë§
    function renderImageSources() {
      var container = document.getElementById('imageSourceGrid');
      if (!container) return;

      if (!imageSources.length) {
        container.innerHTML = '<div style="grid-column: 1/-1; padding: 20px; text-align: center; color: #999;">ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      container.innerHTML = imageSources
        .map(function(source, idx) {
          return (
            '<div class="image-source-item" data-index="' +
            idx +
            '" onclick="selectImageSource(' +
            idx +
            ')">' +
            '<img src="' +
            source.url +
            '" alt="' +
            source.label +
            '" />' +
            '<div class="source-label">' +
            source.label +
            '</div>' +
            '</div>'
          );
        })
        .join('');
    }

    // ì´ë¯¸ì§€ ì†ŒìŠ¤ ì„ íƒ
    function selectImageSource(index) {
      if (!imageSources[index]) return;
      selectedImageUrl = imageSources[index].url;

      document.querySelectorAll('.image-source-item').forEach(function(item) {
        item.classList.remove('selected');
      });
      var selectedItem = document.querySelector('[data-index="' + index + '"]');
      if (selectedItem) {
        selectedItem.classList.add('selected');
      }

      loadImageAndRender();
    }

    // ìƒˆ ì´ë¯¸ì§€ ìƒì„±
    (function() {
      var btnGen = document.getElementById('btnGenerateNewImage');
      if (btnGen) {
        btnGen.addEventListener('click', function() {
          var title = document.getElementById('thumbnailTitle').value.trim();
          if (!title) {
            alert('ì¸ë„¤ì¼ìš© ì œëª©ì„ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.');
            return;
          }

          generateThumbnailImage(title);
        });
      }
    })();

    // ì¸ë„¤ì¼ ì´ë¯¸ì§€ ìƒì„± (API í˜¸ì¶œ)
    async function generateThumbnailImage(title) {
      try {
        var response = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/generate-thumbnail-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: 'High-quality YouTube thumbnail image for: ' + title + '. Professional, eye-catching, 16:9 aspect ratio.',
            title: title
          })
        });

        if (!response.ok) {
          throw new Error('ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨');
        }

        var data = await response.json();
        if (data.image_url) {
          selectedImageUrl = data.image_url;
          loadImageAndRender();
          alert('ìƒˆ ì¸ë„¤ì¼ ì´ë¯¸ì§€ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      } catch (e) {
        console.error('ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:', e);
        alert('ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê¸°ì¡´ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
      }
    }

    // Canvas ì´ˆê¸°í™”
    function initCanvas() {
      canvas = document.getElementById('previewCanvas');
      if (!canvas) return;

      var wrapper = canvas.parentElement;
      var width = wrapper.clientWidth;
      var height = Math.floor(width * 9 / 16);

      canvas.width = width;
      canvas.height = height;
      ctx = canvas.getContext('2d');

      renderPreview();
    }

    // ì´ë¯¸ì§€ ë¡œë“œ ë° ë Œë”ë§
    function loadImageAndRender() {
      if (!selectedImageUrl) return;

      thumbnailImage = new Image();
      thumbnailImage.crossOrigin = 'anonymous';
      thumbnailImage.onload = function() {
        renderPreview();
      };
      thumbnailImage.onerror = function() {
        console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨');
      };
      thumbnailImage.src = selectedImageUrl;
    }

    // ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§
    function renderPreview() {
      if (!canvas || !ctx) return;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // ë°°ê²½ ì´ë¯¸ì§€
      if (thumbnailImage && thumbnailImage.complete) {
        ctx.drawImage(thumbnailImage, 0, 0, canvas.width, canvas.height);
      } else {
        ctx.fillStyle = '#e2e8f0';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#999';
        ctx.font = '16px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”', canvas.width / 2, canvas.height / 2);
      }

      // í…ìŠ¤íŠ¸ ë Œë”ë§
      var title = document.getElementById('thumbnailTitle').value.trim();
      if (title) {
        renderText(title);
      }
    }

    // í…ìŠ¤íŠ¸ ë Œë”ë§
    function renderText(text) {
      if (!ctx) return;

      var fontSize = textLayout.fontSize;
      var x = textLayout.x;
      var y = textLayout.y;
      var maxWidth = canvas.width - x * 2;

      ctx.save();

      // í°íŠ¸ ì„¤ì •
      var fontStyle = document.getElementById('fontStyle').value;
      var fontWeight = fontStyle === 'bold' ? 'bold' : fontStyle === 'extra-bold' ? '900' : '900';
      ctx.font = fontWeight + ' ' + fontSize + 'px sans-serif';
      ctx.textAlign = 'left';
      ctx.textBaseline = 'top';

      // ë°°ê²½ ë°•ìŠ¤
      if (textLayout.hasBackgroundBox) {
        var metrics = ctx.measureText(text);
        var textHeight = fontSize * 1.2;
        var padding = 16;
        ctx.fillStyle = textLayout.backgroundBoxColor;
        ctx.fillRect(
          x - padding,
          y - padding,
          Math.min(metrics.width, maxWidth) + padding * 2,
          textHeight + padding * 2
        );
      }

      // ê·¸ë¦¼ì
      if (document.getElementById('shadowSwitch').classList.contains('active')) {
        ctx.shadowBlur = textLayout.shadowBlur;
        ctx.shadowColor = textLayout.shadowColor;
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
      } else {
        ctx.shadowBlur = 0;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;
      }

      // í…ìŠ¤íŠ¸ ìƒ‰ìƒ
      ctx.fillStyle = textLayout.color;
      ctx.fillText(text, x, y, maxWidth);

      // í…Œë‘ë¦¬
      if (document.getElementById('strokeSwitch').classList.contains('active')) {
        ctx.strokeStyle = textLayout.strokeColor;
        ctx.lineWidth = textLayout.strokeWidth;
        ctx.strokeText(text, x, y, maxWidth);
      }

      ctx.restore();
    }

    // AI ë ˆì´ì•„ì›ƒ ì¶”ì²œ
    (function() {
      var btnAi = document.getElementById('btnAiLayout');
      if (btnAi) {
        btnAi.addEventListener('click', function() {
          var title = document.getElementById('thumbnailTitle').value.trim();
          if (!title) {
            alert('ì¸ë„¤ì¼ìš© ì œëª©ì„ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.');
            return;
          }
          if (!selectedImageUrl) {
            alert('ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.');
            return;
          }

          generateAiLayout(title);
        });
      }
    })();

    // AI ë ˆì´ì•„ì›ƒ ìƒì„±
    async function generateAiLayout(title) {
      try {
        var response = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/generate-thumbnail-layout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            image_url: selectedImageUrl,
            title: title,
            smart_overlap: true,
            instructions: 'AI should automatically detect persons or key subjects in the image and place text in areas that do not overlap with them. Use Smart Overlap technology to ensure text readability while maintaining visual balance.'
          })
        });

        if (!response.ok) {
          throw new Error('ë ˆì´ì•„ì›ƒ ìƒì„± ì‹¤íŒ¨');
        }

        var data = await response.json();
        if (data.layout) {
          textLayout = Object.assign(textLayout, data.layout);
          renderPreview();
          alert('AIê°€ ìµœì ì˜ ë ˆì´ì•„ì›ƒì„ ì¶”ì²œí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (e) {
        console.error('ë ˆì´ì•„ì›ƒ ìƒì„± ì‹¤íŒ¨:', e);
        // Fallback: ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ì ìš©
        applyDefaultLayout();
      }
    }

    // ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ì ìš©
    function applyDefaultLayout() {
      textLayout.fontSize = 48;
      textLayout.x = 40;
      textLayout.y = Math.floor(canvas.height * 0.6);
      textLayout.color = '#ffffff';
      renderPreview();
    }

    // ìŠ¤ìœ„ì¹˜ í† ê¸€
    function toggleSwitch(el) {
      el.classList.toggle('active');
      if (el.id === 'backgroundBoxSwitch') {
        textLayout.hasBackgroundBox = el.classList.contains('active');
      }
      renderPreview();
    }

    // ì œëª© ì…ë ¥ ì´ë²¤íŠ¸
    (function() {
      var titleInput = document.getElementById('thumbnailTitle');
      if (titleInput) {
        titleInput.addEventListener('input', function() {
          thumbnailTitle = this.value;
          renderPreview();
        });
      }
    })();

    // í°íŠ¸ ìŠ¤íƒ€ì¼ ë³€ê²½
    (function() {
      var fontSelect = document.getElementById('fontStyle');
      if (fontSelect) {
        fontSelect.addEventListener('change', function() {
          renderPreview();
        });
      }
    })();

    // ì¸ë„¤ì¼ ì™„ì„±í•˜ê¸°
    (function() {
      var btnGen = document.getElementById('btnGenerateThumbnail');
      if (btnGen) {
        btnGen.addEventListener('click', function() {
          var title = document.getElementById('thumbnailTitle').value.trim();
          if (!title) {
            alert('ì¸ë„¤ì¼ìš© ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
            return;
          }
          if (!selectedImageUrl) {
            alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
            return;
          }

          generateFinalThumbnail(title);
        });
      }
    })();

    // ìµœì¢… ì¸ë„¤ì¼ ìƒì„±
    async function generateFinalThumbnail(title) {
      try {
        var response = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/generate-final-thumbnail', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            image_url: selectedImageUrl,
            title: title,
            layout: textLayout,
            font_style: document.getElementById('fontStyle').value,
            has_stroke: document.getElementById('strokeSwitch').classList.contains('active'),
            has_shadow: document.getElementById('shadowSwitch').classList.contains('active'),
            has_background_box: textLayout.hasBackgroundBox,
            smart_overlap: true,
            instructions: 'AI should automatically detect persons or key subjects in the image and place text in areas that do not overlap with them. Use Smart Overlap technology to ensure text readability while maintaining visual balance. The final thumbnail should be optimized for YouTube with 16:9 aspect ratio.'
          })
        });

        if (!response.ok) {
          throw new Error('ì¸ë„¤ì¼ ìƒì„± ì‹¤íŒ¨');
        }

        var data = await response.json();
        if (data.thumbnail_url) {
          thumbnailImage = new Image();
          thumbnailImage.crossOrigin = 'anonymous';
          thumbnailImage.onload = function() {
            renderPreview();
            document.getElementById('btnDownload').style.display = 'inline-block';
            alert('ì¸ë„¤ì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
          };
          thumbnailImage.src = data.thumbnail_url;
          selectedImageUrl = data.thumbnail_url;
        }
      } catch (e) {
        console.error('ì¸ë„¤ì¼ ìƒì„± ì‹¤íŒ¨:', e);
        alert('ì¸ë„¤ì¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      }
    }

    // ë‹¤ìš´ë¡œë“œ
    (function() {
      var btnDownload = document.getElementById('btnDownload');
      if (btnDownload) {
        btnDownload.addEventListener('click', function() {
          if (!canvas) return;

          var link = document.createElement('a');
          link.download = 'thumbnail-' + Date.now() + '.png';
          link.href = canvas.toDataURL('image/png');
          link.click();
        });
      }
    })();

    // 9ë‹¨ê³„ë¡œ ì´ë™
    (function() {
      var btnNext = document.getElementById('btnGoToStep9');
      if (btnNext) {
        btnNext.addEventListener('click', function() {
          var title = document.getElementById('thumbnailTitle').value.trim();
          if (!title) {
            alert('ì¸ë„¤ì¼ìš© ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
            return;
          }
          if (!selectedImageUrl) {
            alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ìƒì„±í•´ ì£¼ì„¸ìš”.');
            return;
          }

          var payload = {
            thumbnailTitle: title,
            thumbnailImageUrl: selectedImageUrl,
            layout: textLayout
          };
          localStorage.setItem('step9ThumbnailData', JSON.stringify(payload));
          window.location.href = 'step-10.html';
        });
      }
    })();

    // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì²˜ë¦¬
    window.addEventListener('resize', function() {
      initCanvas();
      if (selectedImageUrl) {
        loadImageAndRender();
      }
    });

    // ë¡œê·¸ì˜¨ ì‹œìŠ¤í…œ
    var isLoggedIn = false;
    function checkLoginStatus() {
      var loginStatus = localStorage.getItem('isLoggedIn');
      var loginTime = localStorage.getItem('loginTime');
      if (loginStatus === 'true' && loginTime) {
        var loginDate = new Date(loginTime);
        var now = new Date();
        var hoursDiff = (now - loginDate) / (1000 * 60 * 60);
        if (hoursDiff < 24) {
          isLoggedIn = true;
          updateUIForLogin();
          return true;
        }
      }
      isLoggedIn = false;
      updateUIForLogout();
      return false;
    }
    function login() {
      var id = document.getElementById('loginId').value.trim();
      var pw = document.getElementById('loginPw').value.trim();
      if (!id || !pw) {
        alert('IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }
      var users = JSON.parse(localStorage.getItem('approvedUsers') || '[]');
      var user = users.find(function(u) {
        return u.id === id && u.password === pw;
      });
      if (user) {
        isLoggedIn = true;
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('loginTime', new Date().toISOString());
        localStorage.setItem('currentUserId', id);
        updateUIForLogin();
        alert('ë¡œê·¸ì˜¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
        document.getElementById('loginId').value = '';
        document.getElementById('loginPw').value = '';
      } else {
        alert('ìŠ¹ì¸ëœ IDì™€ ë¹„ë°€ë²ˆí˜¸ê°€ ì•„ë‹™ë‹ˆë‹¤.');
      }
    }
    function logout() {
      isLoggedIn = false;
      localStorage.removeItem('isLoggedIn');
      localStorage.removeItem('loginTime');
      localStorage.removeItem('currentUserId');
      updateUIForLogout();
    }
    function updateUIForLogin() {
      document.getElementById('btnLogin').textContent = 'ë¡œê·¸ì•„ì›ƒ';
      document.getElementById('btnLogin').onclick = function() {
        if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          logout();
          alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      };
      document.getElementById('loginId').disabled = true;
      document.getElementById('loginPw').disabled = true;
    }
    function updateUIForLogout() {
      document.getElementById('btnLogin').textContent = 'ë¡œê·¸ì˜¨';
      document.getElementById('btnLogin').onclick = login;
      document.getElementById('loginId').disabled = false;
      document.getElementById('loginPw').disabled = false;
    }
    document.getElementById('btnAdmin').onclick = function() {
      alert('ê´€ë¦¬ í˜ì´ì§€ëŠ” ë©”ì¸(index.html)ì—ì„œ ì´ìš©í•˜ì„¸ìš”.');
    };
    document.getElementById('btnLogin').onclick = login;
    checkLoginStatus();

    // í”„ë¡œì íŠ¸ ë²„íŠ¼ ê¶Œí•œ ì²´í¬ ë° ì´ë²¤íŠ¸
    (function() {
      function checkAdminPermission() {
        var loginStatus = localStorage.getItem('isLoggedIn');
        var loginTime = localStorage.getItem('loginTime');
        if (loginStatus === 'true' && loginTime) {
          var loginDate = new Date(loginTime);
          var now = new Date();
          var hoursDiff = (now - loginDate) / (1000 * 60 * 60);
          if (hoursDiff < 24) {
            var currentUserId = localStorage.getItem('currentUserId');
            var users = JSON.parse(localStorage.getItem('approvedUsers') || '[]');
            var user = users.find(function(u) { return u.id === currentUserId; });
            return user && user.isAdmin === true;
          }
        }
        return false;
      }
      
      function updateProjectButtonsVisibility() {
        var hasPermission = checkAdminPermission();
        var btnCreate = document.getElementById('btnCreateProject');
        var btnList = document.getElementById('btnProjectList');
        if (btnCreate) {
          btnCreate.style.display = hasPermission ? 'block' : 'none';
          btnCreate.disabled = !hasPermission;
        }
        if (btnList) {
          btnList.style.display = hasPermission ? 'block' : 'none';
          btnList.disabled = !hasPermission;
        }
      }
      
      var btnCreate = document.getElementById('btnCreateProject');
      var btnList = document.getElementById('btnProjectList');
      
      if (btnCreate) {
        btnCreate.onclick = function() {
          if (!checkAdminPermission()) {
            alert('ê´€ë¦¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ê´€ë¦¬ ê¶Œí•œì„ ë°›ì•„ì£¼ì„¸ìš”.');
            return;
          }
          alert('í”„ë¡œì íŠ¸ ìƒì„± ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
        };
      }
      
      if (btnList) {
        btnList.onclick = function() {
          if (!checkAdminPermission()) {
            alert('ê´€ë¦¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ê´€ë¦¬ ê¶Œí•œì„ ë°›ì•„ì£¼ì„¸ìš”.');
            return;
          }
          window.location.href = '/';
        };
      }
      
      updateProjectButtonsVisibility();
      setInterval(updateProjectButtonsVisibility, 5000);
    })();

    // A/B ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
    function initABCanvases() {
      // ìº”ë²„ìŠ¤ A ì´ˆê¸°í™”
      thumbnailA.canvas = document.getElementById('previewCanvasA');
      if (thumbnailA.canvas) {
        var wrapperA = thumbnailA.canvas.parentElement;
        var widthA = wrapperA.clientWidth;
        var heightA = Math.floor(widthA * 9 / 16);
        thumbnailA.canvas.width = widthA;
        thumbnailA.canvas.height = heightA;
        thumbnailA.ctx = thumbnailA.canvas.getContext('2d');
      }

      // ìº”ë²„ìŠ¤ B ì´ˆê¸°í™”
      thumbnailB.canvas = document.getElementById('previewCanvasB');
      if (thumbnailB.canvas) {
        var wrapperB = thumbnailB.canvas.parentElement;
        var widthB = wrapperB.clientWidth;
        var heightB = Math.floor(widthB * 9 / 16);
        thumbnailB.canvas.width = widthB;
        thumbnailB.canvas.height = heightB;
        thumbnailB.ctx = thumbnailB.canvas.getContext('2d');
      }
    }

    // ìë™ ìƒì„± ë²„íŠ¼ ì„¤ì •
    function setupAutoGenerateButton() {
      var btnAuto = document.getElementById('btnAutoGenerateThumbnail');
      if (btnAuto) {
        btnAuto.addEventListener('click', function() {
          generateABThumbnails();
        });
      }

      // í™•ì • ë²„íŠ¼ ì„¤ì •
      var btnConfirm = document.getElementById('btnConfirmThumbnails');
      if (btnConfirm) {
        btnConfirm.addEventListener('click', function() {
          confirmThumbnails();
        });
      }

      // í…ìŠ¤íŠ¸ ì…ë ¥ ì´ë²¤íŠ¸
      var hookTextA = document.getElementById('hookTextA');
      var hookTextB = document.getElementById('hookTextB');
      if (hookTextA) {
        hookTextA.addEventListener('input', function() {
          thumbnailA.hookText = this.value;
          renderThumbnail('A');
        });
      }
      if (hookTextB) {
        hookTextB.addEventListener('input', function() {
          thumbnailB.hookText = this.value;
          renderThumbnail('B');
        });
      }
    }

    // A/B ì¸ë„¤ì¼ ìë™ ìƒì„±
    async function generateABThumbnails() {
      try {
        // Step 1 í‚¤ì›Œë“œ ë° Step 3 ë°ì´í„° í™•ì¸
        if (!step1Data && !step3Data) {
          alert('Step 1 ë˜ëŠ” Step 3 ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í•´ë‹¹ ë‹¨ê³„ë¥¼ ì™„ë£Œí•´ ì£¼ì„¸ìš”.');
          return;
        }

        var keywords = step1Data ? step1Data.keywords : [];
        var topic = step1Data ? step1Data.topic : (blueprintData ? blueprintData.title : '');
        var script = step3Data ? (step3Data.script || '') : '';
        var tone = step3Data ? (step3Data.tone || 'senior-expert') : 'senior-expert';

        // ë¡œë”© í‘œì‹œ
        var btnAuto = document.getElementById('btnAutoGenerateThumbnail');
        if (btnAuto) {
          btnAuto.disabled = true;
          btnAuto.textContent = 'ìƒì„± ì¤‘...';
        }

        // 1. AI ë¯¸ë¼ ë¬¸êµ¬ ì¶”ì¶œ (2ê°€ì§€ ë²„ì „)
        var hookTexts = await extractHookTexts(script, topic);
        thumbnailA.hookText = hookTexts[0] || 'ê±·ê¸°, ê·¸ëƒ¥ í•˜ë©´ ë…?!';
        thumbnailB.hookText = hookTexts[1] || 'ë”± 30ë¶„! ê¸°ì ì˜ ë³€í™”';

        // 2. AI ë°°ê²½ ì´ë¯¸ì§€ ìƒì„± (A/B ê°ê°)
        var imagePromptA = buildImagePrompt(keywords, topic, tone, 'emotional');
        var imagePromptB = buildImagePrompt(keywords, topic, tone, 'informative');

        thumbnailA.imageUrl = await generateThumbnailImage(imagePromptA, 'A');
        thumbnailB.imageUrl = await generateThumbnailImage(imagePromptB, 'B');

        // 3. ì´ë¯¸ì§€ ë¡œë“œ ë° í…ìŠ¤íŠ¸ í•©ì„±
        await loadAndComposeThumbnail('A');
        await loadAndComposeThumbnail('B');

        // UI ì—…ë°ì´íŠ¸
        document.getElementById('hookTextA').value = thumbnailA.hookText;
        document.getElementById('hookTextB').value = thumbnailB.hookText;
        document.getElementById('btnConfirmThumbnails').style.display = 'block';

        if (btnAuto) {
          btnAuto.disabled = false;
          btnAuto.textContent = 'ğŸ¨ AI ì¸ë„¤ì¼ ìë™ ìƒì„±í•˜ê¸° (A/B í…ŒìŠ¤íŠ¸ìš© 2ê°œ)';
        }

        alert('A/B í…ŒìŠ¤íŠ¸ìš© ì¸ë„¤ì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
      } catch (e) {
        console.error('ì¸ë„¤ì¼ ìƒì„± ì‹¤íŒ¨:', e);
        alert('ì¸ë„¤ì¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
        var btnAuto = document.getElementById('btnAutoGenerateThumbnail');
        if (btnAuto) {
          btnAuto.disabled = false;
          btnAuto.textContent = 'ğŸ¨ AI ì¸ë„¤ì¼ ìë™ ìƒì„±í•˜ê¸° (A/B í…ŒìŠ¤íŠ¸ìš© 2ê°œ)';
        }
      }
    }

    // AI ë¯¸ë¼ ë¬¸êµ¬ ì¶”ì¶œ
    async function extractHookTexts(script, topic) {
      try {
        var response = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/extract-hook-texts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            script: script,
            topic: topic,
            count: 2, // 2ê°€ì§€ ë²„ì „
            maxLength: 15 // 15ì ì´ë‚´
          })
        });

        if (response.ok) {
          var data = await response.json();
          return data.hookTexts || [];
        }
      } catch (e) {
        console.error('ë¯¸ë¼ ë¬¸êµ¬ ì¶”ì¶œ ì‹¤íŒ¨:', e);
      }

      // Fallback: ê¸°ë³¸ ë¬¸êµ¬ ìƒì„±
      return [
        topic + ', ê·¸ëƒ¥ í•˜ë©´ ë…?!',
        'ë”± 30ë¶„! ê¸°ì ì˜ ë³€í™”'
      ];
    }

    // ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ìƒì„±
    function buildImagePrompt(keywords, topic, tone, style) {
      var prompt = 'High-quality YouTube thumbnail image, bright and eye-catching, 16:9 aspect ratio, 8k resolution, clean background without text, ';
      
      // ì£¼ì œ ë°˜ì˜
      if (topic) {
        prompt += 'main subject: ' + topic + ' in a positive and healthy way, ';
      }
      
      // í‚¤ì›Œë“œ ë°˜ì˜
      if (keywords && keywords.length > 0) {
        prompt += 'keywords: ' + keywords.join(', ') + ', ';
      }
      
      // í†¤ì•¤ë§¤ë„ˆ ë°˜ì˜
      var toneStyle = '';
      if (tone === 'senior-expert' || tone === 'professional-analyst') {
        toneStyle = 'professional, trustworthy, reliable composition and color scheme';
      } else if (tone === 'friendly-neighbor' || tone === 'grandchild-friendly') {
        toneStyle = 'warm, friendly, approachable composition and color scheme';
      } else if (tone === 'emotional-storyteller') {
        toneStyle = 'emotional, touching, heartwarming composition and color scheme';
      } else {
        toneStyle = 'professional and trustworthy composition and color scheme';
      }
      
      // ìŠ¤íƒ€ì¼ ë°˜ì˜ (A/B)
      if (style === 'emotional') {
        prompt += 'emotional and touching atmosphere, warm colors, ' + toneStyle;
      } else {
        prompt += 'informative and clear atmosphere, professional colors, ' + toneStyle;
      }
      
      return prompt;
    }

    // ì¸ë„¤ì¼ ì´ë¯¸ì§€ ìƒì„±
    async function generateThumbnailImage(prompt, version) {
      try {
        var response = await fetch((window.__API_BASE__ || 'http://localhost:4000') + '/api/generate-thumbnail-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: prompt,
            version: version
          })
        });

        if (!response.ok) {
          throw new Error('ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨');
        }

        var data = await response.json();
        return data.image_url || '';
      } catch (e) {
        console.error('ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:', e);
        // Fallback: í”Œë ˆì´ìŠ¤í™€ë” ì´ë¯¸ì§€
        return '';
      }
    }

    // ì´ë¯¸ì§€ ë¡œë“œ ë° í…ìŠ¤íŠ¸ í•©ì„±
    async function loadAndComposeThumbnail(version) {
      var thumb = version === 'A' ? thumbnailA : thumbnailB;
      if (!thumb.imageUrl || !thumb.canvas || !thumb.ctx) return;

      return new Promise(function(resolve, reject) {
        var img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = function() {
          thumb.image = img;
          renderThumbnail(version);
          resolve();
        };
        img.onerror = function() {
          console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', thumb.imageUrl);
          reject();
        };
        img.src = thumb.imageUrl;
      });
    }

    // ì¸ë„¤ì¼ ë Œë”ë§ (ì‹œë‹ˆì–´ ë§ì¶¤í˜• í…ìŠ¤íŠ¸ í•©ì„±)
    function renderThumbnail(version) {
      var thumb = version === 'A' ? thumbnailA : thumbnailB;
      if (!thumb.canvas || !thumb.ctx) return;

      var ctx = thumb.ctx;
      var canvas = thumb.canvas;
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // ë°°ê²½ ì´ë¯¸ì§€
      if (thumb.image && thumb.image.complete) {
        ctx.drawImage(thumb.image, 0, 0, canvas.width, canvas.height);
      } else {
        ctx.fillStyle = '#e2e8f0';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      // í…ìŠ¤íŠ¸ ë Œë”ë§
      if (thumb.hookText) {
        renderSeniorFriendlyText(ctx, canvas, thumb.hookText, thumb.image);
      }
    }

    // ì‹œë‹ˆì–´ ë§ì¶¤í˜• í…ìŠ¤íŠ¸ ë Œë”ë§
    function renderSeniorFriendlyText(ctx, canvas, text, bgImage) {
      ctx.save();

      // ë°°ê²½ ë°ê¸° ê°ì§€ (ê°„ë‹¨í•œ ì¶”ì •)
      var isDarkBackground = true; // ê¸°ë³¸ê°’: ì–´ë‘ìš´ ë°°ê²½
      if (bgImage && bgImage.complete) {
        // ì´ë¯¸ì§€ ì¤‘ì•™ ìƒ˜í”Œë§ìœ¼ë¡œ ë°ê¸° ì¶”ì •
        var sampleX = Math.floor(canvas.width * 0.5);
        var sampleY = Math.floor(canvas.height * 0.5);
        var imageData = ctx.getImageData(sampleX, sampleY, 1, 1);
        var r = imageData.data[0];
        var g = imageData.data[1];
        var b = imageData.data[2];
        var brightness = (r + g + b) / 3;
        isDarkBackground = brightness < 128;
      }

      // ì‹œë‹ˆì–´ ë§ì¶¤í˜• ìŠ¤íƒ€ì¼
      var fontSize = Math.floor(canvas.width * 0.08); // í™”ë©´ ë„ˆë¹„ì˜ 8%
      var fontFamily = 'Impact, "ê²©ë™ê³ ë”•", "Malgun Gothic", sans-serif';
      var fontWeight = '900'; // ë§¤ìš° ë‘êº¼ìš´
      
      // ìƒ‰ìƒ ê²°ì •
      var textColor = isDarkBackground ? '#ffffff' : '#fbbf24'; // ì–´ë‘ìš´ ë°°ê²½: í°ìƒ‰, ë°ì€ ë°°ê²½: ë…¸ë€ìƒ‰
      var strokeColor = '#000000'; // ê²€ì€ìƒ‰ í…Œë‘ë¦¬
      var strokeWidth = Math.max(4, fontSize * 0.08); // í°íŠ¸ í¬ê¸°ì˜ 8%

      // í°íŠ¸ ì„¤ì •
      ctx.font = fontWeight + ' ' + fontSize + 'px ' + fontFamily;
      ctx.textAlign = 'left';
      ctx.textBaseline = 'top';

      // í…ìŠ¤íŠ¸ ìœ„ì¹˜ (ì¢Œì¸¡ ìƒë‹¨ ë˜ëŠ” ì¤‘ì•™, ìš°ì¸¡ í•˜ë‹¨ ë¹„ì›Œë‘ )
      var x = Math.floor(canvas.width * 0.05); // ì¢Œì¸¡ 5%
      var y = Math.floor(canvas.height * 0.15); // ìƒë‹¨ 15%
      var maxWidth = Math.floor(canvas.width * 0.6); // ìµœëŒ€ ë„ˆë¹„ 60% (ìš°ì¸¡ í•˜ë‹¨ ë¹„ì›Œë‘ )

      // í…ìŠ¤íŠ¸ ì¸¡ì •
      var metrics = ctx.measureText(text);
      var textHeight = fontSize * 1.2;

      // ë°°ê²½ ë°•ìŠ¤ (ì„ íƒì )
      var padding = Math.floor(fontSize * 0.3);
      ctx.fillStyle = 'rgba(0,0,0,0.6)';
      ctx.fillRect(
        x - padding,
        y - padding,
        Math.min(metrics.width, maxWidth) + padding * 2,
        textHeight + padding * 2
      );

      // ê·¸ë¦¼ì
      ctx.shadowBlur = 10;
      ctx.shadowColor = 'rgba(0,0,0,0.8)';
      ctx.shadowOffsetX = 3;
      ctx.shadowOffsetY = 3;

      // í…ìŠ¤íŠ¸ í…Œë‘ë¦¬ (ê²€ì€ìƒ‰)
      ctx.strokeStyle = strokeColor;
      ctx.lineWidth = strokeWidth;
      ctx.lineJoin = 'round';
      ctx.miterLimit = 2;
      ctx.strokeText(text, x, y, maxWidth);

      // í…ìŠ¤íŠ¸ ì±„ìš°ê¸°
      ctx.fillStyle = textColor;
      ctx.fillText(text, x, y, maxWidth);

      ctx.restore();
    }

    // ì´ë¯¸ì§€ ì¬ìƒì„±
    async function regenerateImage(version) {
      if (!step1Data && !step3Data) {
        alert('Step 1 ë˜ëŠ” Step 3 ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      var keywords = step1Data ? step1Data.keywords : [];
      var topic = step1Data ? step1Data.topic : (blueprintData ? blueprintData.title : '');
      var tone = step3Data ? (step3Data.tone || 'senior-expert') : 'senior-expert';
      var style = version === 'A' ? 'emotional' : 'informative';

      var prompt = buildImagePrompt(keywords, topic, tone, style);
      var thumb = version === 'A' ? thumbnailA : thumbnailB;

      thumb.imageUrl = await generateThumbnailImage(prompt, version);
      await loadAndComposeThumbnail(version);
    }

    // ì¸ë„¤ì¼ í™•ì •
    function confirmThumbnails() {
      if (!thumbnailA.imageUrl || !thumbnailB.imageUrl) {
        alert('A/B ì¸ë„¤ì¼ì„ ëª¨ë‘ ìƒì„±í•´ ì£¼ì„¸ìš”.');
        return;
      }

      // A/B í…ŒìŠ¤íŠ¸ ë°ì´í„° ì €ì¥
      var abTestData = {
        thumbnailA: {
          imageUrl: thumbnailA.imageUrl,
          hookText: thumbnailA.hookText,
          style: thumbnailA.style
        },
        thumbnailB: {
          imageUrl: thumbnailB.imageUrl,
          hookText: thumbnailB.hookText,
          style: thumbnailB.style
        },
        createdAt: new Date().toISOString()
      };

      localStorage.setItem('abTestData', JSON.stringify(abTestData));

      // Step 9 ë°ì´í„° ì €ì¥
      var thumbnailData = {
        thumbnailImageUrl: thumbnailA.imageUrl, // ê¸°ë³¸ê°’ìœ¼ë¡œ A ì‚¬ìš©
        thumbnailBImageUrl: thumbnailB.imageUrl,
        hookText: thumbnailA.hookText,
        abTestData: abTestData
      };

      localStorage.setItem('step9ThumbnailData', JSON.stringify(thumbnailData));

      alert('ì¸ë„¤ì¼ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
      window.location.href = 'step-10.html';
    }

    // ë Œë”ë§ ì§„í–‰ë¥  ëª¨ë‹ˆí„°ë§ ì‹œì‘
    (function initRenderMonitoring() {
      pollRenderStatus();
      setInterval(pollRenderStatus, 10000);
    })();
  </script>
</body>
</html>
